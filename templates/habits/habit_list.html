{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Habits{% endblock %}

{% block dashboard_css %}
{% include 'habits/partials/_habits_css.html' %}
{% endblock dashboard_css %}

{% block dashboard_content %}
<div class="habits-container px-4 py-4">
    <div class="habits-main">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">
                    <i class="bi bi-repeat text-primary me-2"></i>My Habits
                </h1>
                <p class="text-muted mb-0">Build consistency, one day at a time</p>
            </div>
            <a href="{% url 'habits:habit_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i>New Habit
            </a>
        </div>

        <!-- Stats Row -->
        <div class="habits-stats-row">
            <div class="habits-stat-card">
                <div class="stat-value">{{ stats.total }}</div>
                <div class="stat-label">Active Habits</div>
            </div>
            <div class="habits-stat-card due">
                <div class="stat-value">{{ stats.due_today }}</div>
                <div class="stat-label">Due Today</div>
            </div>
            <div class="habits-stat-card completed">
                <div class="stat-value">{{ stats.completed_today }}</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="habits-stat-card rate">
                <div class="stat-value">{{ stats.completion_rate|floatformat:0 }}%</div>
                <div class="stat-label">Today's Rate</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="d-flex gap-2 mb-4 flex-wrap">
            <select id="categoryFilter" class="form-select" style="max-width: 180px;"
                    onchange="filterByCategory(this.value)">
                <option value="">All Categories</option>
                {% for value, label in category_choices %}
                <option value="{{ value }}" {% if current_category == value %}selected{% endif %}>
                    {{ label }}
                </option>
                {% endfor %}
            </select>
            <div class="form-check form-switch ms-2 d-flex align-items-center">
                <input class="form-check-input" type="checkbox" id="showArchived"
                       {% if show_archived %}checked{% endif %}
                       onchange="toggleArchived(this.checked)">
                <label class="form-check-label ms-2" for="showArchived">Show archived</label>
            </div>
        </div>

        <!-- Today's Habits Section -->
        {% if habits_with_status %}
        <h2 class="h5 mb-3">
            <i class="bi bi-calendar-check me-2"></i>Today - {{ today|date:"l, M d" }}
        </h2>

        <div class="habits-grid">
            {% for item in habits_with_status %}
            <div class="habit-card {% if item.completed_today %}completed{% endif %}"
                 data-habit-id="{{ item.habit.pk }}">
                <!-- Habit Icon -->
                <div class="habit-icon" style="background: {{ item.habit.color }}">
                    <i class="{{ item.habit.icon }}"></i>
                </div>

                <!-- Habit Info -->
                <div class="habit-info">
                    <a href="{% url 'habits:habit_detail' pk=item.habit.pk %}" class="habit-name">
                        {{ item.habit.name }}
                    </a>
                    <div class="habit-meta">
                        <span class="habit-meta-item">
                            <i class="{{ item.habit.category_icon }}"></i>
                            {{ item.habit.get_category_display }}
                        </span>
                        <span class="habit-meta-item">
                            <i class="bi bi-clock"></i>
                            {{ item.habit.frequency_display }}
                        </span>
                    </div>
                </div>

                <!-- Streak -->
                {% if item.habit.current_streak > 0 %}
                <span class="streak-badge {% if item.habit.current_streak >= 7 %}fire{% endif %}">
                    <i class="bi bi-fire"></i>
                    {{ item.habit.current_streak }} day{% if item.habit.current_streak != 1 %}s{% endif %}
                </span>
                {% endif %}

                <!-- Completion Rate -->
                <div class="completion-rate" title="{{ item.completion_rate|floatformat:0 }}% completion rate (30 days)">
                    <svg class="completion-rate-circle" width="50" height="50" viewBox="0 0 50 50">
                        <circle class="completion-rate-bg" cx="25" cy="25" r="20"/>
                        <circle class="completion-rate-fill" cx="25" cy="25" r="20"
                                stroke-dasharray="125.6"
                                stroke-dashoffset="{{ 125.6|add:item.completion_rate|floatformat:0|add:'-125.6' }}"/>
                    </svg>
                    <span class="completion-rate-text">{{ item.completion_rate|floatformat:0 }}%</span>
                </div>

                <!-- Check-in Button -->
                <button class="checkin-btn {% if item.completed_today %}completed{% endif %} {% if not item.is_due_today %}not-due{% endif %}"
                        onclick="toggleCheckin({{ item.habit.pk }})"
                        title="{% if item.is_due_today %}{% if item.completed_today %}Mark as incomplete{% else %}Mark as complete{% endif %}{% else %}Not due today{% endif %}">
                    <i class="bi {% if item.completed_today %}bi-check-lg{% else %}bi-check{% endif %}"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <i class="bi bi-repeat d-block"></i>
            <h4>No habits yet</h4>
            <p class="text-muted">Start building positive habits today</p>
            <a href="{% url 'habits:habit_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i>Create Your First Habit
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock dashboard_content %}

{% block dashboard_js %}
<script>
function toggleCheckin(habitId) {
    fetch(`/habits/${habitId}/checkin/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function filterByCategory(category) {
    const params = new URLSearchParams(window.location.search);
    if (category) {
        params.set('category', category);
    } else {
        params.delete('category');
    }
    window.location.search = params.toString();
}

function toggleArchived(show) {
    const params = new URLSearchParams(window.location.search);
    if (show) {
        params.set('archived', '1');
    } else {
        params.delete('archived');
    }
    window.location.search = params.toString();
}

// Fix SVG stroke-dashoffset calculation
document.querySelectorAll('.completion-rate-fill').forEach(circle => {
    const text = circle.parentElement.nextElementSibling.textContent;
    const rate = parseInt(text) || 0;
    const circumference = 125.6;
    const offset = circumference - (rate / 100 * circumference);
    circle.style.strokeDashoffset = offset;
});
</script>
{% endblock dashboard_js %}
