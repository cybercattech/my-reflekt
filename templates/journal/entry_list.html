{% extends 'base.html' %}
{% load humanize %}

{% block title %}My Journal{% endblock %}

{% block extra_css %}
{% include 'journal/partials/sidebar_css.html' %}
<style>
    /* 3-Column Layout */
    .journal-layout {
        display: flex;
        min-height: calc(100vh - 56px - 80px); /* Navbar + footer */
        position: relative;
    }

    /* Main Content Area */
    .main-content-area {
        flex: 1;
        padding: 1.5rem 2rem;
        overflow-y: auto;
        background: #f9fafb;
    }

    /* Entry Cards */
    .entry-card {
        border: none;
        border-radius: 12px;
        margin-bottom: 0.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        transition: all 0.2s;
        background: white;
    }

    .entry-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
    }

    .entry-card-inner {
        border: none;
        border-bottom: 1px solid #f3f4f6;
        padding: 1rem 1.25rem;
        transition: background 0.2s;
    }

    .entry-card-inner:last-child {
        border-bottom: none;
    }

    .entry-card-inner:hover {
        background: #f9fafb;
    }

    /* Entry row with delete button */
    .entry-row .delete-entry-btn {
        opacity: 0;
        transition: opacity 0.2s;
    }

    .entry-row:hover .delete-entry-btn {
        opacity: 1;
    }

    .entry-link {
        display: block;
    }

    .entry-link:hover {
        text-decoration: none;
    }

    .mood-emoji {
        font-size: 1.5rem;
    }

    /* Delete Confirmation Modal */
    .delete-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .delete-modal-overlay.active {
        display: flex;
    }

    .delete-modal {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.2s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .delete-modal-icon {
        width: 60px;
        height: 60px;
        background: #fee2e2;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
    }

    .delete-modal-icon i {
        font-size: 1.5rem;
        color: #dc2626;
    }

    .delete-modal h5 {
        text-align: center;
        margin-bottom: 0.5rem;
    }

    .delete-modal p {
        text-align: center;
        color: #6b7280;
        margin-bottom: 1.5rem;
    }

    .delete-modal-actions {
        display: flex;
        gap: 0.75rem;
    }

    .delete-modal-actions button {
        flex: 1;
        padding: 0.75rem;
        border-radius: 8px;
        font-weight: 500;
    }

    /* On This Day Section */
    .on-this-day-section .card {
        overflow: hidden;
    }

    .bg-gradient-purple {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    }

    .year-badge {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        font-weight: 700;
        font-size: 0.85rem;
        padding: 0.4rem 0.75rem;
        border-radius: 8px;
        min-width: 60px;
        text-align: center;
    }

    .on-this-day-section .list-group-item {
        border-left: none;
        border-right: none;
        transition: background 0.2s;
    }

    .on-this-day-section .list-group-item:first-child {
        border-top: none;
    }

    .on-this-day-section .list-group-item:last-child {
        border-bottom: none;
    }

    .on-this-day-section .list-group-item:hover {
        background: #f9fafb;
    }

    .on-this-day-section .list-group-item:hover .year-badge {
        transform: scale(1.05);
        transition: transform 0.2s;
    }

    /* Date filter badge */
    .date-filter-badge {
        display: inline-flex;
        align-items: center;
        background: #ede9fe;
        color: #5b21b6;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        margin-bottom: 1rem;
    }

    .date-filter-badge .clear-filter {
        margin-left: 0.5rem;
        color: #7c3aed;
        text-decoration: none;
        font-weight: 600;
    }

    /* Collapse icon */
    .collapse-icon {
        transition: transform 0.2s ease;
    }

    [aria-expanded="false"] .collapse-icon {
        transform: rotate(-90deg);
    }

    /* Page-specific responsive additions */
    @media (max-width: 1200px) {
        .insights-sidebar-right.show-mobile .insights-content {
            display: block;
            position: absolute;
            right: 48px;
            top: 0;
            width: 280px;
            height: 100%;
            background: white;
            box-shadow: -4px 0 12px rgba(0,0,0,0.1);
        }
    }

    @media (max-width: 768px) {
        .journal-layout {
            flex-direction: column;
        }
        .main-content-area {
            padding: 1rem;
        }
    }

    /* Year-over-Year Overview */
    .year-overview-section .year-stat-card {
        background: #fafafa;
        transition: all 0.2s;
    }

    .year-overview-section .year-stat-card:hover {
        background: #f3f4f6;
    }

    .year-overview-section .year-stat-card.border-primary {
        background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
    }

    .year-badge-large {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
        padding: 0.6rem 1rem;
        border-radius: 10px;
        min-width: 70px;
        text-align: center;
    }

    .year-overview-section .mood-bar div {
        transition: width 0.3s ease;
    }

    .year-overview-section .badge {
        font-weight: 500;
    }

    /* Streak Badges */
    .streak-badge {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        background: #fef3c7;
        font-size: 0.9rem;
    }

    .streak-badge.current-streak {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }

    .streak-badge.best-streak {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    }

    .streak-badge i {
        font-size: 1.1rem;
    }

    .streak-badge .streak-count {
        font-weight: 700;
        font-size: 1rem;
    }

    .streak-badge .streak-label {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .streak-mini {
        display: flex;
        align-items: center;
        gap: 0.2rem;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        background: #fef3c7;
        font-size: 0.8rem;
        font-weight: 600;
        color: #d97706;
    }

    .streak-mini i {
        font-size: 0.9rem;
    }

    .text-orange {
        color: #f97316 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="journal-layout">
    <!-- Left Calendar Sidebar -->
    {% include 'journal/partials/calendar_sidebar.html' %}

    <!-- Main Content Area -->
    <div class="main-content-area">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0"><i class="bi bi-book me-2"></i>My Journal</h1>
            <a href="{% url 'journal:entry_create' %}" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;" title="New Entry">
                <i class="bi bi-plus-lg" style="font-size: 1.5rem;"></i>
            </a>
        </div>

        <!-- Daily Devotion -->
        {% if daily_devotion %}
        <div class="card mb-4 border-primary shadow-sm">
            <div class="card-header bg-primary bg-opacity-10 border-primary d-flex justify-content-between align-items-center">
                <span><i class="bi bi-book me-2"></i>Today's Devotion</span>
                <span class="badge bg-primary">{{ daily_devotion.theme }}</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="text-primary mb-2">{{ daily_devotion.reference }}</h6>
                        <p class="fst-italic mb-2 small">"{{ daily_devotion.verse }}"</p>
                        <p class="small mb-0 text-muted">{{ daily_devotion.reflection|truncatewords:30 }}</p>
                    </div>
                    <div class="col-md-4 d-flex align-items-center justify-content-end">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#devotionModal">
                            <i class="bi bi-plus-circle me-1"></i>Add to Today's Entry
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Search and Filter -->
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-body py-2">
                <form method="get" class="row g-2 align-items-center">
                    <input type="hidden" name="year" value="{{ cal_year }}">
                    <input type="hidden" name="month" value="{{ cal_month }}">

                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                            <input type="text" name="q" class="form-control" placeholder="Search entries..."
                                   value="{{ query }}">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select name="mood" class="form-select form-select-sm">
                            <option value="">All moods</option>
                            <option value="ecstatic" {% if mood == 'ecstatic' %}selected{% endif %}>ü§© Ecstatic</option>
                            <option value="happy" {% if mood == 'happy' %}selected{% endif %}>üòä Happy</option>
                            <option value="neutral" {% if mood == 'neutral' %}selected{% endif %}>üòê Neutral</option>
                            <option value="sad" {% if mood == 'sad' %}selected{% endif %}>üò¢ Sad</option>
                            <option value="angry" {% if mood == 'angry' %}selected{% endif %}>üò† Angry</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-secondary btn-sm w-100">Filter</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Unanalyzed Entries Banner -->
        {% if unanalyzed_count > 0 %}
        <div class="alert alert-info alert-dismissible fade show d-flex align-items-center justify-content-between" role="alert" id="unanalyzedBanner">
            <div>
                <i class="bi bi-cpu me-2"></i>
                <strong>{{ unanalyzed_count }}</strong> entr{{ unanalyzed_count|pluralize:"y,ies" }} waiting for analysis.
                <span class="text-muted">Analysis extracts mood, themes, and keywords.</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-info btn-sm" id="analyzeEntriesBtn" onclick="analyzeAllEntries()">
                    <i class="bi bi-play-fill me-1"></i>Analyze Now
                </button>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
        <div id="analysisProgress" class="mb-3" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <small class="text-muted" id="analysisText">Analyzing entries...</small>
                <small class="text-muted" id="analysisCount">0 / {{ unanalyzed_count }}</small>
            </div>
            <div class="progress" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" id="analysisProgressBar" style="width: 0%"></div>
            </div>
        </div>
        {% endif %}

        <!-- Date Filter Badge -->
        {% if selected_date %}
        <div class="date-filter-badge">
            <i class="bi bi-calendar-event me-2"></i>
            Showing entries for {{ selected_date }}
            <a href="?year={{ cal_year }}&month={{ cal_month }}{% if query %}&q={{ query }}{% endif %}{% if mood %}&mood={{ mood }}{% endif %}"
               class="clear-filter">&times; Clear</a>
        </div>
        {% endif %}

        <!-- Entry List -->
        {% if entries %}
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-link text-decoration-none p-0 text-dark fw-semibold"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#entriesCollapse"
                            aria-expanded="true"
                            aria-controls="entriesCollapse">
                        <i class="bi bi-chevron-down me-2 collapse-icon"></i>
                        Recent Entries
                        <span class="badge bg-secondary ms-2">{{ entries.paginator.count }}</span>
                    </button>
                    {% if show_all or entries.paginator.count > 5 %}
                    <a href="{% if show_all %}?year={{ cal_year }}&month={{ cal_month }}{% else %}?show_all=1&year={{ cal_year }}&month={{ cal_month }}{% endif %}{% if query %}&q={{ query }}{% endif %}{% if mood %}&mood={{ mood }}{% endif %}"
                       class="btn btn-sm {% if show_all %}btn-outline-secondary{% else %}btn-outline-primary{% endif %}">
                        {% if show_all %}
                        <i class="bi bi-chevron-up me-1"></i>Show Less
                        {% else %}
                        <i class="bi bi-grid me-1"></i>View All
                        {% endif %}
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="collapse show" id="entriesCollapse">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="entry-list">
                        {% for entry in entries %}
                        {% if show_all or forloop.counter <= 5 %}
                        <div class="list-group-item entry-card-inner entry-row" data-entry-id="{{ entry.pk }}">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <a href="{% url 'journal:entry_detail' entry.pk %}" class="entry-link flex-grow-1 text-decoration-none">
                                    <div class="d-flex align-items-center mb-1">
                                        {% if entry.mood %}
                                        <span class="mood-emoji me-2">{{ entry.mood_emoji }}</span>
                                        {% endif %}
                                        <h5 class="mb-0 h6 text-dark">
                                            {% if entry.title %}{{ entry.title }}{% else %}{{ entry.entry_date }}{% endif %}
                                        </h5>
                                    </div>
                                    <p class="text-muted mb-1 small">{{ entry.entry_date|date:"l, F j, Y" }}</p>
                                    <p class="mb-1 small text-dark">{{ entry.preview }}</p>
                                    <small class="text-muted">{{ entry.word_count }} words</small>
                                    {% if entry.analysis %}
                                    <span class="badge bg-{% if entry.analysis.sentiment_label == 'positive' %}success{% elif entry.analysis.sentiment_label == 'negative' %}danger{% else %}secondary{% endif %} ms-2">
                                        {{ entry.analysis.detected_mood }}
                                    </span>
                                    {% endif %}
                                </a>
                                <div class="entry-actions d-flex align-items-center gap-2">
                                    {% if entry.is_analyzed %}
                                    <i class="bi bi-check-circle text-success" title="Analyzed"></i>
                                    {% else %}
                                    <i class="bi bi-hourglass text-warning" title="Processing..."></i>
                                    {% endif %}
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger delete-entry-btn"
                                            data-entry-id="{{ entry.pk }}"
                                            data-entry-title="{{ entry.title|default:entry.entry_date }}"
                                            title="Delete entry">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>

                    {% if not show_all and entries.paginator.count > 5 %}
                    <div class="text-center py-3 border-top" id="showMoreSection">
                        <a href="?show_all=1&year={{ cal_year }}&month={{ cal_month }}{% if query %}&q={{ query }}{% endif %}{% if mood %}&mood={{ mood }}{% endif %}"
                           class="text-primary text-decoration-none">
                            <i class="bi bi-plus-circle me-1"></i>
                            <span id="showMoreText">Show {{ entries.paginator.count|add:"-5" }} more entries</span>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pagination -->
        {% if show_all and entries.has_other_pages %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                {% if entries.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?show_all=1&page={{ entries.previous_page_number }}&year={{ cal_year }}&month={{ cal_month }}{% if query %}&q={{ query }}{% endif %}{% if mood %}&mood={{ mood }}{% endif %}{% if selected_date %}&date={{ selected_date }}{% endif %}">&laquo; Previous</a>
                </li>
                {% endif %}
                <li class="page-item disabled">
                    <span class="page-link">Page {{ entries.number }} of {{ entries.paginator.num_pages }}</span>
                </li>
                {% if entries.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?show_all=1&page={{ entries.next_page_number }}&year={{ cal_year }}&month={{ cal_month }}{% if query %}&q={{ query }}{% endif %}{% if mood %}&mood={{ mood }}{% endif %}{% if selected_date %}&date={{ selected_date }}{% endif %}">Next &raquo;</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

        <!-- On This Day - Other entries from the same day in different years -->
        {% if same_day_other_years %}
        <div class="on-this-day-section mt-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-purple text-white py-2">
                    <i class="bi bi-calendar-heart me-2"></i>
                    On This Day ({{ filter_date|date:"F j" }})
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for other_entry in same_day_other_years %}
                        <a href="{% url 'journal:entry_detail' other_entry.pk %}"
                           class="list-group-item list-group-item-action d-flex align-items-center py-3">
                            <div class="year-badge me-3">
                                {{ other_entry.entry_date|date:"Y" }}
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center">
                                    {% if other_entry.mood %}
                                    <span class="me-2">{{ other_entry.mood_emoji }}</span>
                                    {% endif %}
                                    <strong>{{ other_entry.title|default:"Untitled" }}</strong>
                                </div>
                                <p class="text-muted mb-0 small text-truncate" style="max-width: 400px;">
                                    {{ other_entry.preview }}
                                </p>
                            </div>
                            <small class="text-muted ms-2">
                                {{ other_entry.word_count }} words
                            </small>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Year-over-Year Overview -->
        {% if yearly_stats %}
        <div class="year-overview-section mt-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-link text-decoration-none p-0 text-dark fw-semibold"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#yearOverviewCollapse"
                                aria-expanded="true"
                                aria-controls="yearOverviewCollapse">
                            <i class="bi bi-chevron-down me-2 collapse-icon"></i>
                            <i class="bi bi-calendar3 me-1"></i>Year-over-Year Overview
                            <span class="badge bg-secondary ms-2">{{ yearly_stats|length }} years</span>
                        </button>
                        <div class="d-flex gap-3">
                            <div class="streak-badge current-streak" title="Current writing streak">
                                <i class="bi bi-fire text-warning"></i>
                                <span class="streak-count">{{ current_streak }}</span>
                                <span class="streak-label">Current</span>
                            </div>
                            <div class="streak-badge best-streak" title="Best writing streak ever">
                                <i class="bi bi-fire text-danger"></i>
                                <span class="streak-count">{{ best_streak }}</span>
                                <span class="streak-label">Best</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="yearOverviewCollapse">
                    <div class="card-body pt-0">
                        <div class="row g-3">
                            {% for year_stat in yearly_stats %}
                            <div class="col-12">
                                <div class="year-stat-card p-3 rounded-3 border {% if forloop.first %}border-primary{% endif %}">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="d-flex align-items-center">
                                            <span class="year-badge-large me-3">{{ year_stat.year }}</span>
                                            <div>
                                                <div class="fw-bold">{{ year_stat.entry_count }} entr{{ year_stat.entry_count|pluralize:"y,ies" }}</div>
                                                <div class="text-muted small">{{ year_stat.total_words|intcomma }} words written (avg {{ year_stat.avg_words }} per entry)</div>
                                            </div>
                                        </div>
                                        <div class="text-end d-flex align-items-center gap-2">
                                            {% if year_stat.best_streak > 1 %}
                                            <div class="streak-mini" title="Best streak this year: {{ year_stat.best_streak }} days">
                                                <i class="bi bi-fire text-orange"></i>
                                                <span>{{ year_stat.best_streak }}d</span>
                                            </div>
                                            {% endif %}
                                            <span class="fs-3" title="Dominant mood">{{ year_stat.dominant_mood_emoji }}</span>
                                            {% if year_stat.sentiment_label == 'positive' %}
                                            <div class="badge bg-success-subtle text-success">Positive Year</div>
                                            {% elif year_stat.sentiment_label == 'negative' %}
                                            <div class="badge bg-danger-subtle text-danger">Challenging Year</div>
                                            {% else %}
                                            <div class="badge bg-secondary-subtle text-secondary">Balanced Year</div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Mood Bar -->
                                    {% if year_stat.mood_distribution %}
                                    <div class="mood-bar mb-3" style="height: 8px; border-radius: 4px; overflow: hidden; display: flex; background: #e5e7eb;">
                                        {% if year_stat.mood_distribution.ecstatic %}
                                        <div style="width: {% widthratio year_stat.mood_distribution.ecstatic year_stat.entry_count 100 %}%; background: #fbbf24;" title="Ecstatic: {{ year_stat.mood_distribution.ecstatic }}"></div>
                                        {% endif %}
                                        {% if year_stat.mood_distribution.happy %}
                                        <div style="width: {% widthratio year_stat.mood_distribution.happy year_stat.entry_count 100 %}%; background: #22c55e;" title="Happy: {{ year_stat.mood_distribution.happy }}"></div>
                                        {% endif %}
                                        {% if year_stat.mood_distribution.neutral %}
                                        <div style="width: {% widthratio year_stat.mood_distribution.neutral year_stat.entry_count 100 %}%; background: #9ca3af;" title="Neutral: {{ year_stat.mood_distribution.neutral }}"></div>
                                        {% endif %}
                                        {% if year_stat.mood_distribution.sad %}
                                        <div style="width: {% widthratio year_stat.mood_distribution.sad year_stat.entry_count 100 %}%; background: #3b82f6;" title="Sad: {{ year_stat.mood_distribution.sad }}"></div>
                                        {% endif %}
                                        {% if year_stat.mood_distribution.angry %}
                                        <div style="width: {% widthratio year_stat.mood_distribution.angry year_stat.entry_count 100 %}%; background: #ef4444;" title="Angry: {{ year_stat.mood_distribution.angry }}"></div>
                                        {% endif %}
                                    </div>
                                    {% endif %}

                                    <div class="row g-3 mt-1">
                                        <!-- Sentiment Stats (from AI analysis) -->
                                        <div class="col-md-4">
                                            <div class="small text-muted mb-2"><i class="bi bi-graph-up me-1"></i>Sentiment Analysis</div>
                                            <div class="d-flex gap-4 text-center justify-content-start">
                                                <div title="{{ year_stat.positive_count }} positive entries">
                                                    <div class="fs-5 text-success fw-bold">{{ year_stat.positive_percent }}%</div>
                                                    <div class="text-muted small">Positive</div>
                                                </div>
                                                <div title="{{ year_stat.neutral_count }} neutral entries">
                                                    <div class="fs-5 text-secondary fw-bold">{{ year_stat.neutral_percent }}%</div>
                                                    <div class="text-muted small">Neutral</div>
                                                </div>
                                                <div title="{{ year_stat.negative_count }} negative entries">
                                                    <div class="fs-5 text-danger fw-bold">{{ year_stat.negative_percent }}%</div>
                                                    <div class="text-muted small">Difficult</div>
                                                </div>
                                                {% if year_stat.analyzed_percent < 100 %}
                                                <div class="border-start ps-3">
                                                    <div class="fs-5 text-warning fw-bold">{{ year_stat.analyzed_percent }}%</div>
                                                    <div class="text-muted small">Analyzed</div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Top Themes -->
                                        <div class="col-md-4">
                                            <div class="small text-muted mb-2"><i class="bi bi-tags me-1"></i>Top Themes</div>
                                            {% if year_stat.top_themes %}
                                            <div class="d-flex flex-wrap gap-1">
                                                {% for theme, count in year_stat.top_themes %}
                                                <span class="badge bg-primary-subtle text-primary" title="{{ count }} entries">{{ theme|title }}</span>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <div class="small text-muted fst-italic">No themes detected yet</div>
                                            {% endif %}
                                        </div>

                                        <!-- Top Tags / Keywords -->
                                        <div class="col-md-4">
                                            {% if year_stat.top_hashtags %}
                                            <div class="small text-muted mb-2"><i class="bi bi-hash me-1"></i>Top Hashtags</div>
                                            <div class="d-flex flex-wrap gap-1">
                                                {% for tag, count in year_stat.top_hashtags %}
                                                <span class="badge bg-info-subtle text-info" title="{{ count }} uses">#{{ tag }}</span>
                                                {% endfor %}
                                            </div>
                                            {% elif year_stat.top_keywords %}
                                            <div class="small text-muted mb-2"><i class="bi bi-key me-1"></i>Top Keywords</div>
                                            <div class="d-flex flex-wrap gap-1">
                                                {% for keyword, count in year_stat.top_keywords %}
                                                <span class="badge bg-secondary-subtle text-secondary" title="{{ count }} mentions">{{ keyword }}</span>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <div class="small text-muted mb-2"><i class="bi bi-key me-1"></i>Keywords</div>
                                            <div class="small text-muted fst-italic">No keywords detected yet</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-5">
            <div class="display-1 text-muted mb-3">
                <i class="bi bi-journal-plus"></i>
            </div>
            {% if selected_date %}
            <h3>No entries for this date</h3>
            <p class="text-muted mb-4">There are no journal entries on {{ selected_date }}.</p>
            <a href="{% url 'journal:entry_create' %}?date={{ selected_date }}" class="btn btn-primary btn-lg me-2">
                Write an Entry
            </a>
            <a href="?year={{ cal_year }}&month={{ cal_month }}" class="btn btn-outline-secondary btn-lg">
                View All Entries
            </a>
            {% else %}
            <h3>No entries yet</h3>
            <p class="text-muted mb-4">Start your journaling journey today.</p>
            <a href="{% url 'journal:entry_create' %}" class="btn btn-primary btn-lg">
                Write Your First Entry
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Right Insights Sidebar -->
    {% include 'journal/partials/insights_sidebar.html' %}
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="delete-modal-overlay">
    <div class="delete-modal">
        <div class="delete-modal-icon">
            <i class="bi bi-trash"></i>
        </div>
        <h5>Delete Entry?</h5>
        <p id="deleteModalMessage">Are you sure you want to delete this entry? This action cannot be undone.</p>
        <div class="delete-modal-actions">
            <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                <i class="bi bi-trash me-1"></i>Delete
            </button>
        </div>
    </div>
</div>

<!-- Devotion Modal -->
{% if daily_devotion %}
<div class="modal fade" id="devotionModal" tabindex="-1" aria-labelledby="devotionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary bg-opacity-10">
                <h5 class="modal-title" id="devotionModalLabel">
                    <i class="bi bi-book me-2"></i>Add Devotion to Journal
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-light">
                    <h6 class="text-primary mb-2">{{ daily_devotion.reference }}</h6>
                    <p class="fst-italic mb-2 small">"{{ daily_devotion.verse }}"</p>
                    <p class="small mb-0">{{ daily_devotion.reflection }}</p>
                </div>

                {% if has_entry_today %}
                <p class="mb-3">You already have an entry for today. How would you like to add this devotion?</p>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="addDevotionToEntry('insert')">
                        <i class="bi bi-file-earmark-text me-2"></i>Insert into Today's Entry
                    </button>
                    <button type="button" class="btn btn-primary" onclick="addDevotionToEntry('create')">
                        <i class="bi bi-file-earmark-plus me-2"></i>Create New Entry
                    </button>
                </div>
                {% else %}
                <p class="mb-3">Would you like to create a new entry with this devotion?</p>
                <div class="d-grid">
                    <button type="button" class="btn btn-primary" onclick="addDevotionToEntry('create')">
                        <i class="bi bi-file-earmark-plus me-2"></i>Create Entry for Today
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Add devotion to entry
    function addDevotionToEntry(action) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('devotionModal'));

        fetch("{% url 'journal:add_devotion_to_entry' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `action=${action}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                modal.hide();

                // Show success message
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                alert.style.zIndex = '9999';
                alert.innerHTML = `
                    <i class="bi bi-check-circle me-2"></i>${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alert);

                // Redirect to the entry
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1500);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Toggle insights sidebar
        const insightsToggle = document.querySelector('.insights-toggle');
        const insightsSidebar = document.querySelector('.insights-sidebar-right');

        if (insightsToggle && insightsSidebar) {
            insightsToggle.addEventListener('click', function() {
                insightsSidebar.classList.toggle('collapsed');
            });
        }

        // Calendar scroll functionality
        const calendarScroll = document.getElementById('calendarScroll');
        const todayBtn = document.getElementById('todayBtn');
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth() + 1; // JS months are 0-indexed

        // Function to scroll to a specific month
        function scrollToMonth(year, month, behavior = 'auto') {
            if (!calendarScroll) return;
            const monthSection = calendarScroll.querySelector(
                `[data-year="${year}"][data-month="${month}"]`
            );
            if (monthSection) {
                monthSection.scrollIntoView({ behavior: behavior, block: 'start' });
                calendarScroll.scrollTop -= 10;
            }
        }

        // Scroll to selected date's month if filtering, otherwise current month
        if (calendarScroll) {
            {% if selected_date %}
            // Parse the selected date and scroll to that month
            const selectedDate = new Date('{{ selected_date }}');
            const selectedYear = selectedDate.getFullYear();
            const selectedMonth = selectedDate.getMonth() + 1;
            setTimeout(() => scrollToMonth(selectedYear, selectedMonth), 100);
            {% else %}
            // Scroll to current month
            setTimeout(() => scrollToMonth(currentYear, currentMonth), 100);
            {% endif %}
        }

        // Today button click handler
        if (todayBtn) {
            todayBtn.addEventListener('click', function() {
                scrollToMonth(currentYear, currentMonth, 'smooth');
            });
        }

        // Delete entry functionality
        const deleteModal = document.getElementById('deleteModal');
        const deleteModalMessage = document.getElementById('deleteModalMessage');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        let entryToDelete = null;

        // Open modal when delete button is clicked
        document.querySelectorAll('.delete-entry-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                entryToDelete = this.dataset.entryId;
                const entryTitle = this.dataset.entryTitle;
                deleteModalMessage.textContent = `Are you sure you want to delete "${entryTitle}"? This action cannot be undone.`;
                deleteModal.classList.add('active');
            });
        });

        // Close modal
        function closeDeleteModal() {
            deleteModal.classList.remove('active');
            entryToDelete = null;
        }

        cancelDeleteBtn.addEventListener('click', closeDeleteModal);

        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) {
                closeDeleteModal();
            }
        });

        // Handle escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && deleteModal.classList.contains('active')) {
                closeDeleteModal();
            }
        });

        // Constants
        const VISIBLE_ENTRIES_COUNT = 5;
        const showAll = {{ show_all|yesno:"true,false" }};

        // Function to attach delete handler to a button
        function attachDeleteHandler(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                entryToDelete = this.dataset.entryId;
                const entryTitle = this.dataset.entryTitle;
                deleteModalMessage.textContent = `Are you sure you want to delete "${entryTitle}"? This action cannot be undone.`;
                deleteModal.classList.add('active');
            });
        }

        // Function to fetch the next entry to fill the list
        function fetchNextEntry(offset) {
            const params = new URLSearchParams();
            params.set('offset', offset);
            {% if query %}params.set('q', '{{ query }}');{% endif %}
            {% if mood %}params.set('mood', '{{ mood }}');{% endif %}

            return fetch(`/journal/api/entry-at-offset/?${params.toString()}`)
                .then(response => response.json());
        }

        // Confirm delete
        confirmDeleteBtn.addEventListener('click', function() {
            if (!entryToDelete) return;

            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Deleting...';

            fetch(`/journal/${entryToDelete}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const entryList = document.getElementById('entry-list');
                    const entryRow = document.querySelector(`.entry-row[data-entry-id="${entryToDelete}"]`);
                    const currentVisibleCount = entryList.querySelectorAll('.entry-row').length;

                    // Update entry count badge
                    const countBadge = document.querySelector('.card-header .badge');
                    let totalCount = 0;
                    if (countBadge) {
                        totalCount = parseInt(countBadge.textContent) - 1;
                        countBadge.textContent = totalCount;
                    }

                    // Remove the entry row from the DOM
                    if (entryRow) {
                        entryRow.style.transition = 'opacity 0.3s, transform 0.3s';
                        entryRow.style.opacity = '0';
                        entryRow.style.transform = 'translateX(-20px)';

                        setTimeout(() => {
                            entryRow.remove();

                            // If not showing all entries and there are more entries available,
                            // fetch the next one to maintain the visible count
                            if (!showAll && currentVisibleCount <= VISIBLE_ENTRIES_COUNT && totalCount >= VISIBLE_ENTRIES_COUNT) {
                                fetchNextEntry(VISIBLE_ENTRIES_COUNT - 1).then(nextData => {
                                    if (nextData.html) {
                                        // Insert the new entry HTML
                                        entryList.insertAdjacentHTML('beforeend', nextData.html);

                                        // Attach delete handler to the new button
                                        const newBtn = entryList.querySelector(`.entry-row[data-entry-id="${nextData.entry_id}"] .delete-entry-btn`);
                                        if (newBtn) {
                                            attachDeleteHandler(newBtn);
                                        }

                                        // Animate the new entry in
                                        const newRow = entryList.querySelector(`.entry-row[data-entry-id="${nextData.entry_id}"]`);
                                        if (newRow) {
                                            newRow.style.opacity = '0';
                                            newRow.style.transform = 'translateX(20px)';
                                            setTimeout(() => {
                                                newRow.style.transition = 'opacity 0.3s, transform 0.3s';
                                                newRow.style.opacity = '1';
                                                newRow.style.transform = 'translateX(0)';
                                            }, 50);
                                        }
                                    }
                                });
                            }

                            // Update "Show X more entries" text
                            const showMoreText = document.getElementById('showMoreText');
                            const showMoreSection = document.getElementById('showMoreSection');
                            if (showMoreText && totalCount > VISIBLE_ENTRIES_COUNT) {
                                const remaining = totalCount - VISIBLE_ENTRIES_COUNT;
                                showMoreText.textContent = `Show ${remaining} more ${remaining === 1 ? 'entry' : 'entries'}`;
                            } else if (showMoreSection && totalCount <= VISIBLE_ENTRIES_COUNT) {
                                // Hide the "show more" section if no more entries
                                showMoreSection.style.display = 'none';
                            }
                        }, 300);
                    }

                    closeDeleteModal();
                } else {
                    alert('Failed to delete entry. Please try again.');
                }
            })
            .catch(err => {
                alert('An error occurred. Please try again.');
            })
            .finally(() => {
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Delete';
            });
        });
    });

    // Analyze all unanalyzed entries
    let isAnalyzing = false;
    let totalToAnalyze = {{ unanalyzed_count|default:0 }};
    let totalAnalyzed = 0;

    function analyzeAllEntries() {
        if (isAnalyzing) return;

        const btn = document.getElementById('analyzeEntriesBtn');
        const banner = document.getElementById('unanalyzedBanner');
        const progress = document.getElementById('analysisProgress');
        const progressBar = document.getElementById('analysisProgressBar');
        const progressText = document.getElementById('analysisText');
        const progressCount = document.getElementById('analysisCount');

        isAnalyzing = true;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Analyzing...';
        banner.style.display = 'none';
        progress.style.display = 'block';

        function runBatch() {
            fetch('{% url "journal:analyze_entries" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ limit: 25 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    totalAnalyzed += data.analyzed;

                    const percent = totalToAnalyze > 0
                        ? Math.round((totalAnalyzed / totalToAnalyze) * 100)
                        : 100;

                    progressBar.style.width = percent + '%';
                    progressCount.textContent = `${totalAnalyzed} / ${totalToAnalyze}`;
                    progressText.textContent = `Analyzing entries...`;

                    if (data.remaining > 0) {
                        setTimeout(runBatch, 100);
                    } else {
                        // Done!
                        isAnalyzing = false;
                        progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                        progressBar.classList.add('bg-success');
                        progressText.textContent = `Analysis complete!`;

                        // Reload page after a short delay to show updated data
                        setTimeout(() => location.reload(), 1500);
                    }
                } else {
                    throw new Error('Analysis failed');
                }
            })
            .catch(error => {
                isAnalyzing = false;
                progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                progressBar.classList.add('bg-danger');
                progressText.textContent = 'Error during analysis. Please refresh and try again.';
                console.error('Analysis error:', error);
            });
        }

        runBatch();
    }
</script>
{% endblock %}
