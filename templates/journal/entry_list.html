{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load challenge_tags %}

{% block title %}My Journal{% endblock %}

{% block body_class %}{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Journal Page CSS -->
<link href="{% static 'css/pages/journal.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
        <!-- Header -->
        <div class="insights-header">
            <h1>Insights</h1>
            <div class="d-flex gap-2">
                <a href="{% url 'journal:entry_create' %}" class="btn btn-primary rounded-pill px-4" title="New Entry">
                    <i class="bi bi-plus-lg me-1"></i>New Entry
                </a>
                <a href="?show_all=1" class="btn btn-outline-secondary rounded-pill px-3" title="View All Entries">
                    <i class="bi bi-list me-1"></i>All Entries
                </a>
            </div>
        </div>

        {% if selected_date %}
        <!-- Date Filter View - Show entries for selected date -->
        <div class="date-filter-view">
            <div class="date-filter-badge">
                <i class="bi bi-calendar-event me-2"></i>
                Showing entries for {{ selected_date }}
                <a href="?year={{ cal_year }}&month={{ cal_month }}" class="clear-filter">&times; Back to Insights</a>
            </div>

            {% if entries %}
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for entry in entries %}
                        <div class="list-group-item entry-card-inner entry-row" data-entry-id="{{ entry.pk }}">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <a href="{% url 'journal:entry_detail' entry.pk %}" class="entry-link flex-grow-1 text-decoration-none">
                                    <div class="d-flex align-items-center mb-1">
                                        {% if entry.mood %}
                                        <span class="mood-emoji me-2">{{ entry.mood_emoji }}</span>
                                        {% endif %}
                                        <h5 class="mb-0 h6 text-dark">
                                            {% if entry.title %}{{ entry.title }}{% else %}{{ entry.entry_date }}{% endif %}
                                        </h5>
                                    </div>
                                    <p class="text-muted mb-1 small">{{ entry.entry_date|date:"l, F j, Y" }}</p>
                                    <p class="mb-1 small text-dark">{{ entry.preview }}</p>
                                    <small class="text-muted">{{ entry.word_count }} words</small>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger delete-entry-btn"
                                        data-entry-id="{{ entry.pk }}"
                                        data-entry-title="{{ entry.title|default:entry.entry_date }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-journal-plus display-4 text-muted"></i>
                <p class="text-muted mt-2">No entries for this date</p>
                <a href="{% url 'journal:entry_create' %}?date={{ selected_date }}" class="btn btn-primary">
                    Write an Entry
                </a>
            </div>
            {% endif %}

            <!-- On This Day - Other entries from the same day in different years -->
            {% if same_day_other_years %}
            <div class="mt-4">
                <h6 class="text-muted mb-3"><i class="bi bi-calendar-heart me-2"></i>On This Day ({{ filter_date|date:"F j" }})</h6>
                {% for other_entry in same_day_other_years %}
                <a href="{% url 'journal:entry_detail' other_entry.pk %}" class="d-flex align-items-center p-2 rounded text-decoration-none mb-2" style="background: #f3f4f6;">
                    <span class="badge bg-primary me-3">{{ other_entry.entry_date|date:"Y" }}</span>
                    <div class="flex-grow-1">
                        <strong class="text-dark">{{ other_entry.title|default:"Untitled" }}</strong>
                        <p class="text-muted mb-0 small">{{ other_entry.preview|truncatewords:10 }}</p>
                    </div>
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        {% elif show_all %}
        <!-- Show All Entries View -->
        <div class="date-filter-view">
            <div class="date-filter-badge">
                <i class="bi bi-list me-2"></i>
                All Entries ({{ entries.paginator.count }})
                <a href="?" class="clear-filter">&times; Back to Insights</a>
            </div>

            <!-- Search and Filter -->
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body py-2">
                    <form method="get" class="row g-2 align-items-center">
                        <input type="hidden" name="show_all" value="1">
                        <div class="col-md-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                <input type="text" name="q" class="form-control" placeholder="Search entries..." value="{{ query }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select name="mood" class="form-select form-select-sm">
                                <option value="">All moods</option>
                                <option value="ecstatic" {% if mood == 'ecstatic' %}selected{% endif %}>Ecstatic</option>
                                <option value="happy" {% if mood == 'happy' %}selected{% endif %}>Happy</option>
                                <option value="neutral" {% if mood == 'neutral' %}selected{% endif %}>Neutral</option>
                                <option value="sad" {% if mood == 'sad' %}selected{% endif %}>Sad</option>
                                <option value="angry" {% if mood == 'angry' %}selected{% endif %}>Angry</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-secondary btn-sm w-100">Filter</button>
                        </div>
                    </form>
                </div>
            </div>

            {% if entries %}
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for entry in entries %}
                        <div class="list-group-item entry-card-inner entry-row" data-entry-id="{{ entry.pk }}">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <a href="{% url 'journal:entry_detail' entry.pk %}" class="entry-link flex-grow-1 text-decoration-none">
                                    <div class="d-flex align-items-center mb-1">
                                        {% if entry.mood %}
                                        <span class="mood-emoji me-2">{{ entry.mood_emoji }}</span>
                                        {% endif %}
                                        <h5 class="mb-0 h6 text-dark">
                                            {% if entry.title %}{{ entry.title }}{% else %}{{ entry.entry_date }}{% endif %}
                                        </h5>
                                    </div>
                                    <p class="text-muted mb-1 small">{{ entry.entry_date|date:"l, F j, Y" }}</p>
                                    <p class="mb-1 small text-dark">{{ entry.preview }}</p>
                                    <small class="text-muted">{{ entry.word_count }} words</small>

                                    <!-- Tags, Themes, Keywords, Mood -->
                                    <div class="entry-metadata mt-2">
                                        {% if entry.analysis and entry.analysis.detected_mood %}
                                        <span class="badge rounded-pill me-1 mb-1" style="background: #e0f2fe; color: #0369a1;">
                                            <i class="bi bi-emoji-smile me-1"></i>{{ entry.analysis.detected_mood }}
                                        </span>
                                        {% endif %}

                                        {% for tag in entry.tags.all %}
                                        <span class="badge rounded-pill me-1 mb-1" style="background: #f3e8ff; color: #7c3aed;">
                                            <i class="bi bi-tag me-1"></i>{{ tag.name }}
                                        </span>
                                        {% endfor %}

                                        {% if entry.analysis and entry.analysis.themes %}
                                        {% for theme in entry.analysis.themes|slice:":3" %}
                                        <span class="badge rounded-pill me-1 mb-1" style="background: #dcfce7; color: #15803d;">
                                            {{ theme }}
                                        </span>
                                        {% endfor %}
                                        {% endif %}

                                        {% if entry.analysis and entry.analysis.keywords %}
                                        {% for keyword in entry.analysis.keywords|slice:":3" %}
                                        <span class="badge rounded-pill me-1 mb-1" style="background: #fef3c7; color: #b45309;">
                                            {{ keyword }}
                                        </span>
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger delete-entry-btn"
                                        data-entry-id="{{ entry.pk }}"
                                        data-entry-title="{{ entry.title|default:entry.entry_date }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            {% if entries.has_other_pages %}
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if entries.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?show_all=1&page={{ entries.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if mood %}&mood={{ mood }}{% endif %}">&laquo;</a>
                    </li>
                    {% endif %}
                    <li class="page-item disabled">
                        <span class="page-link">Page {{ entries.number }} of {{ entries.paginator.num_pages }}</span>
                    </li>
                    {% if entries.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?show_all=1&page={{ entries.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if mood %}&mood={{ mood }}{% endif %}">&raquo;</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-journal-plus display-4 text-muted"></i>
                <p class="text-muted mt-2">No entries found</p>
            </div>
            {% endif %}
        </div>

        {% elif filter_type %}
        <!-- Filtered by Capture Type View -->
        <div class="date-filter-view">
            <div class="date-filter-badge">
                {% if filter_type == 'travel' %}<i class="bi bi-airplane me-2"></i>Travel
                {% elif filter_type == 'book' %}<i class="bi bi-book me-2"></i>Readings
                {% elif filter_type == 'workout' %}<i class="bi bi-heart-pulse me-2"></i>Fitness
                {% elif filter_type == 'watched' %}<i class="bi bi-film me-2"></i>Watched
                {% elif filter_type == 'meal' %}<i class="bi bi-cup-hot me-2"></i>Meals
                {% elif filter_type == 'gratitude' %}<i class="bi bi-heart me-2"></i>Gratitude
                {% elif filter_type == 'dream' %}<i class="bi bi-cloud-moon me-2"></i>Dreams
                {% elif filter_type == 'person' %}<i class="bi bi-people me-2"></i>People
                {% elif filter_type == 'place' %}<i class="bi bi-geo-alt me-2"></i>Places
                {% else %}<i class="bi bi-tag me-2"></i>{{ filter_type|title }}
                {% endif %}
                ({{ entries|length }})
                <a href="?" class="clear-filter">&times; Back to Insights</a>
            </div>

            {% if entries %}
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for entry in entries %}
                        <div class="list-group-item entry-card-inner entry-row" data-entry-id="{{ entry.pk }}">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <a href="{% url 'journal:entry_detail' entry.pk %}" class="entry-link flex-grow-1 text-decoration-none">
                                    <div class="d-flex align-items-center mb-1">
                                        {% if entry.mood %}
                                        <span class="mood-emoji me-2">{{ entry.mood_emoji }}</span>
                                        {% endif %}
                                        <h5 class="mb-0 h6 text-dark">
                                            {% if entry.title %}{{ entry.title }}{% else %}{{ entry.entry_date }}{% endif %}
                                        </h5>
                                    </div>
                                    <p class="text-muted mb-1 small">{{ entry.entry_date|date:"l, F j, Y" }}</p>
                                    <p class="mb-1 small text-dark">{{ entry.preview }}</p>
                                    <small class="text-muted">{{ entry.word_count }} words</small>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger delete-entry-btn"
                                        data-entry-id="{{ entry.pk }}"
                                        data-entry-title="{{ entry.title|default:entry.entry_date }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-journal-plus display-4 text-muted"></i>
                <p class="text-muted mt-2">No entries with this capture type</p>
            </div>
            {% endif %}
        </div>

        {% else %}
        <!-- Default Insights View -->

        <!-- Streaks Section -->
        <div class="section-label">Streaks</div>
        <div class="insights-grid streaks-grid">
            <!-- Current Streak - Large gradient card -->
            <div class="insight-card streak-card-current">
                <div class="card-label">Current Streak</div>
                <div>
                    <div class="streak-value">{{ current_streak }}</div>
                    <div class="streak-unit">Days</div>
                </div>
            </div>

            <!-- Longest Daily Streak -->
            <div class="insight-card streak-card-info">
                <div class="card-label">Longest</div>
                <div class="streak-title">Daily Streak</div>
                <div class="d-flex align-items-baseline gap-2">
                    <span class="streak-value">{{ best_streak }}</span>
                    <span class="streak-unit">Days</span>
                </div>
            </div>

            <!-- Longest Weekly Streak -->
            <div class="insight-card streak-card-info">
                <div class="card-label">Longest</div>
                <div class="streak-title">Weekly Streak</div>
                <div class="d-flex align-items-baseline gap-2">
                    <span class="streak-value">{{ longest_weekly_streak }}</span>
                    <span class="streak-unit">Weeks</span>
                </div>
            </div>

            <!-- Daily Prompt -->
            <div class="insight-card prompt-card-grid">
                <div class="card-label">{{ daily_prompt.category }}</div>
                <div class="prompt-icon"><i class="bi {{ daily_prompt.icon }}"></i></div>
                <div class="prompt-text">"{{ daily_prompt.prompt }}"</div>
                <a href="{% url 'journal:entry_create' %}?prompt={{ daily_prompt.prompt|urlencode }}" class="prompt-btn">
                    <i class="bi bi-pencil me-1"></i>Write
                </a>
            </div>

            <!-- Daily Devotion -->
            <div class="insight-card devotion-card-grid">
                {% if daily_devotion %}
                <div class="card-label">Daily Devotion</div>
                <div class="devotion-reference">{{ daily_devotion.reference }}</div>
                <div class="devotion-verse">"{{ daily_devotion.verse|truncatewords:12 }}"</div>
                {% if has_entry_today %}
                <button class="devotion-btn" data-action="insert">
                    <i class="bi bi-plus-circle me-1"></i>Add to Entry
                </button>
                {% else %}
                <button class="devotion-btn" data-action="create">
                    <i class="bi bi-pencil me-1"></i>Write
                </button>
                {% endif %}
                {% else %}
                <div class="devotion-empty">
                    <i class="bi bi-book" style="font-size: 1.5rem; opacity: 0.6; margin-bottom: 0.5rem;"></i>
                    <div>Devotion disabled</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Stats Section -->
        <div class="section-label">Stats</div>
        <div class="stats-grid">
            <!-- Entries Card -->
            <div class="entries-card">
                <div class="entries-header">
                    <div>
                        <div class="entries-count">{{ entries_this_year }}</div>
                        <div class="entries-label">Entr{{ entries_this_year|pluralize:"y,ies" }}</div>
                    </div>
                </div>
                <div class="chart-area">
                    <canvas id="monthlyEntriesChart"></canvas>
                </div>
                <div class="year-tabs">
                    <button class="year-tab" data-year="all">All-time</button>
                    <button class="year-tab active" data-year="{{ today.year }}">{{ today.year }}</button>
                    {% if today.year > 2024 %}
                    <button class="year-tab" data-year="{{ today.year|add:'-1' }}">{{ today.year|add:'-1' }}</button>
                    {% endif %}
                </div>
            </div>

            <!-- Visited Places Card -->
            <div class="places-stats-card">
                {% if total_places > 0 %}
                <div class="places-label-top">Visited</div>
                <div class="places-value">{{ total_places }}</div>
                <div class="places-label">Places</div>
                {% else %}
                <div class="places-empty">No Visited Places</div>
                {% endif %}
            </div>

            <!-- Written Words Card -->
            <div class="words-stats-card">
                <div class="words-label-top">Written</div>
                <div class="words-value">{{ words_this_year|intcomma }}</div>
                <div class="words-label">Words</div>
            </div>

            <!-- Journaled Card -->
            <div class="journaled-stats-card">
                <div class="journaled-main">
                    <div class="journaled-label-top">Journaled</div>
                    <div class="journaled-value">{{ journaled_days_year }}</div>
                    <div class="journaled-unit">Days</div>
                </div>
                <div class="journaled-breakdown">
                    <div class="breakdown-item">
                        <div class="breakdown-value">{{ journaled_days_month }}</div>
                        <div class="breakdown-label">This Month</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-value">{{ journaled_days_year }}</div>
                        <div class="breakdown-label">This Year</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Section -->
        <div class="section-label">Calendar</div>
        <div class="calendar-section">
            <div class="calendar-insights-card">
                <!-- Calendar Panel -->
                <div class="calendar-panel">
                    <div class="calendar-header">
                        <div class="calendar-title">
                            <h3 id="calendarMonthTitle">{{ today|date:"F Y" }}</h3>
                            <i class="bi bi-chevron-right expand-icon"></i>
                        </div>
                        <div class="calendar-nav">
                            <button id="calPrevMonth"><i class="bi bi-chevron-left"></i></button>
                            <button id="calNextMonth"><i class="bi bi-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-weekdays">
                        <span>SUN</span>
                        <span>MON</span>
                        <span>TUE</span>
                        <span>WED</span>
                        <span>THU</span>
                        <span>FRI</span>
                        <span>SAT</span>
                    </div>
                    <div class="calendar-days" id="calendarDays">
                        <!-- Days will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Map Panel -->
                <div class="map-panel">
                    {% if map_locations %}
                    <div id="placesMap"></div>
                    {% else %}
                    <div class="no-places">
                        <i class="bi bi-airplane"></i>
                        <p>No travel yet</p>
                        <small>Use <code>/travel</code> to log destinations</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Active Challenges Widget -->
        {% active_challenges_widget %}

        {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="delete-modal-overlay">
    <div class="delete-modal">
        <div class="delete-modal-icon">
            <i class="bi bi-trash"></i>
        </div>
        <h5 class="text-center">Delete Entry?</h5>
        <p id="deleteModalMessage" class="text-center text-muted">Are you sure you want to delete this entry?</p>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary flex-grow-1" id="cancelDeleteBtn">Cancel</button>
            <button type="button" class="btn btn-danger flex-grow-1" id="confirmDeleteBtn">
                <i class="bi bi-trash me-1"></i>Delete
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Entries Chart
    const chartCtx = document.getElementById('monthlyEntriesChart');
    if (chartCtx) {
        const currentMonth = new Date().getMonth();
        const currentYear = {{ today.year }};
        const prevYear = {{ prev_year }};

        // Data for different year selections
        const chartData = {
            '2025': {
                data: {{ monthly_entry_counts|safe }},
                count: {{ entries_this_year }}
            },
            '2024': {
                data: {{ monthly_entry_counts_prev_year|safe }},
                count: {{ entries_prev_year }}
            },
            'all': {
                data: {{ monthly_entry_counts_all_time|safe }},
                count: {{ entries_all_time }}
            }
        };

        const entriesChart = new Chart(chartCtx, {
            type: 'bar',
            data: {
                labels: ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'],
                datasets: [{
                    data: chartData['2025'].data,
                    backgroundColor: chartData['2025'].data.map((_, i) =>
                        i === currentMonth ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.4)'
                    ),
                    borderRadius: 4,
                    barThickness: 12
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        display: true,
                        grid: { display: false },
                        ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } }
                    },
                    y: {
                        display: true,
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: { color: 'rgba(255,255,255,0.7)', stepSize: 10 }
                    }
                }
            }
        });

        // Year tab click handlers
        document.querySelectorAll('.year-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('.year-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Get selected year
                const year = this.dataset.year;
                const yearData = chartData[year];

                if (yearData) {
                    // Update chart data
                    entriesChart.data.datasets[0].data = yearData.data;
                    // Highlight current month only for current year
                    entriesChart.data.datasets[0].backgroundColor = yearData.data.map((_, i) =>
                        (year === '2025' && i === currentMonth) ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.4)'
                    );
                    entriesChart.update();

                    // Update entries count
                    const countEl = document.querySelector('.entries-count');
                    const labelEl = document.querySelector('.entries-label');
                    if (countEl) countEl.textContent = yearData.count;
                    if (labelEl) labelEl.textContent = yearData.count === 1 ? 'Entry' : 'Entries';
                }
            });
        });
    }

    // Places Map
    {% if map_locations %}
    const locations = {{ map_locations|safe }};

    if (locations.length > 0) {
        // Calculate center
        let sumLat = 0, sumLng = 0;
        locations.forEach(loc => {
            sumLat += loc.lat;
            sumLng += loc.lng;
        });
        const centerLat = sumLat / locations.length;
        const centerLng = sumLng / locations.length;

        const map = L.map('placesMap').setView([centerLat, centerLng], 4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap',
            maxZoom: 18
        }).addTo(map);

        const markers = [];
        locations.forEach(loc => {
            const color = loc.type === 'travel' ? '#3b82f6' : loc.type === 'place' ? '#10b981' : '#f59e0b';
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background:${color};width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;box-shadow:0 2px 8px ${color}80;"><i class="bi bi-geo-alt-fill"></i></div>`,
                iconSize: [28, 28],
                iconAnchor: [14, 28],
                popupAnchor: [0, -28]
            });

            const marker = L.marker([loc.lat, loc.lng], { icon: icon })
                .addTo(map)
                .bindPopup(`<strong>${loc.name}</strong><br><small>${loc.count} visit${loc.count > 1 ? 's' : ''}</small>`);
            markers.push(marker);
        });

        if (markers.length > 1) {
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        // Fix for tiles not fully loading - invalidate size after render
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    }
    {% endif %}

    // Calendar scroll to current month (left sidebar)
    const calendarScroll = document.getElementById('calendarScroll');
    const todayBtn = document.getElementById('todayBtn');
    const today = new Date();

    function scrollToMonth(year, month, behavior = 'auto') {
        if (!calendarScroll) return;
        const monthSection = calendarScroll.querySelector(`[data-year="${year}"][data-month="${month}"]`);
        if (monthSection) {
            monthSection.scrollIntoView({ behavior: behavior, block: 'start' });
            calendarScroll.scrollTop -= 10;
        }
    }

    if (calendarScroll) {
        setTimeout(() => scrollToMonth(today.getFullYear(), today.getMonth() + 1), 100);
    }

    if (todayBtn) {
        todayBtn.addEventListener('click', function() {
            scrollToMonth(today.getFullYear(), today.getMonth() + 1, 'smooth');
        });
    }

    // New Calendar Grid (Insights section)
    const calendarDays = document.getElementById('calendarDays');
    const calendarMonthTitle = document.getElementById('calendarMonthTitle');
    const calPrevMonth = document.getElementById('calPrevMonth');
    const calNextMonth = document.getElementById('calNextMonth');

    // Entry dates from server (for highlighting days with entries)
    const entryDates = new Set([
        {% for month_data in calendar_months %}
            {% for week in month_data.weeks %}
                {% for day in week %}
                    {% if day.has_entry %}'{{ day.date|date:"Y-m-d" }}',{% endif %}
                {% endfor %}
            {% endfor %}
        {% endfor %}
    ]);

    let currentCalYear = today.getFullYear();
    let currentCalMonth = today.getMonth();

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];

    function renderCalendar(year, month) {
        if (!calendarDays) return;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDayOfWeek = firstDay.getDay();
        const daysInMonth = lastDay.getDate();

        // Update title
        if (calendarMonthTitle) {
            calendarMonthTitle.textContent = `${monthNames[month]} ${year}`;
        }

        // Clear existing days
        calendarDays.innerHTML = '';

        // Previous month days (grayed out)
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = startDayOfWeek - 1; i >= 0; i--) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day other-month';
            dayEl.textContent = prevMonthLastDay - i;
            calendarDays.appendChild(dayEl);
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';

            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            // Check if today
            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dayEl.classList.add('today');
            }

            // Check if has entry
            if (entryDates.has(dateStr)) {
                dayEl.classList.add('has-entry');
            }

            dayEl.textContent = day;

            // Click to filter entries by date
            dayEl.addEventListener('click', function() {
                window.location.href = `?date=${dateStr}`;
            });

            calendarDays.appendChild(dayEl);
        }

        // Next month days (grayed out)
        const totalCells = startDayOfWeek + daysInMonth;
        const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let i = 1; i <= remainingCells; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day other-month';
            dayEl.textContent = i;
            calendarDays.appendChild(dayEl);
        }
    }

    // Initialize calendar
    renderCalendar(currentCalYear, currentCalMonth);

    // Navigation
    if (calPrevMonth) {
        calPrevMonth.addEventListener('click', function() {
            currentCalMonth--;
            if (currentCalMonth < 0) {
                currentCalMonth = 11;
                currentCalYear--;
            }
            renderCalendar(currentCalYear, currentCalMonth);
        });
    }

    if (calNextMonth) {
        calNextMonth.addEventListener('click', function() {
            currentCalMonth++;
            if (currentCalMonth > 11) {
                currentCalMonth = 0;
                currentCalYear++;
            }
            renderCalendar(currentCalYear, currentCalMonth);
        });
    }

    // Delete entry functionality
    const deleteModal = document.getElementById('deleteModal');
    const deleteModalMessage = document.getElementById('deleteModalMessage');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let entryToDelete = null;

    document.querySelectorAll('.delete-entry-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            entryToDelete = this.dataset.entryId;
            const entryTitle = this.dataset.entryTitle;
            deleteModalMessage.textContent = `Are you sure you want to delete "${entryTitle}"?`;
            deleteModal.classList.add('active');
        });
    });

    function closeDeleteModal() {
        deleteModal.classList.remove('active');
        entryToDelete = null;
    }

    if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
    }

    if (deleteModal) {
        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) closeDeleteModal();
        });
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && deleteModal && deleteModal.classList.contains('active')) {
            closeDeleteModal();
        }
    });

    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', function() {
            if (!entryToDelete) return;

            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            fetch(`/journal/${entryToDelete}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const entryRow = document.querySelector(`.entry-row[data-entry-id="${entryToDelete}"]`);
                    if (entryRow) {
                        entryRow.style.opacity = '0';
                        entryRow.style.transform = 'translateX(-20px)';
                        setTimeout(() => entryRow.remove(), 300);
                    }
                    closeDeleteModal();
                } else {
                    alert('Failed to delete entry.');
                }
            })
            .catch(() => alert('An error occurred.'))
            .finally(() => {
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Delete';
            });
        });
    }

    // Devotion button handlers
    const devotionBtns = document.querySelectorAll('.devotion-btn');
    devotionBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.dataset.action;
            const originalText = this.innerHTML;

            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            fetch('{% url "journal:add_devotion_to_entry" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    alert(data.error || 'Something went wrong');
                    this.disabled = false;
                    this.innerHTML = originalText;
                }
            })
            .catch(() => {
                alert('An error occurred');
                this.disabled = false;
                this.innerHTML = originalText;
            });
        });
    });
});
</script>
{% endblock %}
