{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_new %}New Entry{% else %}Edit Entry{% endif %}{% endblock %}

{% block body_class %}no-scroll{% endblock %}

{% block extra_css %}
<link href="{% static 'css/pages/entry-form.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <a href="{% if entry %}{% url 'journal:entry_detail' pk=entry.pk %}{% else %}{% url 'journal:entry_list' %}{% endif %}"
                           class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left me-1"></i>Back
                        </a>
                        <span class="text-muted small">
                            <i class="bi bi-pencil me-1"></i>
                            {% if is_new %}New Entry{% else %}Editing{% endif %}
                        </span>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="save-status small" id="saveIndicator">
                            <i class="bi bi-cloud-check me-1"></i>Auto-save on
                        </span>
                        {% if entry %}
                        <a href="{% url 'journal:entry_delete' pk=entry.pk %}" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-trash me-1"></i>Delete
                        </a>
                        {% endif %}
                        <button type="submit" form="entry-form" class="btn btn-primary btn-sm px-3">
                            <i class="bi bi-check2 me-1"></i>Save
                        </button>
                    </div>
                </div>

                <form method="post" id="entry-form">
                    {% csrf_token %}

                    {% if challenge_prompt %}
                    <!-- Challenge Context Banner -->
                    <div class="alert alert-primary d-flex align-items-center mb-3" role="alert">
                        <i class="bi bi-trophy me-2"></i>
                        <div class="flex-grow-1">
                            <strong>{{ user_challenge.challenge.title }}</strong> - Day {{ challenge_prompt.day_number }}
                            <div class="small">{{ challenge_prompt.title }}</div>
                        </div>
                        <div class="form-check form-switch ms-3">
                            <input class="form-check-input" type="checkbox" id="link_challenge" name="link_challenge" checked>
                            <label class="form-check-label small" for="link_challenge">Count for challenge</label>
                        </div>
                    </div>
                    <input type="hidden" name="challenge_slug" value="{{ challenge_slug }}">
                    <input type="hidden" name="challenge_day" value="{{ challenge_day }}">
                    {% endif %}

                    <!-- Title -->
                    <input type="text"
                           name="title"
                           id="id_title"
                           class="title-input"
                           placeholder="Untitled"
                           value="{{ form.title.value|default:'' }}"
                           autocomplete="off">

                    <!-- Metadata Toggle -->
                    <div class="metadata-toggle" data-bs-toggle="collapse" data-bs-target="#metadataPanel">
                        <i class="bi bi-sliders2"></i>
                        <span>Date, Mood & Energy</span>
                        <i class="bi bi-chevron-down ms-auto"></i>
                    </div>

                    <!-- Collapsible Metadata -->
                    <div class="collapse {% if is_new %}show{% endif %}" id="metadataPanel">
                        <div class="metadata-panel">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Date</label>
                                    <input type="date"
                                           name="entry_date"
                                           class="form-control"
                                           value="{{ form.entry_date.value|date:'Y-m-d' }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Mood</label>
                                    <select name="mood" class="form-select">
                                        <option value="">How are you feeling?</option>
                                        <option value="ecstatic" {% if form.mood.value == 'ecstatic' %}selected{% endif %}>ü§© Ecstatic</option>
                                        <option value="happy" {% if form.mood.value == 'happy' %}selected{% endif %}>üòä Happy</option>
                                        <option value="neutral" {% if form.mood.value == 'neutral' %}selected{% endif %}>üòê Neutral</option>
                                        <option value="sad" {% if form.mood.value == 'sad' %}selected{% endif %}>üò¢ Sad</option>
                                        <option value="angry" {% if form.angry.value == 'angry' %}selected{% endif %}>üò† Angry</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Energy</label>
                                    <select name="energy" class="form-select">
                                        <option value="">Energy level?</option>
                                        <option value="high" {% if form.energy.value == 'high' %}selected{% endif %}>‚ö° High</option>
                                        <option value="medium" {% if form.energy.value == 'medium' %}selected{% endif %}>üîã Medium</option>
                                        <option value="low" {% if form.energy.value == 'low' %}selected{% endif %}>ü™´ Low</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-8">
                                    <label class="form-label">
                                        <i class="bi bi-geo-alt me-1"></i>Location <small class="text-muted">(for weather tracking)</small>
                                    </label>
                                    <div class="input-group">
                                        <input type="text"
                                               name="city"
                                               id="id_city"
                                               class="form-control"
                                               placeholder="e.g., New York, Tokyo, London"
                                               value="{{ form.city.value|default:profile.city|default:'' }}">
                                        <button type="button" class="btn btn-outline-secondary" id="detectLocationBtn" title="Detect current location">
                                            <i class="bi bi-crosshairs" id="locationIcon"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Where are you writing from? <a href="#" id="detectLocationLink" class="text-decoration-none">Detect my location</a></div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Country Code</label>
                                    <input type="text"
                                           name="country_code"
                                           id="id_country_code"
                                           class="form-control"
                                           placeholder="US"
                                           maxlength="2"
                                           style="text-transform: uppercase;"
                                           value="{{ form.country_code.value|default:profile.country_code|default:'US' }}">
                                    <div class="form-text">Two-letter code (e.g., US, JP, GB)</div>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Habit Detection Suggestions -->
                    <div id="habitSuggestions" class="alert alert-success border-0 mb-3 d-none" style="background-color: #f0fdf4; font-size: 0.85rem;">
                        <div class="d-flex align-items-start justify-content-between">
                            <div class="d-flex align-items-start flex-grow-1">
                                <i class="bi bi-lightbulb me-2 mt-1 text-success"></i>
                                <div>
                                    <strong>Habits detected!</strong>
                                    <div id="habitSuggestionsContent" class="mt-2"></div>
                                </div>
                            </div>
                            <button type="button" class="btn-close btn-close-sm" onclick="document.getElementById('habitSuggestions').classList.add('d-none')"></button>
                        </div>
                    </div>

                    <!-- Editor Layout -->
                    <div class="editor-layout">
                        <div class="editor-column">
                            <div class="editor-container" style="position: relative;">
                                {% if editor_preference == 'rich_text' %}
                                <!-- Quill Custom Toolbar -->
                                <div id="quill-toolbar">
                                    <span class="ql-formats">
                                        <select class="ql-header">
                                            <option value="1">Heading 1</option>
                                            <option value="2">Heading 2</option>
                                            <option value="3">Heading 3</option>
                                            <option selected>Normal</option>
                                        </select>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-bold"></button>
                                        <button class="ql-italic"></button>
                                        <button class="ql-underline"></button>
                                        <button class="ql-strike"></button>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-blockquote"></button>
                                        <button class="ql-code-block"></button>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-list" value="ordered"></button>
                                        <button class="ql-list" value="bullet"></button>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-link"></button>
                                        <button class="ql-image"></button>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-clean"></button>
                                    </span>
                                    <!-- Custom Reflekt Buttons -->
                                    <span class="ql-formats ql-reflekt-buttons">
                                        <button type="button" class="ql-reflekt-btn" id="btn-dream" title="Add Dream">
                                            <i class="bi bi-cloud-moon"></i>
                                        </button>
                                        <button type="button" class="ql-reflekt-btn" id="btn-gratitude" title="Add Gratitude">
                                            <i class="bi bi-heart"></i>
                                        </button>
                                        <button type="button" class="ql-reflekt-btn" id="btn-person" title="Tag Person">
                                            <i class="bi bi-person"></i>
                                        </button>
                                        <button type="button" class="ql-reflekt-btn" id="btn-place" title="Add Place">
                                            <i class="bi bi-geo-alt"></i>
                                        </button>
                                        <button type="button" class="ql-reflekt-btn" id="btn-book" title="Add Book">
                                            <i class="bi bi-book"></i>
                                        </button>
                                        <button type="button" class="ql-reflekt-btn" id="btn-watched" title="Add Movie/Show">
                                            <i class="bi bi-film"></i>
                                        </button>
                                        <button type="button" class="ql-reflekt-btn" id="btn-travel" title="Add Travel">
                                            <i class="bi bi-airplane"></i>
                                        </button>
                                        <button type="button" class="ql-reflekt-btn" id="btn-workout" title="Add Workout">
                                            <i class="bi bi-activity"></i>
                                        </button>
                                        <button type="button" class="ql-reflekt-btn" id="btn-meal" title="Add Meal">
                                            <i class="bi bi-egg-fried"></i>
                                        </button>
                                        <button type="button" class="ql-reflekt-btn" id="btn-goal" title="Link Goal">
                                            <i class="bi bi-bullseye"></i>
                                        </button>
                                        <button type="button" class="ql-reflekt-btn" id="btn-habit" title="Log Habit">
                                            <i class="bi bi-check2-square"></i>
                                        </button>
                                        <button type="button" class="ql-reflekt-btn" id="btn-pov" title="Share POV">
                                            <i class="bi bi-people"></i>
                                        </button>
                                    </span>
                                </div>
                                <!-- Quill Rich Text Editor -->
                                <div id="quill-editor"></div>
                                <textarea name="content" id="id_content" style="display:none;">{{ form.content.value|default:'' }}</textarea>
                                {% else %}
                                <!-- MyST Markdown Editor (EasyMDE) -->
                                <textarea name="content" id="editor">{{ form.content.value|default:'' }}</textarea>
                                {% endif %}

                                <!-- Combined Bottom Bar: Word Count + Tracked Items + Attachments -->
                                <div class="editor-bottom-bar">
                                    <div class="bottom-bar-left">
                                        <span class="word-count-inline">
                                            <span id="wordCount">0</span> words
                                        </span>
                                        <span class="text-muted small ms-2 d-none d-sm-inline">Type / for commands</span>
                                    </div>
                                    <div class="bottom-bar-center">
                                        <!-- Tracked Items (inline) -->
                                        <div class="tracked-items-inline" id="capturesSection">
                                            <div class="captures-list-inline" id="capturesList">
                                                {% if entry %}
                                                {% for capture in entry.captures.all %}
                                                <div class="capture-pill-sm {{ capture.capture_type }}" data-id="{{ capture.id }}" title="{{ capture.display_text }}">
                                                    <i class="bi {{ capture.icon }}"></i>
                                                    <span class="capture-text">{{ capture.display_text }}</span>
                                                    <span class="capture-delete" onclick="event.stopPropagation(); deleteCapture({{ capture.id }})" title="Remove">
                                                        <i class="bi bi-x"></i>
                                                    </span>
                                                </div>
                                                {% endfor %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bottom-bar-right">
                                        <!-- Attachment Button -->
                                        <button type="button" class="btn-attachment" id="attachmentBtn" title="Add attachments">
                                            <i class="bi bi-paperclip"></i>
                                            <span class="badge bg-primary rounded-pill ms-1 {% if not entry or entry.attachments.count == 0 %}d-none{% endif %}" id="attachmentCount">{% if entry %}{{ entry.attachments.count }}{% else %}0{% endif %}</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Slash Command Menu (positioned relative to editor) -->
                                <div class="slash-command-menu" id="slashCommandMenu"></div>

                                <!-- @ Mention Menu (for POV sharing) -->
                                <div class="mention-menu" id="mentionMenu"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden capture count for JS -->
                    <input type="hidden" id="captureCountValue" value="{% if entry %}{{ entry.captures.count }}{% else %}0{% endif %}">

                    <!-- Attachment Dropdown Panel (hidden by default) -->
                    <div class="attachment-panel" id="attachmentPanel">
                        <div class="attachment-panel-header">
                            <span><i class="bi bi-paperclip me-1"></i>Attachments</span>
                            <button type="button" class="btn-close btn-close-sm" id="closeAttachmentPanel"></button>
                        </div>
                        <div class="upload-zone-compact" id="uploadZone">
                            <i class="bi bi-cloud-arrow-up"></i>
                            <span>Drop files or <span class="browse-link">browse</span></span>
                            <input type="file" id="fileInput" multiple accept="image/*,audio/*,video/*" style="display:none;">
                        </div>
                        <div class="attachments-gallery-compact" id="attachmentsGallery">
                            {% if entry %}
                            {% for attachment in entry.attachments.all %}
                            <div class="attachment-item-compact" data-id="{{ attachment.id }}" data-url="{{ attachment.secure_url }}">
                                {% if attachment.is_image %}
                                <img src="{{ attachment.secure_url }}" alt="{{ attachment.file_name }}">
                                {% elif attachment.is_audio %}
                                <div class="file-icon-sm audio"><i class="bi bi-music-note-beamed"></i></div>
                                {% elif attachment.is_video %}
                                <div class="file-icon-sm video"><i class="bi bi-play-circle"></i></div>
                                {% endif %}
                                <span class="file-name-compact" title="{{ attachment.file_name }}">{{ attachment.file_name }}</span>
                                <div class="attachment-actions">
                                    {% if attachment.is_image %}
                                    <button type="button" class="copy-url-btn" onclick="copyImageSyntax(this, '{{ attachment.secure_url }}')" title="Copy {image} syntax">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="delete-btn-sm" onclick="deleteAttachment({{ attachment.id }})">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                        <div class="upload-progress d-none" id="uploadProgress">
                            <div class="progress" style="height: 3px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="uploadStatus">Uploading...</small>
                        </div>
                    </div>
                </form>
</div>

<!-- Draft Restore Modal -->
<div class="modal fade" id="draftRestoreModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="bi bi-clock-history text-primary" style="font-size: 2.5rem;"></i>
                </div>
                <h5 class="mb-2">Restore Draft?</h5>
                <p class="text-muted small mb-4" id="draftRestoreMessage">
                    You have an unsaved draft from a previous session.
                </p>
                <div class="d-flex gap-2 justify-content-center">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-3" id="draftDiscardBtn">
                        <i class="bi bi-trash me-1"></i>Discard
                    </button>
                    <button type="button" class="btn btn-primary rounded-pill px-3" id="draftRestoreBtn">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Restore
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Unsaved Changes Modal -->
<div class="modal fade" id="unsavedChangesModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2.5rem;"></i>
                </div>
                <h5 class="mb-2">Unsaved Changes</h5>
                <p class="text-muted small mb-4">
                    You have unsaved changes. Are you sure you want to leave?
                </p>
                <div class="d-flex gap-2 justify-content-center">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-3" id="unsavedStayBtn">
                        <i class="bi bi-pencil me-1"></i>Keep Editing
                    </button>
                    <button type="button" class="btn btn-danger rounded-pill px-3" id="unsavedLeaveBtn">
                        <i class="bi bi-box-arrow-right me-1"></i>Leave
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Picker Modal (simplified slash commands) -->
<div class="modal fade" id="quickPickerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title d-flex align-items-center mb-0">
                    <i class="bi bi-search me-2" id="quickPickerIcon"></i>
                    <span id="quickPickerTitle">Select</span>
                </h6>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-2">
                <input type="text" class="form-control form-control-sm mb-2"
                       id="quickPickerSearch" placeholder="Search or type new...">
                <div id="quickPickerList" class="quick-picker-list"></div>
                <div id="quickPickerCreate" class="quick-picker-create d-none">
                    <button class="btn btn-sm btn-outline-primary w-100">
                        <i class="bi bi-plus-circle me-1"></i>Create "<span id="quickPickerNewName"></span>"
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Goal/Habit Picker Modal -->
<div class="modal fade" id="goalHabitPickerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title d-flex align-items-center mb-0">
                    <i class="bi bi-bullseye me-2" id="goalHabitPickerIcon"></i>
                    <span id="goalHabitPickerTitle">Select</span>
                </h6>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <input type="text" class="form-control form-control-sm mb-3"
                       id="goalHabitPickerSearch" placeholder="Search...">
                <div id="goalHabitPickerList" class="goal-habit-picker-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- Capture Form Modal (for /watched, /travel, /workout, etc.) -->
<div class="modal fade" id="captureFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title d-flex align-items-center mb-0">
                    <i class="bi bi-plus-circle me-2" id="captureFormIcon"></i>
                    <span id="captureFormTitle">Log</span>
                </h6>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="captureForm">
                    <div id="captureFormFields"></div>
                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-sm">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Hybrid Picker Modal (for books, shows with existing items) -->
<div class="modal fade" id="hybridPickerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title mb-0" id="hybridPickerTitle">Select</h6>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="hybridPickerList" class="hybrid-picker-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- POV Share Modal -->
<div class="modal fade" id="povModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2 bg-primary bg-opacity-10">
                <h6 class="modal-title d-flex align-items-center mb-0">
                    <i class="bi bi-people me-2 text-primary"></i>
                    Share a POV
                </h6>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <p class="text-muted small mb-3">Share a personal perspective with a friend. They'll see your message in their POV inbox.</p>

                <!-- Friend Selector -->
                <div class="mb-3">
                    <label class="form-label small fw-medium">Share with</label>
                    <select class="form-select" id="povFriendSelect">
                        <option value="">Select a friend...</option>
                    </select>
                </div>

                <!-- POV Message -->
                <div class="mb-3">
                    <label class="form-label small fw-medium">Your message</label>
                    <textarea class="form-control" id="povMessage" rows="4"
                              placeholder="Write your POV here..."></textarea>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="povSubmitBtn">
                    <i class="bi bi-send me-1"></i>Add to Entry
                </button>
            </div>
        </div>
    </div>
</div>


<style>
.hybrid-picker-list {
    max-height: 350px;
    overflow-y: auto;
}
.hybrid-picker-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
    transition: background 0.15s;
}
.hybrid-picker-item:hover {
    background: #f9fafb;
}
.hybrid-picker-item:last-child {
    border-bottom: none;
}
.hybrid-picker-item.create-new {
    background: #f0fdf4;
}
.hybrid-picker-item.create-new:hover {
    background: #dcfce7;
}
.hybrid-picker-divider {
    padding: 0.5rem 1rem;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    color: #9ca3af;
    background: #f9fafb;
    border-bottom: 1px solid #f3f4f6;
}
.picker-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle insights sidebar
    const insightsToggle = document.querySelector('.insights-toggle');
    const insightsSidebar = document.querySelector('.insights-sidebar-right');

    if (insightsToggle && insightsSidebar) {
        insightsToggle.addEventListener('click', function() {
            insightsSidebar.classList.toggle('collapsed');
        });
    }

    // Calendar scroll functionality
    const calendarScroll = document.getElementById('calendarScroll');
    const todayBtn = document.getElementById('todayBtn');
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1;

    // Function to scroll to a specific month
    function scrollToMonth(year, month, behavior = 'auto') {
        if (!calendarScroll) return;
        const monthSection = calendarScroll.querySelector(
            `[data-year="${year}"][data-month="${month}"]`
        );
        if (monthSection) {
            monthSection.scrollIntoView({ behavior: behavior, block: 'start' });
            calendarScroll.scrollTop -= 10;
        }
    }

    // Scroll to the entry's date month (edit mode) or current month (new entry)
    if (calendarScroll) {
        {% if entry and entry.entry_date %}
        const entryDate = new Date('{{ entry.entry_date|date:"Y-m-d" }}');
        const entryYear = entryDate.getFullYear();
        const entryMonth = entryDate.getMonth() + 1;
        setTimeout(() => scrollToMonth(entryYear, entryMonth), 100);
        {% else %}
        setTimeout(() => scrollToMonth(currentYear, currentMonth), 100);
        {% endif %}
    }

    // Today button click handler
    if (todayBtn) {
        todayBtn.addEventListener('click', function() {
            scrollToMonth(currentYear, currentMonth, 'smooth');
        });
    }

    const editorPreference = '{{ editor_preference }}';
    const saveIndicator = document.getElementById('saveIndicator');
    const wordCountEl = document.getElementById('wordCount');
    let autoSaveTimeout = null;

    // Word count function
    function updateWordCount(text) {
        const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
        wordCountEl.textContent = words;
    }

    // Auto-save indicator
    function showSaving() {
        saveIndicator.innerHTML = '<i class="bi bi-cloud-arrow-up me-1"></i>Saving...';
        saveIndicator.classList.add('saving');
        saveIndicator.classList.remove('saved');
    }

    function showSaved() {
        saveIndicator.innerHTML = '<i class="bi bi-cloud-check me-1"></i>Saved';
        saveIndicator.classList.remove('saving');
        saveIndicator.classList.add('saved');
        setTimeout(() => {
            saveIndicator.innerHTML = '<i class="bi bi-cloud-check me-1"></i>Auto-save on';
            saveIndicator.classList.remove('saved');
        }, 2000);
    }

    // Local storage auto-save
    function autoSave(content) {
        clearTimeout(autoSaveTimeout);
        showSaving();
        autoSaveTimeout = setTimeout(() => {
            const key = 'reflekt-entry-{% if entry %}{{ entry.pk }}{% else %}new{% endif %}';
            localStorage.setItem(key, JSON.stringify({
                title: document.getElementById('id_title').value,
                content: content,
                timestamp: Date.now()
            }));
            showSaved();
        }, 1000);
    }

    // =================================================================
    // SHARED VARIABLES (for both Quill and EasyMDE)
    // =================================================================
    let entryPk = {{ entry.pk|default:'null' }};
    // editorPreference is already declared above

    // =================================================================
    // SHARED SLASH COMMANDS SETUP (for both Quill and EasyMDE)
    // =================================================================
    console.log('[DEBUG] Slash commands section initialized');

    let slashCommands = [];
    const slashMenu = document.getElementById('slashCommandMenu');
    let selectedCommandIndex = 0;
    let currentCommand = null;

    // Fetch slash commands from server
    async function loadSlashCommands() {
        console.log('[DEBUG] loadSlashCommands called');
        try {
            const response = await fetch('/journal/api/slash-commands/');
            const data = await response.json();
            slashCommands = data.commands.map(cmd => {
                const mapped = {
                    command: cmd.command,
                    name: cmd.name,
                    icon: cmd.icon,
                    description: cmd.description,
                    is_emoji_icon: cmd.is_emoji_icon || false,
                };
                if (cmd.special === 'capture_form') {
                    mapped.special = 'capture_form';
                    mapped.captureType = cmd.captureType;
                } else if (cmd.special === 'goal_picker') {
                    mapped.special = 'goal_picker';
                } else if (cmd.special === 'habit_picker') {
                    mapped.special = 'habit_picker';
                } else if (cmd.special === 'hybrid_picker') {
                    mapped.special = 'hybrid_picker';
                    mapped.captureType = cmd.captureType;
                    mapped.fields = cmd.fields;  // Include fields for "Create New" option
                } else if (cmd.special === 'block_insert') {
                    mapped.special = 'block_insert';
                    mapped.blockType = cmd.blockType;
                    mapped.hashtag = cmd.hashtag;
                } else if (cmd.special === 'quick_picker') {
                    mapped.special = 'quick_picker';
                    mapped.pickerType = cmd.pickerType;
                }
                return mapped;
            });
            console.log('Loaded slash commands:', slashCommands);
        } catch (error) {
            console.error('Error loading slash commands:', error);
            slashCommands = [
                { command: '/dream', name: 'Dream', icon: 'bi-cloud-moon', description: 'Log a dream', special: 'block_insert', blockType: 'dream' },
                { command: '/gratitude', name: 'Gratitude', icon: 'bi-heart', description: 'Express gratitude', special: 'block_insert', blockType: 'gratitude' },
            ];
        }
    }

    // Load commands on page load
    loadSlashCommands();

    // Build menu items (shared between Quill and EasyMDE)
    function renderSlashMenu(filter = '') {
        const filtered = filter
            ? slashCommands.filter(c => c.command.toLowerCase().includes(filter.toLowerCase()) ||
                                        c.name.toLowerCase().includes(filter.toLowerCase()))
            : slashCommands;

        if (filtered.length === 0) {
            slashMenu.classList.remove('show');
            return filtered;
        }

        selectedCommandIndex = 0;
        slashMenu.innerHTML = filtered.map((cmd, idx) => {
            const iconHtml = cmd.is_emoji_icon
                ? `<span style="font-size: 1.25rem;">${cmd.icon}</span>`
                : `<i class="bi ${cmd.icon}"></i>`;

            return `
            <div class="slash-command-item ${idx === 0 ? 'selected' : ''}" data-command="${cmd.command}">
                <div class="slash-command-icon">${iconHtml}</div>
                <div class="slash-command-info">
                    <div class="slash-command-name">${cmd.name}</div>
                    <div class="slash-command-desc">${cmd.description}</div>
                </div>
                <div class="slash-command-shortcut">${cmd.command}</div>
            </div>`;
        }).join('');

        slashMenu.classList.add('show');
        return filtered;
    }

    // =================================================================
    // UNIFIED CAPTURE SYSTEM (shared between Quill and EasyMDE)
    // =================================================================

    // Unified field definitions for all capture types
    const unifiedCaptureFields = {
        book: [
            { name: 'title', label: 'Title', type: 'text', required: true, placeholder: 'Book title' },
            { name: 'author', label: 'Author', type: 'text', required: false, placeholder: 'Author name' },
            { name: 'status', label: 'Status', type: 'select', required: false,
              options: [['reading', 'Reading'], ['finished', 'Finished'], ['abandoned', 'Abandoned']] },
            { name: 'page', label: 'Page/Chapter', type: 'number', required: false, placeholder: 'Current page' },
            { name: 'rating', label: 'Rating', type: 'rating', required: false },
        ],
        watched: [
            { name: 'title', label: 'Title', type: 'text', required: true, placeholder: 'Movie or show name' },
            { name: 'type', label: 'Type', type: 'select', required: false,
              options: [['movie', 'Movie'], ['show', 'TV Show'], ['documentary', 'Documentary']] },
            { name: 'season', label: 'Season', type: 'number', required: false, placeholder: 'Season #' },
            { name: 'episode', label: 'Episode', type: 'number', required: false, placeholder: 'Episode #' },
            { name: 'rating', label: 'Rating', type: 'rating', required: false },
        ],
        travel: [
            { name: 'mode', label: 'Mode', type: 'select', required: true,
              options: [['car', 'Car'], ['plane', 'Plane'], ['train', 'Train'], ['bus', 'Bus'],
                       ['walk', 'Walk'], ['bike', 'Bike'], ['boat', 'Boat']] },
            { name: 'origin', label: 'From', type: 'text', required: true, placeholder: 'Starting point' },
            { name: 'destination', label: 'To', type: 'text', required: true, placeholder: 'Destination' },
        ],
        workout: [
            { name: 'type', label: 'Type', type: 'select', required: true,
              options: [['run', 'Running'], ['walk', 'Walking'], ['gym', 'Gym'], ['yoga', 'Yoga'],
                       ['swim', 'Swimming'], ['bike', 'Cycling'], ['hike', 'Hiking'],
                       ['sports', 'Sports'], ['other', 'Other']] },
            { name: 'duration', label: 'Duration (min)', type: 'number', required: false, placeholder: '30' },
            { name: 'intensity', label: 'Intensity', type: 'select', required: false,
              options: [['low', 'Low'], ['medium', 'Medium'], ['high', 'High']] },
        ],
        person: [
            { name: 'name', label: 'Name', type: 'text', required: true, placeholder: 'Person\'s name' },
            { name: 'context', label: 'Context', type: 'text', required: false, placeholder: 'e.g., lunch, meeting, call' },
        ],
        place: [
            { name: 'name', label: 'Name', type: 'text', required: true, placeholder: 'Place name' },
            { name: 'type', label: 'Type', type: 'select', required: false,
              options: [['restaurant', 'Restaurant'], ['cafe', 'Cafe'], ['bar', 'Bar'],
                       ['park', 'Park'], ['office', 'Office'], ['home', 'Home'],
                       ['store', 'Store'], ['gym', 'Gym'], ['other', 'Other']] },
        ],
        meal: [
            { name: 'meal', label: 'Meal', type: 'select', required: true,
              options: [['breakfast', 'Breakfast'], ['lunch', 'Lunch'], ['dinner', 'Dinner'], ['snack', 'Snack']] },
            { name: 'what', label: 'What', type: 'text', required: true, placeholder: 'What did you eat?' },
        ],
        dream: [],
        gratitude: [
            { name: 'item1', label: 'Grateful for...', type: 'text', required: true, placeholder: 'Something you\'re grateful for' },
            { name: 'item2', label: 'Also grateful for...', type: 'text', required: false },
            { name: 'item3', label: 'And grateful for...', type: 'text', required: false },
        ],
        pain: [
            { name: 'location', label: 'Location', type: 'select', required: true,
              options: [['head', 'Head'], ['neck', 'Neck'], ['back', 'Back'], ['chest', 'Chest'],
                       ['arm', 'Arm'], ['leg', 'Leg'], ['tooth', 'Tooth'], ['stomach', 'Stomach'],
                       ['joint', 'Joint'], ['other', 'Other']] },
            { name: 'intensity', label: 'Intensity (1-10)', type: 'range', required: true, min: 1, max: 10, defaultVal: 5 },
            { name: 'pain_type', label: 'Type', type: 'select', required: false,
              options: [['', '-- Select --'], ['sharp', 'Sharp'], ['dull', 'Dull'],
                       ['throbbing', 'Throbbing'], ['burning', 'Burning'],
                       ['aching', 'Aching'], ['stabbing', 'Stabbing']] },
            { name: 'duration', label: 'Duration', type: 'select', required: false,
              options: [['', '-- Select --'], ['brief', 'Brief (minutes)'], ['hours', 'Hours'],
                       ['all_day', 'All Day'], ['ongoing', 'Ongoing']] },
        ],
        intimacy: [
            { name: 'rating', label: 'Rating (optional)', type: 'rating', required: false },
        ],
        cycle: [
            { name: 'event_type', label: 'Event', type: 'select', required: true,
              options: [['period_start', 'Period Started'], ['period_end', 'Period Ended'],
                       ['symptom', 'Symptom Only'], ['note', 'Note']] },
            { name: 'flow_level', label: 'Flow (if applicable)', type: 'select', required: false,
              options: [['', '-- Select --'], ['light', 'Light'], ['medium', 'Medium'], ['heavy', 'Heavy']] },
        ],
    };

    // Unified icon definitions
    const unifiedCaptureIcons = {
        place: { icon: 'bi-geo-alt', emoji: 'üìç' },
        book: { icon: 'bi-book', emoji: 'üìö' },
        watched: { icon: 'bi-film', emoji: 'üé¨' },
        travel: { icon: 'bi-airplane', emoji: '‚úàÔ∏è' },
        workout: { icon: 'bi-activity', emoji: 'üí™' },
        meal: { icon: 'bi-egg-fried', emoji: 'üçΩÔ∏è' },
        person: { icon: 'bi-person', emoji: 'üë§' },
        dream: { icon: 'bi-cloud-moon', emoji: 'üåô' },
        gratitude: { icon: 'bi-heart', emoji: '‚ù§Ô∏è' },
        pain: { icon: 'bi-bandaid', emoji: 'ü©π' },
        intimacy: { icon: 'bi-heart-fill', emoji: 'üíï' },
        cycle: { icon: 'bi-calendar-heart', emoji: 'üî¥' },
    };

    // Unified modal references
    const unifiedCaptureFormModal = new bootstrap.Modal(document.getElementById('captureFormModal'));
    const unifiedHybridPickerModal = new bootstrap.Modal(document.getElementById('hybridPickerModal'));
    let unifiedCurrentCaptureType = null;
    let unifiedCurrentCommand = null;

    // Helper to render form field HTML
    function renderCaptureFieldHtml(field, prefillValue = '') {
        if (field.type === 'text') {
            return `<input type="text" class="form-control form-control-sm" name="${field.name}"
                    ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}"
                    value="${prefillValue}">`;
        } else if (field.type === 'number') {
            return `<input type="number" class="form-control form-control-sm" name="${field.name}"
                    ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}" min="0"
                    value="${prefillValue}">`;
        } else if (field.type === 'select') {
            const optionsHtml = field.options.map(([val, label]) =>
                `<option value="${val}" ${prefillValue === val ? 'selected' : ''}>${label}</option>`
            ).join('');
            return `<select class="form-select form-select-sm" name="${field.name}" ${field.required ? 'required' : ''}>
                        <option value="" ${!prefillValue ? 'selected' : ''}>Select...</option>
                        ${optionsHtml}
                     </select>`;
        } else if (field.type === 'rating') {
            return `
                <div class="rating-input" data-name="${field.name}">
                    ${[1,2,3,4,5].map(n => `
                        <i class="bi bi-star rating-star" data-value="${n}" style="cursor: pointer; font-size: 1.25rem; color: #d1d5db;"></i>
                    `).join('')}
                    <input type="hidden" name="${field.name}" value="">
                </div>
            `;
        } else if (field.type === 'range') {
            const min = field.min || 1;
            const max = field.max || 10;
            const defaultVal = field.defaultVal || Math.round((min + max) / 2);
            return `
                <div class="range-input d-flex align-items-center gap-2">
                    <span class="text-muted small">${min}</span>
                    <input type="range" class="form-range flex-grow-1" name="${field.name}"
                           min="${min}" max="${max}" value="${defaultVal}"
                           oninput="this.nextElementSibling.textContent = this.value"
                           ${field.required ? 'required' : ''}>
                    <span class="badge bg-primary range-value">${defaultVal}</span>
                    <span class="text-muted small">${max}</span>
                </div>
            `;
        } else if (field.type === 'textarea') {
            return `<textarea class="form-control form-control-sm" name="${field.name}" rows="2"
                    ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}"></textarea>`;
        }
        return `<input type="text" class="form-control form-control-sm" name="${field.name}">`;
    }

    // Helper to set up rating star click handlers
    function setupRatingStars(container) {
        container.querySelectorAll('.rating-input').forEach(ratingDiv => {
            const stars = ratingDiv.querySelectorAll('.rating-star');
            const hiddenInput = ratingDiv.querySelector('input[type="hidden"]');

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = parseInt(star.dataset.value);
                    hiddenInput.value = value;
                    stars.forEach((s, idx) => {
                        s.classList.toggle('bi-star-fill', idx < value);
                        s.classList.toggle('bi-star', idx >= value);
                        s.style.color = idx < value ? '#fbbf24' : '#d1d5db';
                    });
                });

                star.addEventListener('mouseenter', () => {
                    const value = parseInt(star.dataset.value);
                    stars.forEach((s, idx) => {
                        s.style.color = idx < value ? '#fbbf24' : '#d1d5db';
                    });
                });

                star.addEventListener('mouseleave', () => {
                    const currentValue = parseInt(hiddenInput.value) || 0;
                    stars.forEach((s, idx) => {
                        s.style.color = idx < currentValue ? '#fbbf24' : '#d1d5db';
                    });
                });
            });
        });
    }

    // Unified showCaptureForm - works for both editors
    function showUnifiedCaptureForm(cmd, prefillData = null) {
        const captureType = typeof cmd === 'string' ? cmd : cmd.captureType;
        unifiedCurrentCaptureType = captureType;
        unifiedCurrentCommand = typeof cmd === 'object' ? cmd : { captureType: captureType, name: captureType.charAt(0).toUpperCase() + captureType.slice(1) };

        const fields = unifiedCaptureFields[captureType] || [];
        const iconData = unifiedCaptureIcons[captureType] || { icon: 'bi-plus-circle', emoji: 'üìå' };

        // Set title
        const titleEl = document.getElementById('captureFormTitle');
        const iconEl = document.getElementById('captureFormIcon');

        if (unifiedCurrentCommand.is_emoji_icon) {
            iconEl.className = 'me-2';
            iconEl.textContent = unifiedCurrentCommand.icon;
        } else {
            iconEl.className = `bi ${iconData.icon} me-2`;
            iconEl.textContent = '';
        }
        titleEl.textContent = unifiedCurrentCommand.name || captureType.charAt(0).toUpperCase() + captureType.slice(1);

        // Render fields
        const fieldsContainer = document.getElementById('captureFormFields');
        if (fields.length === 0) {
            fieldsContainer.innerHTML = `<p class="text-muted mb-0">This will mark this entry as a ${unifiedCurrentCommand.name?.toLowerCase() || captureType} entry.</p>`;
        } else {
            fieldsContainer.innerHTML = fields.map(field => {
                const prefillValue = prefillData ? (prefillData[field.name] || '') : '';
                return `
                    <div class="mb-3">
                        <label class="form-label small fw-medium">${field.label}${field.required ? ' <span class="text-danger">*</span>' : ''}</label>
                        ${renderCaptureFieldHtml(field, prefillValue)}
                    </div>
                `;
            }).join('');

            // Set up rating stars after a brief delay
            setTimeout(() => setupRatingStars(fieldsContainer), 50);
        }

        unifiedCaptureFormModal.show();
    }

    // Unified hybrid picker - shows existing items + add new option
    async function showUnifiedHybridPicker(cmd) {
        unifiedCurrentCommand = cmd;
        const captureType = cmd.captureType;

        try {
            const response = await fetch(`/journal/api/active-captures/?type=${captureType}`);
            const data = await response.json();

            const modalEl = document.getElementById('hybridPickerModal');
            const list = document.getElementById('hybridPickerList');
            const title = document.getElementById('hybridPickerTitle');

            title.textContent = `Select ${cmd.name}`;

            let html = '';

            // Add "Create New" option first
            html += `
                <div class="hybrid-picker-item create-new" data-action="create-new">
                    <div class="d-flex align-items-center">
                        <div class="picker-icon bg-primary text-white me-3">
                            <i class="bi bi-plus-lg"></i>
                        </div>
                        <div>
                            <div class="fw-medium">Add New ${cmd.name}</div>
                            <small class="text-muted">Create a new entry</small>
                        </div>
                    </div>
                </div>
            `;

            // Add existing items
            if (data.items && data.items.length > 0) {
                html += '<div class="hybrid-picker-divider">Currently Active</div>';
                data.items.forEach(item => {
                    // Use item.subtitle if returned from API (person type), otherwise calculate
                    const subtitle = item.subtitle || (captureType === 'book'
                        ? (item.author ? `by ${item.author}` : '') + (item.page ? ` ‚Ä¢ Page ${item.page}` : '')
                        : (item.type === 'show' ? 'TV Show' : item.type || ''));

                    const escapedItem = JSON.stringify(item).replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                    html += `
                        <div class="hybrid-picker-item" data-item="${escapedItem}">
                            <div class="d-flex align-items-center">
                                <div class="picker-icon bg-light me-3">
                                    <i class="bi ${cmd.icon}"></i>
                                </div>
                                <div>
                                    <div class="fw-medium">${item.title || item.name}</div>
                                    ${subtitle ? `<small class="text-muted">${subtitle}</small>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            list.innerHTML = html;

            // Add click handler for "Create New"
            list.querySelector('[data-action="create-new"]').addEventListener('click', () => {
                unifiedHybridPickerModal.hide();
                showUnifiedCaptureForm(cmd);
            });

            // Add click handlers for existing items
            list.querySelectorAll('.hybrid-picker-item[data-item]').forEach(el => {
                el.addEventListener('click', () => {
                    const itemData = JSON.parse(el.dataset.item.replace(/&#39;/g, "'").replace(/&quot;/g, '"'));
                    unifiedHybridPickerModal.hide();
                    // Pre-fill the capture form with existing item data
                    showUnifiedCaptureForm(cmd, itemData.data || itemData);
                });
            });

            unifiedHybridPickerModal.show();
        } catch (err) {
            console.error('Failed to fetch active captures:', err);
            // Fall back to just showing the capture form
            showUnifiedCaptureForm(cmd);
        }
    }

    // Unified capture form submit handler
    document.getElementById('captureForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const captureData = {};
        for (const [key, value] of formData.entries()) {
            if (value) captureData[key] = value;
        }

        unifiedCaptureFormModal.hide();

        // Ensure entry exists
        let pk = entryPk;
        if (!pk) {
            pk = await quickSaveEntryForCapture();
            if (pk) entryPk = pk;
        }

        if (!pk) {
            alert('Failed to save entry. Please try again.');
            return;
        }

        // Save the capture
        try {
            const response = await fetch('/journal/api/capture/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entry_pk: pk,
                    capture_type: unifiedCurrentCaptureType,
                    data: captureData
                })
            });

            const data = await response.json();
            if (data.success) {
                // Add capture to visual list
                if (typeof addCaptureToList === 'function' && data.capture) {
                    addCaptureToList(data.capture);
                }

                // Insert into editor (works for both Quill and EasyMDE)
                const iconData = unifiedCaptureIcons[unifiedCurrentCaptureType] || { emoji: 'üìå' };
                const displayText = captureData.name || captureData.title || captureData.destination || captureData.activity || captureData.dish || captureData.what || 'Item';
                insertCaptureIntoEditor(iconData.emoji, displayText);
            } else {
                alert(data.error || 'Failed to save capture');
            }
        } catch (err) {
            console.error('Failed to save capture:', err);
            alert('Failed to save capture. Please try again.');
        }
    });

    // Quick save for captures (shared)
    async function quickSaveEntryForCapture() {
        const titleInput = document.getElementById('id_title');
        const dateInput = document.getElementById('id_entry_date');

        // Get content from whichever editor is active
        let content = '';
        if (typeof quill !== 'undefined') {
            content = quill.root.innerHTML;
        } else if (typeof easyMDE !== 'undefined') {
            content = easyMDE.value();
        }

        const formData = new FormData();
        formData.append('title', titleInput.value || 'Untitled');
        formData.append('entry_date', dateInput.value);
        formData.append('content', content);
        if (entryPk) {
            formData.append('entry_pk', entryPk);
        }

        try {
            const response = await fetch('/journal/api/quick-save/', {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    entryPk = data.entry_pk;
                    return data.entry_pk;
                }
            }
        } catch (err) {
            console.error('Quick save failed:', err);
        }
        return null;
    }

    // Placeholder for insertCaptureIntoEditor - will be defined by each editor
    // This gets overwritten by Quill or EasyMDE specific implementation
    let insertCaptureIntoEditor = function(emoji, text) {
        console.log('Insert capture:', emoji, text);
    };

    // Add capture to visual list (shared)
    function addCaptureToList(capture) {
        const list = document.getElementById('capturesList');
        if (!list) return;

        const pill = document.createElement('div');
        pill.className = `capture-pill-sm ${capture.type}`;
        pill.dataset.id = capture.id;
        pill.title = capture.display_text;
        pill.innerHTML = `
            <i class="bi ${capture.icon}"></i>
            <span class="capture-text">${capture.display_text}</span>
            <span class="capture-delete" onclick="event.stopPropagation(); deleteCapture(${capture.id})" title="Remove">
                <i class="bi bi-x"></i>
            </span>
        `;

        list.appendChild(pill);
    }

    // Delete capture (shared)
    window.deleteCapture = async function(captureId) {
        if (!confirm('Remove this tracked item?')) return;

        try {
            const response = await fetch(`/journal/capture/${captureId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const pill = document.querySelector(`.capture-pill-sm[data-id="${captureId}"]`) ||
                             document.querySelector(`.capture-pill[data-id="${captureId}"]`);
                if (pill) pill.remove();
            } else {
                alert('Failed to delete capture');
            }
        } catch (err) {
            console.error('Failed to delete capture:', err);
            alert('Failed to delete capture');
        }
    };

    {% if editor_preference == 'rich_text' %}
    // Initialize Quill with custom toolbar
    const quill = new Quill('#quill-editor', {
        theme: 'snow',
        placeholder: 'Start writing your thoughts...',
        modules: {
            toolbar: {
                container: '#quill-toolbar',
                handlers: {
                    'image': function() {
                        selectLocalImage();
                    }
                }
            }
        }
    });

    // =================================================================
    // CUSTOM TOOLBAR BUTTON HANDLERS
    // =================================================================

    // Dream button - insert dream block
    document.getElementById('btn-dream').addEventListener('click', function() {
        const range = quill.getSelection(true);
        const index = range ? range.index : quill.getLength();
        quill.insertText(index, '\n');
        quill.insertText(index + 1, '{dream}\nDescribe your dream here...\n{/dream}');
        quill.insertText(index + 1 + '{dream}\nDescribe your dream here...\n{/dream}'.length, '\n');
        quill.setSelection(index + 9, 26); // Select placeholder text
    });

    // Gratitude button - insert gratitude block
    document.getElementById('btn-gratitude').addEventListener('click', function() {
        const range = quill.getSelection(true);
        const index = range ? range.index : quill.getLength();
        quill.insertText(index, '\n');
        quill.insertText(index + 1, '{gratitude}\nWhat are you grateful for today?\n{/gratitude}');
        quill.insertText(index + 1 + '{gratitude}\nWhat are you grateful for today?\n{/gratitude}'.length, '\n');
        quill.setSelection(index + 13, 32); // Select placeholder text
    });

    // Quill-specific: Define how to insert captures into editor
    insertCaptureIntoEditor = function(emoji, text) {
        const range = quill.getSelection(true);
        const index = range ? range.index : quill.getLength();
        quill.insertText(index, `${emoji} ${text} `);
        quill.focus();
    };

    // Person button - open person picker modal (uses shared quickPickerModal)
    document.getElementById('btn-person').addEventListener('click', function() {
        showQuickPicker('person');
    });

    // Place button - open place capture form (uses unified captureFormModal)
    document.getElementById('btn-place').addEventListener('click', function() {
        showUnifiedCaptureForm({ name: 'Place', icon: 'bi-geo-alt', captureType: 'place' });
    });

    // Book button - open hybrid picker (shows existing books + create new)
    document.getElementById('btn-book').addEventListener('click', function() {
        showUnifiedHybridPicker({ name: 'Book', icon: 'bi-book', captureType: 'book' });
    });

    // Watched button - open hybrid picker (shows existing shows + create new)
    document.getElementById('btn-watched').addEventListener('click', function() {
        showUnifiedHybridPicker({ name: 'Watched', icon: 'bi-film', captureType: 'watched' });
    });

    // Travel button - open travel form (uses unified captureFormModal)
    document.getElementById('btn-travel').addEventListener('click', function() {
        showUnifiedCaptureForm({ name: 'Travel', icon: 'bi-airplane', captureType: 'travel' });
    });

    // Workout button - open workout form (uses unified captureFormModal)
    document.getElementById('btn-workout').addEventListener('click', function() {
        showUnifiedCaptureForm({ name: 'Workout', icon: 'bi-activity', captureType: 'workout' });
    });

    // Meal button - open meal form (uses unified captureFormModal)
    document.getElementById('btn-meal').addEventListener('click', function() {
        showUnifiedCaptureForm({ name: 'Meal', icon: 'bi-egg-fried', captureType: 'meal' });
    });

    // Goal button - open goal picker modal (uses shared goalHabitPickerModal)
    document.getElementById('btn-goal').addEventListener('click', function() {
        showGoalPicker();
    });

    // Habit button - open habit picker modal (uses shared goalHabitPickerModal)
    document.getElementById('btn-habit').addEventListener('click', function() {
        showHabitPicker();
    });

    // POV button - open POV modal (uses shared povModal)
    document.getElementById('btn-pov').addEventListener('click', function() {
        openQuillPovModal();
    });

    // =================================================================
    // QUILL-SPECIFIC PICKER FUNCTIONS (using shared modals)
    // =================================================================

    // Quick picker config for Quill
    const quickPickerConfig = {
        person: {
            title: 'Tag a Person',
            icon: 'bi-person',
            searchUrl: '/journal/api/people-search/',
            createUrl: '/journal/api/people-create/',
            linkPath: '/analytics/people/',
            mentionUrl: '/journal/api/track-mention/',
            emptyText: 'No people found'
        },
        place: {
            title: 'Tag a Place',
            icon: 'bi-geo-alt',
            searchUrl: '/journal/api/places-search/',
            createUrl: '/journal/api/places-create/',
            linkPath: '/analytics/places/',
            emptyText: 'No places found'
        }
    };

    let currentPickerType = null;
    let pickerItems = [];
    let pickerSelectedIndex = 0;
    const quickPickerModal = new bootstrap.Modal(document.getElementById('quickPickerModal'));

    function showQuickPicker(type) {
        currentPickerType = type;
        const config = quickPickerConfig[type];

        document.getElementById('quickPickerTitle').textContent = config.title;
        document.getElementById('quickPickerIcon').className = `bi ${config.icon} me-2`;
        document.getElementById('quickPickerSearch').value = '';
        document.getElementById('quickPickerCreate').classList.add('d-none');

        loadPickerItems('');
        quickPickerModal.show();

        setTimeout(() => {
            document.getElementById('quickPickerSearch').focus();
        }, 200);
    }

    async function loadPickerItems(query) {
        const config = quickPickerConfig[currentPickerType];
        const listEl = document.getElementById('quickPickerList');

        try {
            const resp = await fetch(`${config.searchUrl}?q=${encodeURIComponent(query)}`);
            const data = await resp.json();
            pickerItems = data.items || [];
            pickerSelectedIndex = 0;

            if (pickerItems.length === 0) {
                listEl.innerHTML = `<div class="quick-picker-empty">${config.emptyText}</div>`;
            } else {
                listEl.innerHTML = pickerItems.map((item, idx) => `
                    <div class="quick-picker-item ${idx === 0 ? 'selected' : ''}" data-id="${item.id}" data-name="${item.name}">
                        <div>
                            <div class="quick-picker-name">${item.name}</div>
                            ${item.relationship ? `<div class="quick-picker-meta">${item.relationship}</div>` : ''}
                        </div>
                    </div>
                `).join('');

                listEl.querySelectorAll('.quick-picker-item').forEach(item => {
                    item.addEventListener('click', () => {
                        selectPickerItem(parseInt(item.dataset.id), item.dataset.name);
                    });
                });
            }

            const createEl = document.getElementById('quickPickerCreate');
            if (query.trim() && !pickerItems.some(p => p.name.toLowerCase() === query.toLowerCase())) {
                document.getElementById('quickPickerNewName').textContent = query;
                createEl.classList.remove('d-none');
            } else {
                createEl.classList.add('d-none');
            }
        } catch (e) {
            console.error('Failed to load picker items:', e);
        }
    }

    function selectPickerItem(id, name) {
        const config = quickPickerConfig[currentPickerType];
        quickPickerModal.hide();

        // Insert into Quill with link formatting
        const range = quill.getSelection(true);
        const index = range ? range.index : quill.getLength();
        quill.insertText(index, `@${name} `, { 'link': `${config.linkPath}${id}/` });
        quill.focus();

        if (config.mentionUrl) {
            trackMentionInBackground(config.mentionUrl, id);
        }
    }

    async function trackMentionInBackground(mentionUrl, personId) {
        try {
            let pk = entryPk;
            if (!pk) {
                pk = await quickSaveEntryForCapture();
                if (pk) entryPk = pk;
            }
            if (pk) {
                await fetch(mentionUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ person_id: personId, entry_id: pk })
                });
            }
        } catch (e) {
            console.error('Failed to track mention:', e);
        }
    }

    async function createPickerItem(name) {
        const config = quickPickerConfig[currentPickerType];
        try {
            const resp = await fetch(config.createUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name })
            });
            const data = await resp.json();
            if (data.id) {
                selectPickerItem(data.id, data.name);
            }
        } catch (e) {
            console.error('Failed to create item:', e);
        }
    }

    // Quick picker search input handler
    document.getElementById('quickPickerSearch').addEventListener('input', function(e) {
        loadPickerItems(e.target.value);
    });

    document.getElementById('quickPickerSearch').addEventListener('keydown', function(e) {
        const items = document.querySelectorAll('.quick-picker-item');
        if (e.key === 'ArrowDown' && items.length > 0) {
            e.preventDefault();
            pickerSelectedIndex = (pickerSelectedIndex + 1) % items.length;
            items.forEach((item, idx) => item.classList.toggle('selected', idx === pickerSelectedIndex));
        } else if (e.key === 'ArrowUp' && items.length > 0) {
            e.preventDefault();
            pickerSelectedIndex = (pickerSelectedIndex - 1 + items.length) % items.length;
            items.forEach((item, idx) => item.classList.toggle('selected', idx === pickerSelectedIndex));
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (items.length > 0 && items[pickerSelectedIndex]) {
                const item = items[pickerSelectedIndex];
                selectPickerItem(parseInt(item.dataset.id), item.dataset.name);
            } else if (this.value.trim()) {
                createPickerItem(this.value.trim());
            }
        }
    });

    document.querySelector('#quickPickerCreate button').addEventListener('click', function() {
        const name = document.getElementById('quickPickerSearch').value.trim();
        if (name) createPickerItem(name);
    });

    // =================================================================
    // GOAL/HABIT PICKER FUNCTIONS FOR QUILL
    // =================================================================

    const goalHabitPickerModal = new bootstrap.Modal(document.getElementById('goalHabitPickerModal'));

    function showGoalPicker() {
        document.getElementById('goalHabitPickerTitle').textContent = 'Link to Goal';
        document.getElementById('goalHabitPickerIcon').className = 'bi bi-bullseye me-2';

        const listContainer = document.getElementById('goalHabitPickerList');
        listContainer.innerHTML = '<p class="text-muted text-center">Loading goals...</p>';

        const searchInput = document.getElementById('goalHabitPickerSearch');
        searchInput.value = '';
        searchInput.placeholder = 'Search goals...';

        loadGoals();
        goalHabitPickerModal.show();

        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        newSearchInput.addEventListener('input', function() {
            loadGoals(this.value);
        });

        setTimeout(() => newSearchInput.focus(), 200);
    }

    function loadGoals(query = '') {
        fetch(`/journal/api/goals-search/?q=${encodeURIComponent(query)}`, {
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(r => r.json())
        .then(data => {
            const list = document.getElementById('goalHabitPickerList');
            const goals = data.goals || [];

            if (goals.length === 0) {
                list.innerHTML = '<p class="text-muted text-center">No goals found</p>';
                return;
            }

            list.innerHTML = goals.map(g => `
                <div class="picker-item-goal" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; cursor: pointer;" onclick="selectGoal(${g.id}, '${g.title.replace(/'/g, "\\'")}')">
                    <div class="d-flex align-items-center">
                        <div class="picker-item-icon" style="background: ${g.color}; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; margin-right: 0.75rem;">
                            <i class="bi ${g.icon}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="picker-item-name fw-medium">${g.title}</div>
                            <div class="picker-item-meta text-muted small">${Math.round(g.progress)}% complete</div>
                        </div>
                    </div>
                </div>
            `).join('');
        });
    }

    window.selectGoal = function(id, title) {
        goalHabitPickerModal.hide();

        const linkGoalToEntry = (pk) => {
            fetch('/journal/api/link-goal/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ entry_pk: pk, goal_id: id })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const range = quill.getSelection(true);
                    const index = range ? range.index : quill.getLength();
                    quill.insertText(index, `üéØ ${title} `, { 'link': `/goals/${id}/` });
                    quill.focus();
                } else {
                    alert(data.error || 'Failed to link goal');
                }
            })
            .catch(() => alert('Failed to link goal'));
        };

        if (!entryPk) {
            quickSaveEntryForCapture().then(pk => {
                if (pk) linkGoalToEntry(pk);
            });
        } else {
            linkGoalToEntry(entryPk);
        }
    };

    function showHabitPicker() {
        document.getElementById('goalHabitPickerTitle').textContent = 'Log a Habit';
        document.getElementById('goalHabitPickerIcon').className = 'bi bi-repeat me-2';

        const listContainer = document.getElementById('goalHabitPickerList');
        listContainer.innerHTML = '<p class="text-muted text-center">Loading habits...</p>';

        const searchInput = document.getElementById('goalHabitPickerSearch');
        searchInput.value = '';
        searchInput.placeholder = 'Search habits...';

        loadHabits();
        goalHabitPickerModal.show();

        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        newSearchInput.addEventListener('input', function() {
            loadHabits(this.value);
        });

        setTimeout(() => newSearchInput.focus(), 200);
    }

    function loadHabits(query = '') {
        fetch(`/journal/api/habits-search/?q=${encodeURIComponent(query)}`, {
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(r => r.json())
        .then(data => {
            const list = document.getElementById('goalHabitPickerList');
            const habits = data.habits || [];

            if (habits.length === 0) {
                list.innerHTML = '<p class="text-muted text-center">No habits found</p>';
                return;
            }

            list.innerHTML = habits.map(h => `
                <div class="picker-item" onclick="selectHabit(${h.id}, '${h.name.replace(/'/g, "\\'")}')">
                    <div class="picker-item-icon" style="background: ${h.color}">
                        <i class="bi ${h.icon}"></i>
                    </div>
                    <div>
                        <div class="picker-item-name">${h.name}</div>
                        <div class="picker-item-meta">${h.current_streak} day streak</div>
                    </div>
                </div>
            `).join('');
        });
    }

    window.selectHabit = function(id, name) {
        goalHabitPickerModal.hide();

        const linkHabitToEntry = (pk) => {
            fetch('/journal/api/link-habit/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ entry_pk: pk, habit_id: id, create_checkin: true })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const range = quill.getSelection(true);
                    const index = range ? range.index : quill.getLength();
                    const text = data.checkin_created ? `‚úÖ ${name} (checked in!) ` : `‚úÖ ${name} `;
                    quill.insertText(index, text);
                    quill.focus();
                } else {
                    alert(data.error || 'Failed to link habit');
                }
            })
            .catch(() => alert('Failed to link habit'));
        };

        if (!entryPk) {
            quickSaveEntryForCapture().then(pk => {
                if (pk) linkHabitToEntry(pk);
            });
        } else {
            linkHabitToEntry(entryPk);
        }
    };

    // Helper function to save entry before captures
    async function quickSaveEntryForCapture() {
        const formData = new FormData();
        formData.append('title', document.getElementById('id_title').value || 'Untitled');
        formData.append('entry_date', document.querySelector('input[name="entry_date"]').value);
        formData.append('mood', document.querySelector('select[name="mood"]').value);
        formData.append('energy', document.querySelector('select[name="energy"]').value);
        formData.append('city', document.getElementById('id_city').value || '');
        formData.append('country_code', document.getElementById('id_country_code').value || '');
        formData.append('content', document.getElementById('id_content').value);

        try {
            const response = await fetch('/journal/api/quick-save/', {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                entryPk = data.entry_pk;
                document.getElementById('entry-form').action = `/journal/${data.entry_pk}/edit/`;
                return data.entry_pk;
            }
        } catch (e) {
            console.error('Failed to quick save:', e);
        }
        return null;
    }

    // POV Modal for Quill
    async function openQuillPovModal() {
        const existingModal = document.getElementById('povModal');
        if (existingModal) {
            // Use the existing POV modal
            const friendSelect = document.getElementById('povFriendSelect');
            const messageInput = document.getElementById('povMessage');

            // Fetch friends list
            try {
                const response = await fetch('/accounts/api/friends/');
                const data = await response.json();
                const friends = data.friends || data || [];

                friendSelect.innerHTML = '<option value="">Select a friend...</option>';
                friends.forEach(friend => {
                    friendSelect.innerHTML += `<option value="${friend.id}">${friend.display_name || friend.username}</option>`;
                });
            } catch (error) {
                console.error('Error fetching friends:', error);
            }

            messageInput.value = '';
            const modal = new bootstrap.Modal(existingModal);
            modal.show();

            // Override the submit button for Quill
            const submitBtn = document.getElementById('povSubmitBtn');
            submitBtn.onclick = function() {
                const friendId = friendSelect.value;
                const message = messageInput.value.trim();

                if (!friendId || !message) {
                    alert('Please select a friend and write a message');
                    return;
                }

                // Insert POV block into Quill
                const range = quill.getSelection(true);
                const index = range ? range.index : quill.getLength();
                const friendName = friendSelect.options[friendSelect.selectedIndex].text;
                quill.insertText(index, `\n{pov} @${friendName}\n${message}\n{/pov}\n`);

                bootstrap.Modal.getInstance(existingModal).hide();
                quill.focus();
            };
        }
    }

    // Custom image upload handler for Quill
    function selectLocalImage() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = async function() {
            const file = input.files[0];
            if (file) {
                await uploadImageToQuill(file);
            }
        };
    }

    async function uploadImageToQuill(file) {
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/journal/api/upload-image/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const data = await response.json();
            if (data.success && data.url) {
                // Insert image at cursor position
                const range = quill.getSelection(true);
                quill.insertEmbed(range.index, 'image', data.url);
                quill.setSelection(range.index + 1);
            } else {
                alert('Failed to upload image: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Image upload error:', error);
            alert('Failed to upload image');
        }
    }

    // Handle paste events for images in Quill
    quill.root.addEventListener('paste', async function(e) {
        const items = e.clipboardData?.items;
        if (!items) return;

        for (let item of items) {
            if (item.type.startsWith('image/')) {
                e.preventDefault();
                e.stopPropagation();
                const file = item.getAsFile();
                if (file) {
                    await uploadImageToQuill(file);
                }
                return;
            }
        }
    });

    // Handle drag and drop for images in Quill
    quill.root.addEventListener('drop', async function(e) {
        const files = e.dataTransfer?.files;
        if (!files || files.length === 0) return;

        for (let file of files) {
            if (file.type.startsWith('image/')) {
                e.preventDefault();
                e.stopPropagation();
                await uploadImageToQuill(file);
                return;
            }
        }
    });

    // Set initial content
    const initialContent = document.getElementById('id_content').value;
    if (initialContent) {
        quill.root.innerHTML = initialContent;
    }

    // =================================================================
    // IMAGE RESIZE FUNCTIONALITY
    // =================================================================
    let selectedImage = null;
    let resizeOverlay = null;
    let isResizing = false;
    let startX, startY, startWidth, startHeight;

    // Create resize overlay with handles
    function createResizeOverlay() {
        if (resizeOverlay) return resizeOverlay;

        resizeOverlay = document.createElement('div');
        resizeOverlay.className = 'quill-image-resize-overlay';
        resizeOverlay.innerHTML = `
            <div class="resize-handle resize-handle-nw" data-handle="nw"></div>
            <div class="resize-handle resize-handle-ne" data-handle="ne"></div>
            <div class="resize-handle resize-handle-sw" data-handle="sw"></div>
            <div class="resize-handle resize-handle-se" data-handle="se"></div>
            <div class="resize-handle resize-handle-n" data-handle="n"></div>
            <div class="resize-handle resize-handle-s" data-handle="s"></div>
            <div class="resize-handle resize-handle-e" data-handle="e"></div>
            <div class="resize-handle resize-handle-w" data-handle="w"></div>
            <div class="resize-info"></div>
        `;
        document.body.appendChild(resizeOverlay);
        return resizeOverlay;
    }

    // Position overlay over image
    function positionOverlay(img) {
        const rect = img.getBoundingClientRect();
        resizeOverlay.style.left = rect.left + window.scrollX + 'px';
        resizeOverlay.style.top = rect.top + window.scrollY + 'px';
        resizeOverlay.style.width = rect.width + 'px';
        resizeOverlay.style.height = rect.height + 'px';
        resizeOverlay.style.display = 'block';

        // Update size info
        const info = resizeOverlay.querySelector('.resize-info');
        info.textContent = `${Math.round(img.width)} √ó ${Math.round(img.height)}`;
    }

    // Hide overlay
    function hideOverlay() {
        if (resizeOverlay) {
            resizeOverlay.style.display = 'none';
        }
        selectedImage = null;
    }

    // Handle image click in Quill
    quill.root.addEventListener('click', function(e) {
        if (e.target.tagName === 'IMG') {
            e.preventDefault();
            selectedImage = e.target;
            createResizeOverlay();
            positionOverlay(selectedImage);
        } else if (!e.target.closest('.quill-image-resize-overlay')) {
            hideOverlay();
        }
    });

    // Handle resize start
    document.addEventListener('mousedown', function(e) {
        const handle = e.target.closest('.resize-handle');
        if (handle && selectedImage) {
            e.preventDefault();
            isResizing = true;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = selectedImage.width;
            startHeight = selectedImage.height;
            resizeOverlay.dataset.handle = handle.dataset.handle;
            document.body.style.cursor = getComputedStyle(handle).cursor;
        }
    });

    // Handle resize move
    document.addEventListener('mousemove', function(e) {
        if (!isResizing || !selectedImage) return;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        const handle = resizeOverlay.dataset.handle;
        const aspectRatio = startWidth / startHeight;

        let newWidth = startWidth;
        let newHeight = startHeight;

        // Calculate new dimensions based on handle
        if (handle.includes('e')) newWidth = startWidth + dx;
        if (handle.includes('w')) newWidth = startWidth - dx;
        if (handle.includes('s')) newHeight = startHeight + dy;
        if (handle.includes('n')) newHeight = startHeight - dy;

        // Corner handles maintain aspect ratio
        if (handle === 'se' || handle === 'nw') {
            newHeight = newWidth / aspectRatio;
        } else if (handle === 'sw' || handle === 'ne') {
            newHeight = newWidth / aspectRatio;
        }

        // Minimum size
        newWidth = Math.max(50, newWidth);
        newHeight = Math.max(50, newHeight);

        // Apply new size
        selectedImage.style.width = newWidth + 'px';
        selectedImage.style.height = 'auto';
        selectedImage.setAttribute('width', Math.round(newWidth));

        // Reposition overlay
        positionOverlay(selectedImage);
    });

    // Handle resize end
    document.addEventListener('mouseup', function() {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            // Trigger text-change to save
            quill.update();
        }
    });

    // Reposition overlay on scroll
    quill.root.addEventListener('scroll', function() {
        if (selectedImage && resizeOverlay.style.display !== 'none') {
            positionOverlay(selectedImage);
        }
    });

    // Hide overlay when clicking outside editor
    document.addEventListener('click', function(e) {
        if (!quill.root.contains(e.target) && !e.target.closest('.quill-image-resize-overlay')) {
            hideOverlay();
        }
    });

    // Sync to hidden textarea
    quill.on('text-change', function() {
        const content = quill.root.innerHTML;
        document.getElementById('id_content').value = content;
        updateWordCount(quill.getText());
        autoSave(content);
    });

    // Initial word count
    updateWordCount(quill.getText());

    // =================================================================
    // SLASH COMMANDS FOR QUILL
    // =================================================================
    let quillSlashStartIndex = null;
    let quillSlashEndIndex = null;  // Track end position for deletion

    quill.on('text-change', function(delta, oldDelta, source) {
        if (source !== 'user') return;

        const selection = quill.getSelection();
        if (!selection) return;

        const cursorPos = selection.index;
        const text = quill.getText();

        // Check if user just typed a "/"
        if (delta.ops) {
            const lastOp = delta.ops[delta.ops.length - 1];
            if (lastOp.insert === '/') {
                // Check if "/" is at start or after whitespace
                const charBefore = cursorPos > 1 ? text[cursorPos - 2] : '';
                if (cursorPos === 1 || !charBefore || /\s/.test(charBefore)) {
                    quillSlashStartIndex = cursorPos - 1;
                    quillSlashEndIndex = cursorPos;
                    renderSlashMenu();
                    positionMenuForQuill();
                }
            }
        }

        // Filter menu as user types and track end position
        if (slashMenu.classList.contains('show') && quillSlashStartIndex !== null) {
            const typed = text.substring(quillSlashStartIndex, cursorPos);
            if (typed.startsWith('/') && !/\s/.test(typed)) {
                quillSlashEndIndex = cursorPos;  // Update end position as user types
                renderSlashMenu(typed);
            } else {
                hideQuillMenu();
            }
        }
    });

    function positionMenuForQuill() {
        const selection = quill.getSelection();
        if (!selection) return;

        const bounds = quill.getBounds(selection.index);
        const editorRect = quill.container.getBoundingClientRect();

        slashMenu.style.left = (editorRect.left + bounds.left) + 'px';
        slashMenu.style.top = (editorRect.top + bounds.bottom + 5) + 'px';
        slashMenu.classList.add('show');
    }

    function hideQuillMenu() {
        slashMenu.classList.remove('show');
        quillSlashStartIndex = null;
        quillSlashEndIndex = null;
    }

    function selectQuillCommand(cmd) {
        currentCommand = cmd;

        // Remove the slash command text from editor using stored positions
        // (quill.getSelection() may return null if editor lost focus from menu click)
        if (quillSlashStartIndex !== null && quillSlashEndIndex !== null) {
            const deleteLength = quillSlashEndIndex - quillSlashStartIndex;
            if (deleteLength > 0) {
                quill.deleteText(quillSlashStartIndex, deleteLength);
            }
        }

        hideQuillMenu();

        // Handle special commands (same logic as EasyMDE)
        if (cmd.special === 'quick_picker') {
            showQuickPicker(cmd.pickerType);
        } else if (cmd.special === 'goal_picker') {
            showGoalPicker();
        } else if (cmd.special === 'habit_picker') {
            showHabitPicker();
        } else if (cmd.special === 'capture_form') {
            showUnifiedCaptureForm(cmd);
        } else if (cmd.special === 'block_insert') {
            insertQuillBlock(cmd);
        } else if (cmd.special === 'hybrid_picker') {
            showUnifiedHybridPicker(cmd);
        }
    }

    function insertQuillBlock(cmd) {
        const selection = quill.getSelection();
        const index = selection ? selection.index : quill.getLength();

        // Insert block text for Quill - just the tags, cursor in between
        const blockType = cmd.blockType;
        const blockStart = `\n{${blockType}}\n`;
        const blockEnd = `\n{/${blockType}}\n`;

        quill.insertText(index, blockStart + blockEnd);
        // Position cursor inside the block (after the opening tag and newline)
        quill.setSelection(index + blockStart.length, 0);
    }

    // Keyboard navigation for Quill slash menu
    quill.root.addEventListener('keydown', function(e) {
        if (!slashMenu.classList.contains('show')) return;

        const items = slashMenu.querySelectorAll('.slash-command-item');
        const filtered = Array.from(items).map(item => {
            const cmd = item.dataset.command;
            return slashCommands.find(c => c.command === cmd);
        });

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedCommandIndex = (selectedCommandIndex + 1) % items.length;
            items.forEach((item, idx) => item.classList.toggle('selected', idx === selectedCommandIndex));
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedCommandIndex = (selectedCommandIndex - 1 + items.length) % items.length;
            items.forEach((item, idx) => item.classList.toggle('selected', idx === selectedCommandIndex));
        } else if (e.key === 'Enter' || e.key === 'Tab') {
            if (filtered[selectedCommandIndex]) {
                e.preventDefault();
                selectQuillCommand(filtered[selectedCommandIndex]);
            }
        } else if (e.key === 'Escape') {
            e.preventDefault();
            hideQuillMenu();
        }
    });

    // Click handler for Quill slash menu items
    slashMenu.addEventListener('click', function(e) {
        const item = e.target.closest('.slash-command-item');
        if (item) {
            const cmd = slashCommands.find(c => c.command === item.dataset.command);
            if (cmd) {
                selectQuillCommand(cmd);
            }
        }
    });

    {% else %}
    // Initialize EasyMDE for MyST Markdown
    // Placeholder for POV modal function (defined later after friends list is available)
    let openPovModal = function() {};

    // Custom POV toolbar button
    const povToolbarButton = {
        name: 'pov',
        action: function(editor) {
            openPovModal();
        },
        className: 'bi bi-people',
        title: 'Share POV with a friend'
    };

    const easyMDE = new EasyMDE({
        element: document.getElementById('editor'),
        spellChecker: false,
        autosave: {
            enabled: false
        },
        placeholder: 'Start writing in Markdown...\n\nTip: Paste or drag images directly into the editor!',
        minHeight: '500px',
        maxHeight: undefined,
        toolbar: [
            'bold', 'italic', 'heading', '|',
            'quote', 'unordered-list', 'ordered-list', '|',
            'link', 'image', 'code', '|',
            'preview', 'side-by-side', 'fullscreen', '|',
            povToolbarButton, '|',
            'guide'
        ],
        status: false,
        styleSelectedText: true,
        renderingConfig: {
            codeSyntaxHighlighting: true
        }
    });

    // EasyMDE-specific: Define how to insert captures into editor
    insertCaptureIntoEditor = function(emoji, text) {
        const cm = easyMDE.codemirror;
        const cursor = cm.getCursor();
        cm.replaceRange(`${emoji} ${text} `, cursor);
        cm.focus();
    };

    // Word count and auto-save
    easyMDE.codemirror.on('change', function() {
        const content = easyMDE.value();
        updateWordCount(content);
        autoSave(content);
    });

    // Initial word count
    updateWordCount(easyMDE.value());

    // Handle paste events for images
    easyMDE.codemirror.on('paste', function(cm, e) {
        const items = e.clipboardData?.items;
        if (!items) return;

        for (let item of items) {
            if (item.type.startsWith('image/')) {
                e.preventDefault();
                const file = item.getAsFile();
                if (file) {
                    uploadAndInsertImage(file, cm);
                }
                return;
            }
        }
    });

    // Handle drop events for images
    easyMDE.codemirror.on('drop', function(cm, e) {
        const files = e.dataTransfer?.files;
        if (!files || files.length === 0) return;

        for (let file of files) {
            if (file.type.startsWith('image/')) {
                e.preventDefault();
                uploadAndInsertImage(file, cm);
                return;
            }
        }
    });

    // Upload image and insert Markdown at cursor
    function uploadAndInsertImage(file, cm) {
        const cursor = cm.getCursor();

        // Insert placeholder
        const placeholder = `![Uploading ${file.name}...]()`;
        cm.replaceRange(placeholder, cursor);

        const formData = new FormData();
        formData.append('file', file);

        fetch('/journal/api/upload-image/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Replace placeholder with actual image markdown
                const content = cm.getValue();
                const newContent = content.replace(
                    placeholder,
                    `![${file.name}](${data.url})`
                );
                cm.setValue(newContent);
                // Trigger change event
                const event = new Event('change');
                cm.getInputField().dispatchEvent(event);
            } else {
                // Remove placeholder on error
                const content = cm.getValue();
                cm.setValue(content.replace(placeholder, ''));
                alert(data.error || 'Upload failed');
            }
        })
        .catch(err => {
            // Remove placeholder on error
            const content = cm.getValue();
            cm.setValue(content.replace(placeholder, ''));
            alert('Upload failed. Please try again.');
        });
    }

    // =================================================================
    // EASYMDE-SPECIFIC SLASH COMMANDS SETUP
    // (Uses shared slashCommands, slashMenu, renderSlashMenu from above)
    // =================================================================

    // Initialize modals with error handling
    let quickPickerModal, goalHabitPickerModal;
    try {
        const quickPickerEl = document.getElementById('quickPickerModal');
        const goalHabitPickerEl = document.getElementById('goalHabitPickerModal');
        quickPickerModal = new bootstrap.Modal(quickPickerEl);
        goalHabitPickerModal = new bootstrap.Modal(goalHabitPickerEl);
    } catch (e) {
        console.error('Error initializing modals:', e);
    }

    let slashStartPos = null;

    // Quick Picker configuration
    const quickPickerConfig = {
        person: {
            title: 'Person',
            icon: 'bi-person',
            searchUrl: '/journal/api/people-search/',
            createUrl: '/journal/api/people-create/',
            mentionUrl: '/journal/api/people-mention/',
            linkPath: '/analytics/people/',
            emptyText: 'No people found. Type a name to add.',
        },
        book: {
            title: 'Book',
            icon: 'bi-book',
            searchUrl: '/journal/api/books-search/',
            createUrl: '/journal/api/books-create/',
            mentionUrl: null,  // Books don't track mentions the same way
            linkPath: '/analytics/books/',
            emptyText: 'No books found. Type a title to add.',
        },
    };

    let currentPickerType = null;
    let pickerItems = [];
    let pickerSelectedIndex = 0;

    // Position the menu at cursor (using viewport/page coordinates for fixed positioning)
    function positionMenu(cm) {
        const cursor = cm.getCursor();
        // Use 'page' coordinates for fixed positioning
        const coords = cm.cursorCoords(cursor, 'page');

        slashMenu.style.left = coords.left + 'px';
        slashMenu.style.top = (coords.bottom + 5) + 'px';
        console.log('[DEBUG] Menu positioned at left:', slashMenu.style.left, 'top:', slashMenu.style.top);
    }

    // Listen for "/" typing
    console.log('[DEBUG] Registering slash command change listener');
    easyMDE.codemirror.on('change', function(cm, change) {
        if (change.origin === '+input' && change.text[0] === '/') {
            console.log('[DEBUG] Slash detected, slashCommands count:', slashCommands.length);
            // Check if "/" is at start of line or after whitespace
            const cursor = cm.getCursor();
            const line = cm.getLine(cursor.line);
            const charBefore = line[cursor.ch - 2];

            if (cursor.ch === 1 || !charBefore || /\s/.test(charBefore)) {
                console.log('[DEBUG] Showing menu at position:', cursor);
                slashStartPos = { line: cursor.line, ch: cursor.ch - 1 };
                renderSlashMenu();
                positionMenu(cm);
            } else {
                console.log('[DEBUG] Slash not at valid position, charBefore:', charBefore);
            }
        } else if (slashMenu.classList.contains('show')) {
            // Filter commands as user types
            const cursor = cm.getCursor();
            const line = cm.getLine(cursor.line);

            if (slashStartPos && cursor.line === slashStartPos.line && cursor.ch >= slashStartPos.ch) {
                const typed = line.substring(slashStartPos.ch, cursor.ch);
                if (typed.startsWith('/') && !/\s/.test(typed)) {
                    renderSlashMenu(typed);
                } else {
                    hideMenu();
                }
            } else {
                hideMenu();
            }
        }
    });

    // Keyboard navigation
    easyMDE.codemirror.on('keydown', function(cm, e) {
        if (!slashMenu.classList.contains('show')) return;

        const items = slashMenu.querySelectorAll('.slash-command-item');
        const filtered = Array.from(items).map(item => {
            const cmd = item.dataset.command;
            return slashCommands.find(c => c.command === cmd);
        });

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedCommandIndex = (selectedCommandIndex + 1) % items.length;
            items.forEach((item, idx) => item.classList.toggle('selected', idx === selectedCommandIndex));
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedCommandIndex = (selectedCommandIndex - 1 + items.length) % items.length;
            items.forEach((item, idx) => item.classList.toggle('selected', idx === selectedCommandIndex));
        } else if (e.key === 'Enter' || e.key === 'Tab') {
            e.preventDefault();
            if (filtered[selectedCommandIndex]) {
                selectCommand(filtered[selectedCommandIndex]);
            }
        } else if (e.key === 'Escape') {
            e.preventDefault();
            hideMenu();
        }
    });

    // Click handler for EasyMDE slash menu items
    slashMenu.addEventListener('click', function(e) {
        const item = e.target.closest('.slash-command-item');
        if (item) {
            const cmd = slashCommands.find(c => c.command === item.dataset.command);
            if (cmd) {
                selectCommand(cmd);
            }
        }
    });

    function hideMenu() {
        slashMenu.classList.remove('show');
        slashStartPos = null;
    }

    function selectCommand(cmd) {
        currentCommand = cmd;

        // Remove the slash command text from editor BEFORE hiding menu
        // (hideMenu sets slashStartPos to null)
        if (slashStartPos) {
            const cm = easyMDE.codemirror;
            const cursor = cm.getCursor();
            cm.replaceRange('', slashStartPos, cursor);
        }

        hideMenu();

        // Handle special commands
        if (cmd.special === 'quick_picker') {
            showQuickPicker(cmd.pickerType);
        } else if (cmd.special === 'goal_picker') {
            showGoalPicker();
        } else if (cmd.special === 'habit_picker') {
            showHabitPicker();
        } else if (cmd.special === 'capture_form') {
            showUnifiedCaptureForm(cmd);
        } else if (cmd.special === 'block_insert') {
            insertBlock(cmd);
        } else if (cmd.special === 'hybrid_picker') {
            showUnifiedHybridPicker(cmd);
        }
    }

    // =================================================================
    // BLOCK INSERT (for dream, gratitude blocks)
    // =================================================================

    function insertBlock(cmd) {
        const cm = easyMDE.codemirror;
        const cursor = cm.getCursor();

        // Create the block with hashtag
        const blockType = cmd.blockType;
        const hashtag = cmd.hashtag ? ` #${cmd.hashtag}` : '';

        // Insert block syntax with cursor positioned inside
        const blockStart = `{${blockType}}\n`;
        const blockEnd = `\n{/${blockType}}${hashtag}`;

        // Insert block start
        cm.replaceRange(blockStart, cursor);

        // Get new cursor position (inside the block)
        const newCursor = {line: cursor.line + 1, ch: 0};

        // Insert block end
        cm.replaceRange(blockEnd, newCursor);

        // Position cursor inside the block for typing
        cm.setCursor(newCursor);
        cm.focus();
    }

    // =================================================================
    // QUICK PICKER (simplified entity selection)
    // =================================================================

    function showQuickPicker(type) {
        currentPickerType = type;
        const config = quickPickerConfig[type];

        document.getElementById('quickPickerTitle').textContent = config.title;
        document.getElementById('quickPickerIcon').className = `bi ${config.icon} me-2`;
        document.getElementById('quickPickerSearch').value = '';
        document.getElementById('quickPickerCreate').classList.add('d-none');

        // Load items
        loadPickerItems('');

        quickPickerModal.show();

        // Focus search after modal opens
        setTimeout(() => {
            document.getElementById('quickPickerSearch').focus();
        }, 200);
    }

    async function loadPickerItems(query) {
        const config = quickPickerConfig[currentPickerType];
        const listEl = document.getElementById('quickPickerList');

        try {
            const resp = await fetch(`${config.searchUrl}?q=${encodeURIComponent(query)}`);
            const data = await resp.json();
            pickerItems = data.items || [];
            pickerSelectedIndex = 0;

            if (pickerItems.length === 0) {
                listEl.innerHTML = `<div class="quick-picker-empty">${config.emptyText}</div>`;
            } else {
                listEl.innerHTML = pickerItems.map((item, idx) => `
                    <div class="quick-picker-item ${idx === 0 ? 'selected' : ''}" data-id="${item.id}" data-name="${item.name}">
                        <div>
                            <div class="quick-picker-name">${item.name}</div>
                            ${item.relationship ? `<div class="quick-picker-meta">${item.relationship}</div>` : ''}
                            ${item.author ? `<div class="quick-picker-meta">by ${item.author}</div>` : ''}
                        </div>
                    </div>
                `).join('');

                // Add click handlers
                listEl.querySelectorAll('.quick-picker-item').forEach(item => {
                    item.addEventListener('click', () => {
                        selectPickerItem(parseInt(item.dataset.id), item.dataset.name);
                    });
                });
            }

            // Show/hide create button
            const createEl = document.getElementById('quickPickerCreate');
            if (query.trim() && !pickerItems.some(p => p.name.toLowerCase() === query.toLowerCase())) {
                document.getElementById('quickPickerNewName').textContent = query;
                createEl.classList.remove('d-none');
            } else {
                createEl.classList.add('d-none');
            }
        } catch (e) {
            console.error('Failed to load picker items:', e);
        }
    }

    function selectPickerItem(id, name) {
        const config = quickPickerConfig[currentPickerType];
        const link = `[${name}](${config.linkPath}${id}/)`;

        // Insert link into EasyMDE
        const cm = easyMDE.codemirror;
        const cursor = cm.getCursor();
        cm.replaceRange(link, cursor);

        // Hide modal
        quickPickerModal.hide();

        // Track mention in background if this picker type supports it (e.g., person)
        if (config.mentionUrl) {
            trackMentionInBackground(config.mentionUrl, id);
        }
    }

    // Track mention asynchronously without blocking UI
    async function trackMentionInBackground(mentionUrl, personId) {
        try {
            let pk = entryPk;

            // If new entry, save first to get pk
            if (!pk) {
                pk = await quickSaveEntryForCapture();
                if (pk) {
                    entryPk = pk;  // Update for future use
                }
            }

            if (pk) {
                await fetch(mentionUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ person_id: personId, entry_id: pk })
                });
            }
        } catch (e) {
            console.error('Failed to track mention:', e);
        }
    }

    async function createPickerItem(name) {
        const config = quickPickerConfig[currentPickerType];

        try {
            const resp = await fetch(config.createUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name })
            });

            const data = await resp.json();
            if (data.id) {
                selectPickerItem(data.id, data.name);
            }
        } catch (e) {
            console.error('Failed to create item:', e);
        }
    }

    // Quick picker search input handler
    document.getElementById('quickPickerSearch').addEventListener('input', function(e) {
        loadPickerItems(e.target.value);
    });

    // Quick picker keyboard navigation
    document.getElementById('quickPickerSearch').addEventListener('keydown', function(e) {
        const items = document.querySelectorAll('.quick-picker-item');

        if (e.key === 'ArrowDown' && items.length > 0) {
            e.preventDefault();
            pickerSelectedIndex = (pickerSelectedIndex + 1) % items.length;
            items.forEach((item, idx) => item.classList.toggle('selected', idx === pickerSelectedIndex));
            items[pickerSelectedIndex].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp' && items.length > 0) {
            e.preventDefault();
            pickerSelectedIndex = (pickerSelectedIndex - 1 + items.length) % items.length;
            items.forEach((item, idx) => item.classList.toggle('selected', idx === pickerSelectedIndex));
            items[pickerSelectedIndex].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (items.length > 0 && items[pickerSelectedIndex]) {
                const item = items[pickerSelectedIndex];
                selectPickerItem(parseInt(item.dataset.id), item.dataset.name);
            } else if (this.value.trim()) {
                // Create new item
                createPickerItem(this.value.trim());
            }
        }
    });

    // Quick picker create button
    document.querySelector('#quickPickerCreate button').addEventListener('click', function() {
        const name = document.getElementById('quickPickerSearch').value.trim();
        if (name) {
            createPickerItem(name);
        }
    });

    // =================================================================
    // QUICK SAVE FOR CAPTURES (EasyMDE version)
    // =================================================================

    function quickSaveEntryForCapture() {
        return new Promise((resolve) => {
            const formData = new FormData();
            formData.append('title', document.getElementById('id_title').value || 'Untitled');
            formData.append('entry_date', document.querySelector('input[name="entry_date"]').value);
            formData.append('mood', document.querySelector('select[name="mood"]').value);
            formData.append('energy', document.querySelector('select[name="energy"]').value);
            formData.append('city', document.getElementById('id_city').value);
            formData.append('country_code', document.getElementById('id_country_code').value);
            formData.append('content', easyMDE.value());

            fetch('/journal/api/quick-save/', {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    entryPk = data.entry_pk;
                    resolve(data.entry_pk);
                } else {
                    resolve(null);
                }
            })
            .catch(() => resolve(null));
        });
    }

    // Goal picker
    function showGoalPicker() {
        document.getElementById('goalHabitPickerTitle').textContent = 'Link to Goal';
        document.getElementById('goalHabitPickerIcon').className = 'bi bi-bullseye me-2';

        const listContainer = document.getElementById('goalHabitPickerList');
        listContainer.innerHTML = '<p class="text-muted text-center">Loading goals...</p>';

        const searchInput = document.getElementById('goalHabitPickerSearch');
        searchInput.value = '';
        searchInput.placeholder = 'Search goals...';

        loadGoals();
        goalHabitPickerModal.show();

        // Remove old listener and add new one
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        newSearchInput.addEventListener('input', function() {
            loadGoals(this.value);
        });

        setTimeout(() => newSearchInput.focus(), 200);
    }

    function loadGoals(query = '') {
        fetch(`/journal/api/goals-search/?q=${encodeURIComponent(query)}`, {
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(r => r.json())
        .then(data => {
            const list = document.getElementById('goalHabitPickerList');
            if (data.goals.length === 0) {
                list.innerHTML = '<p class="text-muted text-center">No goals found</p>';
                return;
            }

            list.innerHTML = data.goals.map(g => {
                // Build tasks list
                let tasksHtml = '';
                if (g.tasks && g.tasks.length > 0) {
                    tasksHtml = `
                        <div class="goal-tasks mt-2">
                            ${g.tasks.map(t => `
                                <div class="goal-task-item" onclick="event.stopPropagation(); completeTask(${t.id}, '${t.title.replace(/'/g, "\\'")}', ${g.id}, '${g.title.replace(/'/g, "\\'")}')">
                                    <i class="bi bi-square me-2 text-muted"></i>
                                    <span>${t.title}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Build linked habits
                let habitsHtml = '';
                if (g.habits && g.habits.length > 0) {
                    habitsHtml = `
                        <div class="goal-habits mt-2">
                            ${g.habits.map(h => `
                                <span class="badge bg-light text-dark me-1" style="cursor: pointer;" onclick="event.stopPropagation(); selectHabit(${h.id}, '${h.name.replace(/'/g, "\\'")}')">
                                    <i class="bi ${h.icon} me-1"></i>${h.name}
                                </span>
                            `).join('')}
                        </div>
                    `;
                }

                return `
                    <div class="picker-item-goal" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
                        <div class="d-flex align-items-center" style="cursor: pointer;" onclick="selectGoal(${g.id}, '${g.title.replace(/'/g, "\\'")}')">
                            <div class="picker-item-icon" style="background: ${g.color}; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; margin-right: 0.75rem;">
                                <i class="bi ${g.icon}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="picker-item-name fw-medium">${g.title}</div>
                                <div class="picker-item-meta text-muted small">${Math.round(g.progress)}% complete</div>
                            </div>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                        ${tasksHtml}
                        ${habitsHtml}
                    </div>
                `;
            }).join('');

            // Add CSS for task items if not already present
            if (!document.getElementById('goalTaskStyles')) {
                const style = document.createElement('style');
                style.id = 'goalTaskStyles';
                style.textContent = `
                    .goal-tasks { padding-left: 2.5rem; }
                    .goal-task-item {
                        display: flex;
                        align-items: center;
                        padding: 0.4rem 0.5rem;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 0.85rem;
                        color: #374151;
                    }
                    .goal-task-item:hover {
                        background: #f3f4f6;
                    }
                    .goal-task-item:hover i {
                        color: #4f46e5 !important;
                    }
                    .goal-habits { padding-left: 2.5rem; }
                `;
                document.head.appendChild(style);
            }
        });
    }

    // Complete a task within a goal
    window.completeTask = function(taskId, taskTitle, goalId, goalTitle) {
        goalHabitPickerModal.hide();

        const doCompleteTask = (pk) => {
            fetch('/journal/api/complete-task/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    task_id: taskId,
                    entry_pk: pk
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Insert MyST-style markup into EasyMDE
                    const cm = easyMDE.codemirror;
                    const cursor = cm.getCursor();
                    const text = `\n{goal} [${goalTitle}](/goals/${goalId}/) - ‚úÖ ${taskTitle} {/goal}\n`;
                    cm.replaceRange(text, cursor);
                } else {
                    alert(data.error || 'Failed to complete task');
                }
            })
            .catch(() => alert('Failed to complete task'));
        };

        if (!entryPk) {
            quickSaveEntryForCapture().then(pk => {
                if (pk) doCompleteTask(pk);
            });
        } else {
            doCompleteTask(entryPk);
        }
    };

    window.selectGoal = function(id, title) {
        goalHabitPickerModal.hide();

        // Link the goal to the entry in the database
        const linkGoalToEntry = (pk) => {
            fetch('/journal/api/link-goal/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entry_pk: pk,
                    goal_id: id
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Insert MyST-style markup into EasyMDE
                    const cm = easyMDE.codemirror;
                    const cursor = cm.getCursor();
                    const text = `\n{goal} [${title}](/goals/${id}/) {/goal}\n`;
                    cm.replaceRange(text, cursor);
                } else {
                    alert(data.error || 'Failed to link goal');
                }
            })
            .catch(() => alert('Failed to link goal'));
        };

        // If new entry, save first
        if (!entryPk) {
            quickSaveEntryForCapture().then(pk => {
                if (pk) linkGoalToEntry(pk);
            });
        } else {
            linkGoalToEntry(entryPk);
        }
    };

    // Habit picker
    function showHabitPicker() {
        document.getElementById('goalHabitPickerTitle').textContent = 'Link to Habit';
        document.getElementById('goalHabitPickerIcon').className = 'bi bi-repeat me-2';

        const listContainer = document.getElementById('goalHabitPickerList');
        listContainer.innerHTML = '<p class="text-muted text-center">Loading habits...</p>';

        const searchInput = document.getElementById('goalHabitPickerSearch');
        searchInput.value = '';
        searchInput.placeholder = 'Search habits...';

        loadHabits();
        goalHabitPickerModal.show();

        // Remove old listener and add new one
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        newSearchInput.addEventListener('input', function() {
            loadHabits(this.value);
        });

        setTimeout(() => newSearchInput.focus(), 200);
    }

    function loadHabits(query = '') {
        fetch(`/journal/api/habits-search/?q=${encodeURIComponent(query)}`, {
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(r => r.json())
        .then(data => {
            const list = document.getElementById('goalHabitPickerList');
            let html = '';

            if (data.habits.length === 0) {
                html = '<p class="text-muted text-center mb-3">No habits found</p>';
            } else {
                html = data.habits.map(h => `
                    <div class="picker-item" onclick="selectHabit(${h.id}, '${h.name.replace(/'/g, "\\'")}')">
                        <div class="picker-item-icon" style="background: ${h.color}">
                            <i class="bi ${h.icon}"></i>
                        </div>
                        <div>
                            <div class="picker-item-name">${h.name}</div>
                            <div class="picker-item-meta">${h.current_streak} day streak</div>
                        </div>
                    </div>
                `).join('');
            }

            // Add "Create New Habit" button at the bottom
            html += `
                <div class="mt-3 text-center">
                    <a href="/habits/create/" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Create New Habit
                    </a>
                    <p class="text-muted small mt-2 mb-0">Opens in new tab</p>
                </div>
            `;

            list.innerHTML = html;
        });
    }

    window.selectHabit = function(id, name) {
        goalHabitPickerModal.hide();

        // Link the habit to the entry and create a check-in
        const linkHabitToEntry = (pk) => {
            fetch('/journal/api/link-habit/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entry_pk: pk,
                    habit_id: id,
                    create_checkin: true
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Insert MyST-style markup into EasyMDE
                    const cm = easyMDE.codemirror;
                    const cursor = cm.getCursor();
                    let text = `\n{habit} [${name}](/habits/${id}/) {/habit}\n`;
                    if (data.checkin_created) {
                        text = `\n{habit} [${name}](/habits/${id}/) - Checked in! {/habit}\n`;
                    }
                    cm.replaceRange(text, cursor);
                } else {
                    alert(data.error || 'Failed to link habit');
                }
            })
            .catch(() => alert('Failed to link habit'));
        };

        // If new entry, save first
        if (!entryPk) {
            quickSaveEntryForCapture().then(pk => {
                if (pk) linkHabitToEntry(pk);
            });
        } else {
            linkHabitToEntry(entryPk);
        }
    };


    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
        if (!slashMenu.contains(e.target)) {
            hideMenu();
        }
        if (!mentionMenu.contains(e.target)) {
            hideMentionMenu();
        }
    });

    // =================================================================
    // HABIT AUTO-DETECTION
    // =================================================================

    let habitDetectionTimeout = null;
    let detectedHabits = [];

    function detectHabitsInContent() {
        const content = easyMDE ? easyMDE.value() : '';
        if (!content || content.length < 3) {
            document.getElementById('habitSuggestions').classList.add('d-none');
            return;
        }

        // Debounce the API call
        clearTimeout(habitDetectionTimeout);
        habitDetectionTimeout = setTimeout(() => {
            fetch(`/journal/api/habits-detect/?content=${encodeURIComponent(content)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.detected_habits && data.detected_habits.length > 0) {
                        detectedHabits = data.detected_habits;
                        showHabitSuggestions(data.detected_habits);
                    } else {
                        document.getElementById('habitSuggestions').classList.add('d-none');
                    }
                })
                .catch(err => console.error('Habit detection failed:', err));
        }, 1500); // Wait 1.5s after user stops typing
    }

    function showHabitSuggestions(habits) {
        const container = document.getElementById('habitSuggestionsContent');
        const banner = document.getElementById('habitSuggestions');

        let html = '<div class="d-flex flex-wrap gap-2">';
        habits.forEach(habit => {
            html += `
                <button type="button" class="btn btn-sm btn-success" onclick="quickLinkHabit(${habit.id}, '${habit.name.replace(/'/g, "\\'")}')">
                    <i class="bi bi-repeat me-1"></i>Link "${habit.name}"
                </button>
            `;
        });
        html += '</div>';

        container.innerHTML = html;
        banner.classList.remove('d-none');
    }

    window.quickLinkHabit = function(id, name) {
        // Close the suggestion banner
        document.getElementById('habitSuggestions').classList.add('d-none');
        // Use the existing selectHabit function
        selectHabit(id, name);
    };

    // Watch for content changes
    if (easyMDE) {
        easyMDE.codemirror.on('change', function() {
            detectHabitsInContent();
        });
    }

    // =================================================================
    // @ MENTION AUTOCOMPLETE (for POV sharing)
    // =================================================================

    const mentionMenu = document.getElementById('mentionMenu');
    let friendsList = null;  // Cached friends list
    let mentionStartPos = null;
    let selectedMentionIndex = 0;

    // Fetch friends list (cached)
    function loadFriendsList() {
        if (friendsList !== null) {
            return Promise.resolve(friendsList);
        }
        return fetch('{% url "accounts:friends_list_api" %}')
            .then(r => r.json())
            .then(data => {
                friendsList = data.friends || [];
                return friendsList;
            })
            .catch(() => {
                friendsList = [];
                return [];
            });
    }

    // Pre-load friends list
    loadFriendsList();

    // Render mention menu
    function renderMentionMenu(filter = '') {
        loadFriendsList().then(friends => {
            const filtered = filter
                ? friends.filter(f =>
                    f.username.toLowerCase().includes(filter.toLowerCase()) ||
                    f.display_name.toLowerCase().includes(filter.toLowerCase())
                  )
                : friends;

            if (filtered.length === 0) {
                mentionMenu.innerHTML = `
                    <div class="mention-header">Friends</div>
                    <div class="text-muted text-center py-3 small">No friends found</div>
                `;
                mentionMenu.classList.add('show');
                return;
            }

            selectedMentionIndex = 0;
            mentionMenu.innerHTML = `
                <div class="mention-header">Tag a friend for POV</div>
                ${filtered.map((f, idx) => `
                    <div class="mention-item ${idx === 0 ? 'selected' : ''}" data-username="${f.username}">
                        <div class="mention-icon">${f.username.charAt(0).toUpperCase()}</div>
                        <div>
                            <div class="mention-username">@${f.username}</div>
                            <div class="mention-display">${f.display_name}</div>
                        </div>
                    </div>
                `).join('')}
            `;

            // Add click handlers
            mentionMenu.querySelectorAll('.mention-item').forEach((item, idx) => {
                item.addEventListener('click', () => selectMention(filtered[idx]));
                item.addEventListener('mouseenter', () => {
                    mentionMenu.querySelectorAll('.mention-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    selectedMentionIndex = idx;
                });
            });

            mentionMenu.classList.add('show');
        });
    }

    // Position mention menu at cursor
    function positionMentionMenu(cm) {
        const cursor = cm.getCursor();
        const coords = cm.cursorCoords(cursor, 'local');
        mentionMenu.style.left = (coords.left + 10) + 'px';
        mentionMenu.style.top = (coords.bottom + 5) + 'px';
    }

    function hideMentionMenu() {
        mentionMenu.classList.remove('show');
        mentionStartPos = null;
    }

    function selectMention(friend) {
        if (mentionStartPos) {
            const cm = easyMDE.codemirror;
            const cursor = cm.getCursor();
            // Replace @partial with @username
            cm.replaceRange(friend.username + ' ', mentionStartPos, cursor);
        }
        hideMentionMenu();
    }

    // Listen for "@" typing in EasyMDE
    easyMDE.codemirror.on('change', function(cm, change) {
        // Check for @ trigger
        if (change.origin === '+input' && change.text[0] === '@') {
            const cursor = cm.getCursor();
            const line = cm.getLine(cursor.line);
            const charBefore = line[cursor.ch - 2];

            // Only trigger if @ is at start of line or after whitespace
            if (cursor.ch === 1 || !charBefore || /\s/.test(charBefore)) {
                mentionStartPos = { line: cursor.line, ch: cursor.ch - 1 };
                renderMentionMenu();
                positionMentionMenu(cm);
            }
        } else if (mentionMenu.classList.contains('show')) {
            // Filter as user types after @
            const cursor = cm.getCursor();
            const line = cm.getLine(cursor.line);

            if (mentionStartPos && cursor.line === mentionStartPos.line && cursor.ch >= mentionStartPos.ch) {
                const typed = line.substring(mentionStartPos.ch, cursor.ch);
                if (typed.startsWith('@') && !/\s/.test(typed)) {
                    renderMentionMenu(typed.substring(1));  // Remove @ for filter
                } else {
                    hideMentionMenu();
                }
            } else {
                hideMentionMenu();
            }
        }
    });

    // Keyboard navigation for mention menu
    easyMDE.codemirror.on('keydown', function(cm, e) {
        if (!mentionMenu.classList.contains('show')) return;

        const items = mentionMenu.querySelectorAll('.mention-item');
        if (items.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedMentionIndex = (selectedMentionIndex + 1) % items.length;
            items.forEach((item, idx) => item.classList.toggle('selected', idx === selectedMentionIndex));
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedMentionIndex = (selectedMentionIndex - 1 + items.length) % items.length;
            items.forEach((item, idx) => item.classList.toggle('selected', idx === selectedMentionIndex));
        } else if (e.key === 'Enter' || e.key === 'Tab') {
            e.preventDefault();
            const selectedItem = items[selectedMentionIndex];
            if (selectedItem) {
                const username = selectedItem.dataset.username;
                const friend = friendsList.find(f => f.username === username);
                if (friend) selectMention(friend);
            }
        } else if (e.key === 'Escape') {
            e.preventDefault();
            hideMentionMenu();
        }
    });

    // =================================================================
    // POV SHARE (toolbar button)
    // =================================================================
    const povModal = new bootstrap.Modal(document.getElementById('povModal'));
    const povFriendSelect = document.getElementById('povFriendSelect');
    const povMessage = document.getElementById('povMessage');
    const povSubmitBtn = document.getElementById('povSubmitBtn');

    // Function to open POV modal (called from toolbar button)
    openPovModal = async function() {
        // Load friends and populate the select
        const friends = await loadFriendsList();
        povFriendSelect.innerHTML = '<option value="">Select a friend...</option>';

        friends.forEach(friend => {
            const option = document.createElement('option');
            option.value = friend.username;
            option.textContent = friend.display_name || friend.username;
            povFriendSelect.appendChild(option);
        });

        // Clear previous message
        povMessage.value = '';

        // Show modal
        povModal.show();
    }

    // Handle POV submission
    povSubmitBtn.addEventListener('click', function() {
        const friendUsername = povFriendSelect.value;
        const message = povMessage.value.trim();

        if (!friendUsername) {
            alert('Please select a friend to share with.');
            return;
        }

        if (!message) {
            alert('Please write a message.');
            return;
        }

        // Insert POV block into editor
        const cm = easyMDE.codemirror;
        const cursor = cm.getCursor();

        // Create the POV block with @mention
        const povBlock = `\n{pov}\n@${friendUsername}\n\n${message}\n{/pov} #pov\n`;

        // Insert at cursor position
        cm.replaceRange(povBlock, cursor);

        // Move cursor after the block
        const newLine = cursor.line + povBlock.split('\n').length - 1;
        cm.setCursor({line: newLine, ch: 0});
        cm.focus();

        // Close modal
        povModal.hide();
    });

    {% endif %}

    // Track if there are unsaved changes
    let hasUnsavedChanges = false;
    let pendingNavigation = null;

    // Draft restore modal elements
    const draftRestoreModal = new bootstrap.Modal(document.getElementById('draftRestoreModal'));
    const draftRestoreMessage = document.getElementById('draftRestoreMessage');
    const draftRestoreBtn = document.getElementById('draftRestoreBtn');
    const draftDiscardBtn = document.getElementById('draftDiscardBtn');

    // Unsaved changes modal elements
    const unsavedChangesModal = new bootstrap.Modal(document.getElementById('unsavedChangesModal'));
    const unsavedStayBtn = document.getElementById('unsavedStayBtn');
    const unsavedLeaveBtn = document.getElementById('unsavedLeaveBtn');

    // Restore from local storage if newer than saved version
    const key = 'reflekt-entry-{% if entry %}{{ entry.pk }}{% else %}new{% endif %}';
    const saved = localStorage.getItem(key);

    function restoreDraft(data) {
        document.getElementById('id_title').value = data.title || document.getElementById('id_title').value;
        {% if editor_preference == 'rich_text' %}
        quill.root.innerHTML = data.content;
        document.getElementById('id_content').value = data.content;
        updateWordCount(quill.getText());
        {% else %}
        easyMDE.value(data.content);
        updateWordCount(data.content);
        {% endif %}
    }

    if (saved) {
        try {
            const data = JSON.parse(saved);
            // Only restore if less than 24 hours old
            if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                {% if is_new %}
                // For new entries, restore if there's content
                if (data.content && data.content.trim()) {
                    // Format timestamp for display
                    const savedTime = new Date(data.timestamp);
                    const timeAgo = getTimeAgo(savedTime);
                    draftRestoreMessage.textContent = `You have an unsaved draft from ${timeAgo}.`;

                    // Show custom modal
                    draftRestoreModal.show();

                    // Store data for restore/discard handlers
                    draftRestoreBtn.onclick = function() {
                        restoreDraft(data);
                        draftRestoreModal.hide();
                    };

                    draftDiscardBtn.onclick = function() {
                        localStorage.removeItem(key);
                        draftRestoreModal.hide();
                    };
                }
                {% else %}
                // For existing entries, check if draft is newer than what's loaded
                const currentContent = {% if editor_preference == 'rich_text' %}quill.root.innerHTML{% else %}easyMDE.value(){% endif %};
                if (data.content && data.content.trim() && data.content !== currentContent) {
                    const savedTime = new Date(data.timestamp);
                    const timeAgo = getTimeAgo(savedTime);
                    draftRestoreMessage.textContent = `You have unsaved changes from ${timeAgo}.`;

                    draftRestoreModal.show();

                    draftRestoreBtn.onclick = function() {
                        restoreDraft(data);
                        draftRestoreModal.hide();
                    };

                    draftDiscardBtn.onclick = function() {
                        localStorage.removeItem(key);
                        draftRestoreModal.hide();
                    };
                }
                {% endif %}
            } else {
                // Draft is too old, clear it
                localStorage.removeItem(key);
            }
        } catch (e) {
            console.log('Could not restore draft:', e);
        }
    }

    // Helper function to format time ago
    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        return 'yesterday';
    }

    // Update the autoSave function to track unsaved changes
    const originalAutoSave = autoSave;
    autoSave = function(content) {
        hasUnsavedChanges = true;
        originalAutoSave(content);
    };

    // Clear local storage on successful save
    document.getElementById('entry-form').addEventListener('submit', function() {
        hasUnsavedChanges = false;
        localStorage.removeItem(key);
    });

    // Intercept navigation links when there are unsaved changes
    document.querySelectorAll('a[href]').forEach(link => {
        // Skip links that open in new tabs or are javascript/anchor links
        if (link.target === '_blank' || link.href.startsWith('javascript:') || link.href.startsWith('#')) return;

        link.addEventListener('click', function(e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                pendingNavigation = this.href;
                unsavedChangesModal.show();
            }
        });
    });

    // Handle unsaved changes modal buttons
    unsavedStayBtn.addEventListener('click', function() {
        pendingNavigation = null;
        unsavedChangesModal.hide();
    });

    unsavedLeaveBtn.addEventListener('click', function() {
        hasUnsavedChanges = false; // Prevent beforeunload
        if (pendingNavigation) {
            if (pendingNavigation === 'back') {
                history.back();
            } else {
                window.location.href = pendingNavigation;
            }
        }
    });

    // Intercept browser back button with custom modal
    history.pushState(null, '', window.location.href);
    window.addEventListener('popstate', function(e) {
        if (hasUnsavedChanges) {
            // Push state again to prevent actual navigation
            history.pushState(null, '', window.location.href);
            pendingNavigation = 'back';
            unsavedChangesModal.show();
        }
    });

    // Still use beforeunload for browser refresh/close (can't prevent with custom modal)
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });

    // Attachment upload handling
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = uploadProgress.querySelector('.progress-bar');
    const uploadStatus = document.getElementById('uploadStatus');
    const gallery = document.getElementById('attachmentsGallery');
    const attachmentCount = document.getElementById('attachmentCount');
    const attachmentBtn = document.getElementById('attachmentBtn');
    const attachmentPanel = document.getElementById('attachmentPanel');
    const closeAttachmentPanel = document.getElementById('closeAttachmentPanel');
    // entryPk is declared in shared variables section above
    const csrfToken = '{{ csrf_token }}';
    const isNewEntry = {{ is_new|yesno:"true,false" }};
    let pendingFiles = [];

    // Attachment panel toggle
    if (attachmentBtn && attachmentPanel) {
        attachmentBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            attachmentPanel.classList.toggle('show');
        });

        closeAttachmentPanel.addEventListener('click', function() {
            attachmentPanel.classList.remove('show');
        });

        // Close panel when clicking outside
        document.addEventListener('click', function(e) {
            if (!attachmentPanel.contains(e.target) && !attachmentBtn.contains(e.target)) {
                attachmentPanel.classList.remove('show');
            }
        });
    }

    // Click to browse
    uploadZone.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.click();
    });

    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    // File input change
    fileInput.addEventListener('change', () => {
        handleFiles(fileInput.files);
        fileInput.value = ''; // Reset for next upload
    });

    function handleFiles(files) {
        if (entryPk) {
            // Entry exists, upload directly
            Array.from(files).forEach(file => uploadFile(file));
        } else {
            // New entry - save it first, then upload
            pendingFiles = Array.from(files);
            quickSaveEntry().then(pk => {
                if (pk) {
                    entryPk = pk;
                    // Update the form action to point to edit URL
                    document.getElementById('entry-form').action = `/journal/${pk}/edit/`;
                    // Upload pending files
                    pendingFiles.forEach(file => uploadFile(file));
                    pendingFiles = [];
                    // Clear local storage since entry is now saved
                    localStorage.removeItem('reflekt-entry-new');
                }
            });
        }
    }

    function quickSaveEntry() {
        return new Promise((resolve, reject) => {
            uploadProgress.classList.remove('d-none');
            uploadStatus.textContent = 'Saving entry...';
            progressBar.style.width = '50%';

            const formData = new FormData();
            formData.append('title', document.getElementById('id_title').value || 'Untitled');
            formData.append('entry_date', document.querySelector('input[name="entry_date"]').value);
            formData.append('mood', document.querySelector('select[name="mood"]').value);
            formData.append('energy', document.querySelector('select[name="energy"]').value);
            formData.append('city', document.getElementById('id_city').value);
            formData.append('country_code', document.getElementById('id_country_code').value);

            // Get content from the appropriate editor
            {% if editor_preference == 'rich_text' %}
            formData.append('content', document.getElementById('id_content').value);
            {% else %}
            formData.append('content', easyMDE.value());
            {% endif %}

            fetch('/journal/api/quick-save/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    progressBar.style.width = '100%';
                    uploadStatus.textContent = 'Entry saved!';
                    resolve(data.entry_pk);
                } else {
                    uploadProgress.classList.add('d-none');
                    alert('Failed to save entry');
                    resolve(null);
                }
            })
            .catch(err => {
                uploadProgress.classList.add('d-none');
                alert('Failed to save entry');
                resolve(null);
            });
        });
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        // Show progress
        uploadProgress.classList.remove('d-none');
        progressBar.style.width = '0%';
        uploadStatus.textContent = `Uploading ${file.name}...`;

        const xhr = new XMLHttpRequest();
        xhr.open('POST', `/journal/${entryPk}/attachments/upload/`);
        xhr.setRequestHeader('X-CSRFToken', csrfToken);

        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const percent = (e.loaded / e.total) * 100;
                progressBar.style.width = percent + '%';
            }
        };

        xhr.onload = () => {
            uploadProgress.classList.add('d-none');
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                addAttachmentToGallery(data);
                updateCount(1);
            } else {
                const error = JSON.parse(xhr.responseText);
                alert(error.error || 'Upload failed');
            }
        };

        xhr.onerror = () => {
            uploadProgress.classList.add('d-none');
            alert('Upload failed. Please try again.');
        };

        xhr.send(formData);
    }

    function addAttachmentToGallery(data) {
        const item = document.createElement('div');
        item.className = 'attachment-item-compact';
        item.dataset.id = data.id;
        item.dataset.url = data.url;

        let preview;
        let copyBtn = '';
        if (data.file_type === 'image') {
            preview = `<img src="${data.url}" alt="${data.file_name}">`;
            copyBtn = `<button type="button" class="copy-url-btn" onclick="copyImageSyntax(this, '${data.url}')" title="Copy {image} syntax">
                <i class="bi bi-clipboard"></i>
            </button>`;
        } else if (data.file_type === 'audio') {
            preview = `<div class="file-icon-sm audio"><i class="bi bi-music-note-beamed"></i></div>`;
        } else {
            preview = `<div class="file-icon-sm video"><i class="bi bi-play-circle"></i></div>`;
        }

        item.innerHTML = `
            ${preview}
            <span class="file-name-compact" title="${data.file_name}">${data.file_name}</span>
            <div class="attachment-actions">
                ${copyBtn}
                <button type="button" class="delete-btn-sm" onclick="deleteAttachment(${data.id})">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;

        gallery.appendChild(item);
    }

    // Copy image syntax to clipboard
    window.copyImageSyntax = function(btn, url) {
        const syntax = `{image} ${url}`;
        navigator.clipboard.writeText(syntax).then(() => {
            // Show success feedback
            const icon = btn.querySelector('i');
            icon.className = 'bi bi-check';
            btn.classList.add('copied');
            setTimeout(() => {
                icon.className = 'bi bi-clipboard';
                btn.classList.remove('copied');
            }, 1500);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy to clipboard');
        });
    };

    function updateCount(delta) {
        const current = parseInt(attachmentCount.textContent) || 0;
        const newCount = Math.max(0, current + delta);
        attachmentCount.textContent = newCount;

        // Show/hide badge based on count
        if (newCount > 0) {
            attachmentCount.classList.remove('d-none');
        } else {
            attachmentCount.classList.add('d-none');
        }
    }

    // Make deleteAttachment global
    window.deleteAttachment = function(id) {
        if (!confirm('Delete this attachment?')) return;

        fetch(`/journal/attachments/${id}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Find and remove the item (check both old and new class names)
                const item = gallery.querySelector(`.attachment-item-compact[data-id="${id}"]`) ||
                             gallery.querySelector(`.attachment-item[data-id="${id}"]`);
                if (item) item.remove();
                updateCount(-1);
            }
        })
        .catch(() => alert('Failed to delete attachment'));
    };
});

// Geolocation detection
document.addEventListener('DOMContentLoaded', function() {
    const detectBtn = document.getElementById('detectLocationBtn');
    const detectLink = document.getElementById('detectLocationLink');
    const locationIcon = document.getElementById('locationIcon');
    const cityInput = document.getElementById('id_city');
    const countryInput = document.getElementById('id_country_code');

    function detectLocation() {
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
            return;
        }

        // Show loading state
        locationIcon.className = 'bi bi-arrow-clockwise spin';
        detectBtn.disabled = true;

        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                // Reverse geocode using OpenStreetMap Nominatim
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`)
                    .then(response => response.json())
                    .then(data => {
                        const address = data.address || {};
                        const city = address.city || address.town || address.village || address.municipality || address.county || '';
                        const countryCode = (address.country_code || '').toUpperCase();

                        if (city) {
                            cityInput.value = city;
                        }
                        if (countryCode) {
                            countryInput.value = countryCode;
                        }

                        // Reset icon
                        locationIcon.className = 'bi bi-crosshairs';
                        detectBtn.disabled = false;

                        if (!city && !countryCode) {
                            alert('Could not determine your location. Please enter it manually.');
                        }
                    })
                    .catch(error => {
                        console.error('Geocoding error:', error);
                        locationIcon.className = 'bi bi-crosshairs';
                        detectBtn.disabled = false;
                        alert('Could not look up your location. Please enter it manually.');
                    });
            },
            function(error) {
                locationIcon.className = 'bi bi-crosshairs';
                detectBtn.disabled = false;

                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        alert('Location access denied. Please allow location access or enter your city manually.');
                        break;
                    case error.POSITION_UNAVAILABLE:
                        alert('Location information unavailable. Please enter your city manually.');
                        break;
                    case error.TIMEOUT:
                        alert('Location request timed out. Please try again or enter your city manually.');
                        break;
                    default:
                        alert('Could not get your location. Please enter it manually.');
                }
            },
            {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 300000  // Cache for 5 minutes
            }
        );
    }

    if (detectBtn) {
        detectBtn.addEventListener('click', detectLocation);
    }
    if (detectLink) {
        detectLink.addEventListener('click', function(e) {
            e.preventDefault();
            detectLocation();
        });
    }
});
</script>
{% endblock %}
