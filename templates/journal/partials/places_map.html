<!-- Places Map Component using Leaflet.js -->
{% if map_locations %}
<div class="places-map-container">
    <div id="placesMap" style="height: 300px; border-radius: 12px;"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map centered on first location or default
    const locations = {{ map_locations|safe }};

    if (locations.length === 0) return;

    // Calculate center from all locations
    let sumLat = 0, sumLng = 0;
    locations.forEach(loc => {
        sumLat += loc.lat;
        sumLng += loc.lng;
    });
    const centerLat = sumLat / locations.length;
    const centerLng = sumLng / locations.length;

    // Initialize map
    const map = L.map('placesMap').setView([centerLat, centerLng], 4);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 18
    }).addTo(map);

    // Custom icons
    const travelIcon = L.divIcon({
        className: 'custom-marker travel-marker',
        html: '<i class="bi bi-airplane-fill"></i>',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });

    const placeIcon = L.divIcon({
        className: 'custom-marker place-marker',
        html: '<i class="bi bi-geo-alt-fill"></i>',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });

    const bothIcon = L.divIcon({
        className: 'custom-marker both-marker',
        html: '<i class="bi bi-star-fill"></i>',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });

    // Add markers for each location
    const markers = [];
    locations.forEach(loc => {
        let icon;
        if (loc.type === 'travel') {
            icon = travelIcon;
        } else if (loc.type === 'place') {
            icon = placeIcon;
        } else {
            icon = bothIcon;
        }

        const marker = L.marker([loc.lat, loc.lng], { icon: icon })
            .addTo(map)
            .bindPopup(`
                <strong>${loc.name}</strong><br>
                <span class="text-muted">${loc.count} visit${loc.count > 1 ? 's' : ''}</span>
            `);
        markers.push(marker);
    });

    // Fit bounds to show all markers
    if (markers.length > 1) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
});
</script>
{% else %}
<div class="text-center py-4 text-muted">
    <i class="bi bi-geo-alt display-4"></i>
    <p class="mt-2 mb-0">No places tracked yet</p>
    <small>Use <code>/travel</code> or <code>/place</code> to log locations!</small>
</div>
{% endif %}
