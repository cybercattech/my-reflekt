{% extends 'dashboard/base_dashboard.html' %}

{% block title %}Prompt Preferences{% endblock %}

{% block dashboard_css %}
<style>
.section-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #6b7280;
    margin-bottom: 0.75rem;
}

.category-card {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    height: 220px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
}

.category-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.category-card-bg {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    transition: transform 0.3s ease;
}

.category-card:hover .category-card-bg {
    transform: scale(1.05);
}

.category-card-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(180deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.6) 100%);
}

.category-card-content {
    position: relative;
    z-index: 2;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 1.25rem;
    color: white;
}

.category-card-icon {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 3;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.category-card-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.category-card-desc {
    font-size: 0.85rem;
    opacity: 0.9;
    margin-bottom: 0.75rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.category-card-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.8rem;
    opacity: 0.9;
}

/* Selected state */
.category-card.is-selected {
    border: 3px solid #22c55e;
}

.category-card.is-selected .category-card-icon {
    background: #22c55e;
}

.selected-badge {
    position: absolute;
    top: 1rem;
    left: 1rem;
    z-index: 3;
}

/* Toggle button */
.toggle-btn {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    z-index: 4;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.toggle-btn.select {
    background: rgba(255, 255, 255, 0.9);
    color: #374151;
}

.toggle-btn.select:hover {
    background: white;
}

.toggle-btn.selected {
    background: #22c55e;
    color: white;
}

.toggle-btn.selected:hover {
    background: #16a34a;
}

/* Default badge */
.default-badge {
    position: absolute;
    top: 1rem;
    left: 1rem;
    z-index: 3;
}
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4 px-4">

<!-- Page Header -->
<div class="text-center mb-5">
    <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3"
         style="width: 80px; height: 80px; background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);">
        <i class="bi bi-lightbulb-fill text-white" style="font-size: 2rem;"></i>
    </div>
    <h1 class="mb-2">Prompt Preferences</h1>
    <p class="text-muted mb-0 mx-auto" style="max-width: 550px;">
        Choose the types of prompts you'd like to receive. Select multiple categories to get a variety of prompts tailored to your needs.
    </p>
    {% if selected_count > 0 %}
    <div class="mt-3">
        <span class="badge bg-success rounded-pill px-3 py-2">
            <i class="bi bi-check-circle me-1"></i>
            <span id="selectedCount">{{ selected_count }}</span> categor{{ selected_count|pluralize:"y,ies" }} selected
        </span>
    </div>
    {% else %}
    <div class="mt-3">
        <span class="badge bg-secondary rounded-pill px-3 py-2" id="noSelectionBadge">
            <i class="bi bi-info-circle me-1"></i>
            Using default prompts
        </span>
    </div>
    {% endif %}
</div>

<!-- Categories Grid -->
<div class="section-label">Available Categories</div>
<div class="row g-4">
    {% for item in categories %}
    <div class="col-md-6 col-lg-4">
        <div class="category-card {% if item.is_selected %}is-selected{% endif %}"
             data-category-id="{{ item.category.pk }}"
             id="category-{{ item.category.pk }}">
            <div class="category-card-bg" style="background: linear-gradient(135deg, {{ item.category.color }} 0%, {{ item.category.color }}cc 100%); {% if item.category.image_url %}background-image: url('{{ item.category.image_url }}'); background-size: cover; background-position: center;{% endif %}"></div>
            <div class="category-card-overlay"></div>

            {% if item.category.is_default %}
            <div class="default-badge">
                <span class="badge bg-warning text-dark"><i class="bi bi-star-fill me-1"></i>Default</span>
            </div>
            {% elif item.is_selected %}
            <div class="selected-badge">
                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Selected</span>
            </div>
            {% endif %}

            <div class="category-card-icon">
                <i class="{{ item.category.icon }}"></i>
            </div>

            <div class="category-card-content">
                <h3 class="category-card-title">{{ item.category.name }}</h3>
                <p class="category-card-desc">{{ item.category.description }}</p>
                <div class="category-card-meta">
                    <span><i class="bi bi-chat-quote me-1"></i>{{ item.prompt_count }} prompts</span>
                </div>
            </div>

            <button type="button"
                    class="toggle-btn {% if item.is_selected %}selected{% else %}select{% endif %}"
                    onclick="toggleCategory({{ item.category.pk }}, this)"
                    data-selected="{{ item.is_selected|yesno:'true,false' }}">
                {% if item.is_selected %}
                    <i class="bi bi-check-circle me-1"></i>Selected
                {% else %}
                    <i class="bi bi-plus-circle me-1"></i>Select
                {% endif %}
            </button>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="text-center py-5">
            <i class="bi bi-lightbulb text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">No categories available yet</h4>
            <p class="text-muted">Check back soon for new prompt categories!</p>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Help Section -->
<div class="card border-0 shadow-sm mt-5">
    <div class="card-body p-4">
        <h5 class="mb-3"><i class="bi bi-question-circle me-2"></i>How it works</h5>
        <div class="row">
            <div class="col-md-4 mb-3 mb-md-0">
                <div class="d-flex align-items-start">
                    <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-3">
                        <i class="bi bi-hand-index text-primary"></i>
                    </div>
                    <div>
                        <strong>1. Select Categories</strong>
                        <p class="text-muted small mb-0">Choose one or more categories that resonate with you.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3 mb-md-0">
                <div class="d-flex align-items-start">
                    <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-3">
                        <i class="bi bi-shuffle text-primary"></i>
                    </div>
                    <div>
                        <strong>2. Daily Rotation</strong>
                        <p class="text-muted small mb-0">Each day, you'll get a prompt from your selected categories.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex align-items-start">
                    <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-3">
                        <i class="bi bi-pencil text-primary"></i>
                    </div>
                    <div>
                        <strong>3. Write & Reflect</strong>
                        <p class="text-muted small mb-0">Use the prompts to guide your journaling practice.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
{% endblock %}

{% block dashboard_js %}
<script>
function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleCategory(categoryId, button) {
    const card = document.getElementById('category-' + categoryId);
    const isSelected = button.dataset.selected === 'true';

    // Disable button during request
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch(`/journal/api/prompt-category/${categoryId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update button state
            button.dataset.selected = data.is_selected ? 'true' : 'false';

            if (data.is_selected) {
                button.className = 'toggle-btn selected';
                button.innerHTML = '<i class="bi bi-check-circle me-1"></i>Selected';
                card.classList.add('is-selected');

                // Add selected badge
                const existingBadge = card.querySelector('.selected-badge');
                if (!existingBadge && !card.querySelector('.default-badge')) {
                    const badgeDiv = document.createElement('div');
                    badgeDiv.className = 'selected-badge';
                    badgeDiv.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Selected</span>';
                    card.appendChild(badgeDiv);
                }
            } else {
                button.className = 'toggle-btn select';
                button.innerHTML = '<i class="bi bi-plus-circle me-1"></i>Select';
                card.classList.remove('is-selected');

                // Remove selected badge
                const badge = card.querySelector('.selected-badge');
                if (badge) badge.remove();
            }

            // Update selected count
            updateSelectedCount(data.selected_count);
        } else {
            alert('Failed to update preference. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    })
    .finally(() => {
        button.disabled = false;
    });
}

function updateSelectedCount(count) {
    const countEl = document.getElementById('selectedCount');
    const noBadge = document.getElementById('noSelectionBadge');

    if (count > 0) {
        if (countEl) {
            countEl.textContent = count;
            countEl.closest('.badge').querySelector('.me-1').nextSibling.textContent =
                count === 1 ? ' category selected' : ' categories selected';
        } else if (noBadge) {
            // Replace "Using default prompts" with count badge
            noBadge.className = 'badge bg-success rounded-pill px-3 py-2';
            noBadge.id = '';
            noBadge.innerHTML = `<i class="bi bi-check-circle me-1"></i><span id="selectedCount">${count}</span> ${count === 1 ? 'category' : 'categories'} selected`;
        }
    } else {
        // Show "Using default prompts" badge
        if (countEl) {
            const badge = countEl.closest('.badge');
            badge.className = 'badge bg-secondary rounded-pill px-3 py-2';
            badge.id = 'noSelectionBadge';
            badge.innerHTML = '<i class="bi bi-info-circle me-1"></i>Using default prompts';
        }
    }
}
</script>
{% endblock %}
