{% extends 'dashboard/base_dashboard.html' %}
{% load static %}
{% load subscription_tags %}
{% load challenge_tags %}
{% load analytics_tags %}

{% block title %}Dashboard{% endblock %}

{% block dashboard_css %}
<link href="{% static 'css/layouts/dashboard.css' %}" rel="stylesheet">
<style>
.premium-locked {
    position: relative;
    overflow: hidden;
}
.premium-locked::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(8px);
    z-index: 10;
}
.premium-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 11;
    text-align: center;
    width: 90%;
}
.premium-badge {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Section Labels */
.section-label {
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #6b7280;
    margin-bottom: 0.75rem;
}

/* Modern Card Base */
.modern-card {
    background: white;
    border-radius: 16px;
    border: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow: hidden;
}

.modern-card .card-header {
    background: transparent;
    border-bottom: 1px solid #f3f4f6;
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #374151;
}

.modern-card .card-body {
    padding: 1.25rem;
}

/* Gradient Cards */
.gradient-card {
    border-radius: 16px;
    border: none;
    color: white;
    overflow: hidden;
}

.gradient-card.sentiment-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.gradient-card.mood-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.gradient-card.badges-card {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.gradient-card .card-header {
    background: rgba(255,255,255,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: white;
}

.gradient-card .card-header a {
    color: white;
    border-color: rgba(255,255,255,0.5);
}

.gradient-card .card-header a:hover {
    background: rgba(255,255,255,0.2);
    border-color: white;
    color: white;
}

.gradient-card .card-body {
    padding: 1.25rem;
}

/* Insights Pills */
.insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
}

.insight-pill {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    border: 1px solid #e2e8f0;
    transition: transform 0.2s, box-shadow 0.2s;
}

.insight-pill:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.insight-pill .insight-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.insight-pill .insight-icon.success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
.insight-pill .insight-icon.primary { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; }
.insight-pill .insight-icon.danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
.insight-pill .insight-icon.warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }

.insight-pill .insight-text {
    font-size: 0.9rem;
    color: #374151;
    line-height: 1.4;
}

.insight-pill .insight-detail {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

/* Capture Cards - Compact Gradient Style */
.capture-card {
    border-radius: 16px;
    border: none;
    color: white;
    overflow: hidden;
    height: 100%;
}

.capture-card.books-card {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
}

.capture-card.people-card {
    background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
}

.capture-card.media-card {
    background: linear-gradient(135deg, #14b8a6 0%, #2dd4bf 100%);
}

.capture-card.fitness-card {
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
}

.capture-card .card-header {
    background: rgba(255,255,255,0.15);
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding: 0.75rem 1rem;
    font-weight: 600;
    font-size: 0.9rem;
}

.capture-card .card-header a {
    color: white;
    border-color: rgba(255,255,255,0.4);
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.capture-card .card-header a:hover {
    background: rgba(255,255,255,0.2);
    color: white;
}

.capture-card .card-body {
    padding: 1rem;
}

.capture-card .stat-row {
    display: flex;
    justify-content: space-around;
    text-align: center;
    margin-bottom: 0.75rem;
}

.capture-card .stat-value {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
}

.capture-card .stat-label {
    font-size: 0.7rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.capture-card .capture-list {
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 0.75rem;
    margin-top: 0.5rem;
}

.capture-card .capture-list-label {
    font-size: 0.7rem;
    opacity: 0.8;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
}

.capture-card .capture-list-item {
    font-size: 0.85rem;
    padding: 0.25rem 0;
    opacity: 0.95;
}

/* Recent Entries Card */
.recent-entries-card {
    background: white;
    border-radius: 16px;
    border: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow: hidden;
}

.recent-entries-card .card-header {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    color: white;
    padding: 1rem 1.25rem;
    border: none;
}

.recent-entries-card .card-header a {
    color: white;
    border-color: rgba(255,255,255,0.4);
}

.recent-entries-card .list-group-item {
    border-left: none;
    border-right: none;
    padding: 0.875rem 1.25rem;
    transition: background 0.2s;
}

.recent-entries-card .list-group-item:hover {
    background: #f8fafc;
}

.recent-entries-card .list-group-item:first-child {
    border-top: none;
}

/* Quick Actions Card */
.quick-actions-card {
    background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    border-radius: 16px;
    border: none;
    color: white;
    overflow: hidden;
}

.quick-actions-card .card-header {
    background: rgba(255,255,255,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding: 1rem 1.25rem;
    font-weight: 600;
}

.quick-actions-card .card-body {
    padding: 1.25rem;
}

.quick-actions-card .btn {
    border-radius: 10px;
    padding: 0.75rem 1rem;
    font-weight: 500;
    transition: transform 0.2s, box-shadow 0.2s;
}

.quick-actions-card .btn-light {
    background: rgba(255,255,255,0.95);
    border: none;
    color: #0284c7;
}

.quick-actions-card .btn-light:hover {
    background: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.quick-actions-card .btn-outline-light {
    border-color: rgba(255,255,255,0.5);
    color: white;
}

.quick-actions-card .btn-outline-light:hover {
    background: rgba(255,255,255,0.15);
    border-color: white;
}

/* Travel Card */
.travel-card {
    background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
    border-radius: 16px;
    border: none;
    color: white;
    overflow: hidden;
    margin-top: 1rem;
}

.travel-card .card-header {
    background: rgba(255,255,255,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding: 0.75rem 1rem;
    font-weight: 600;
}

.travel-card .list-group-item {
    background: transparent;
    border-color: rgba(255,255,255,0.2);
    color: white;
    padding: 0.75rem 1rem;
}

/* Recent Badges List */
.recent-badges-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.recent-badge-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
}

.badge-icon-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.badge-icon-circle.badge-bronze { background: linear-gradient(135deg, #cd7f32, #a0522d); }
.badge-icon-circle.badge-silver { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); }
.badge-icon-circle.badge-gold { background: linear-gradient(135deg, #ffd700, #ffb800); }
.badge-icon-circle.badge-platinum { background: linear-gradient(135deg, #e5e4e2, #b0b0b0); }
.badge-icon-circle.badge-diamond { background: linear-gradient(135deg, #b9f2ff, #00bfff); }

.badge-info {
    flex: 1;
}

.badge-name-text {
    font-weight: 600;
    font-size: 0.9rem;
}

.badge-days-text {
    font-size: 0.75rem;
    opacity: 0.8;
}

/* Environmental Cards - Moon, Weather, Zodiac, Devotion */
.env-card {
    border-radius: 16px;
    border: none;
    overflow: hidden;
    height: 100%;
}

.env-card.moon-card {
    background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
    color: white;
}

.env-card.weather-card {
    background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%);
    color: white;
}

.env-card.zodiac-card {
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
    color: white;
}

.env-card.devotion-card {
    background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
    color: white;
}

.env-card-header {
    background: rgba(255,255,255,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding: 1rem 1.25rem;
    font-weight: 600;
}

.env-card-body {
    padding: 1.25rem;
    flex: 1;
}

/* Weather Conditions */
.weather-conditions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.weather-condition-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    transition: all 0.2s ease;
}

.weather-condition-item:hover {
    background: rgba(255,255,255,0.2);
    transform: translateX(3px);
}

.condition-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.condition-stats {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sentiment-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
}

.sentiment-badge.positive {
    background: rgba(74, 222, 128, 0.5);
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.sentiment-badge.negative {
    background: rgba(248, 113, 113, 0.5);
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.sentiment-badge.neutral {
    background: rgba(148, 163, 184, 0.5);
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

/* Zodiac Stats */
.zodiac-stats {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.zodiac-stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
}

/* Devotion Footer */
.devotion-footer {
    background: rgba(255,255,255,0.1);
    padding: 0.75rem 1.25rem;
    text-align: center;
    font-size: 0.8rem;
    opacity: 0.8;
}

/* Moon Phase Pills */
.moon-phases-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
}

.moon-phase-pill {
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 0.75rem 0.5rem;
    text-align: center;
    transition: transform 0.2s, background 0.2s;
    cursor: pointer;
}

.moon-phase-pill:hover {
    transform: translateY(-2px);
    background: rgba(255,255,255,0.2);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.moon-phase-pill .phase-emoji {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
}

.moon-phase-pill .phase-name {
    font-size: 0.65rem;
    opacity: 0.9;
    margin-bottom: 0.25rem;
}

.moon-phase-pill .phase-sentiment {
    font-size: 0.7rem;
    font-weight: 600;
}

.moon-phase-pill .phase-count {
    font-size: 0.6rem;
    opacity: 0.7;
}

.moon-phase-pill .phase-mood {
    font-size: 0.6rem;
    opacity: 0.8;
    margin-top: 0.25rem;
}

/* Weather Items */
.weather-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.weather-item:last-child {
    border-bottom: none;
}

/* Zodiac Display */
.zodiac-symbol {
    font-size: 4rem;
    text-align: center;
    margin-bottom: 0.5rem;
}

/* Devotion Card */
.devotion-verse {
    font-style: italic;
    padding: 1rem;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    margin: 1rem 0;
}

@media (max-width: 768px) {
    .moon-phases-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4 px-4">
    <h1 class="mb-4"><i class="bi bi-graph-up me-2"></i>Dashboard</h1>

    <!-- Insights Stats Grid -->
    <div class="section-label">Insights</div>
    <div class="stats-grid mb-4">
        <!-- Entries Card -->
        <div class="entries-card">
            <div class="entries-header">
                <div>
                    <div class="entries-count">{{ stats.total_entries|default:0 }}</div>
                    <div class="entries-label">Entr{{ stats.total_entries|default:0|pluralize:"y,ies" }}</div>
                </div>
            </div>
            <div class="chart-area">
                <canvas id="dashboardEntriesChart"></canvas>
            </div>
            <div class="year-tabs">
                <button class="year-tab" data-year="all">All-time</button>
                <button class="year-tab active" data-year="{{ current_year }}">{{ current_year }}</button>
                {% if current_year > 2024 %}
                <button class="year-tab" data-year="{{ current_year|add:'-1' }}">{{ current_year|add:'-1' }}</button>
                {% endif %}
            </div>
        </div>

        <!-- Words Card -->
        <div class="words-stats-card">
            <div class="words-label-top">Written</div>
            <div class="words-value">{{ stats.total_words|default:0|floatformat:0 }}</div>
            <div class="words-label">Words</div>
        </div>

        <!-- Perfect Months Card -->
        <div class="month-stats-card">
            <div class="month-label-top">Perfect</div>
            <div class="month-value">{{ stats.perfect_months|default:0 }}</div>
            <div class="month-label">Month{{ stats.perfect_months|default:0|pluralize }}</div>
        </div>

        <!-- Journaled Days Card -->
        <div class="journaled-stats-card">
            <div class="journaled-main">
                <div class="journaled-label-top">Journaled</div>
                <div class="journaled-value">{{ stats.journaled_days|default:0 }}</div>
                <div class="journaled-unit">Days</div>
            </div>
            <div class="journaled-breakdown">
                <div class="breakdown-item">
                    <div class="breakdown-value">{{ current_snapshot.entry_count|default:0 }}</div>
                    <div class="breakdown-label">This Month</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-value">{{ stats.entries_this_year|default:0 }}</div>
                    <div class="breakdown-label">This Year</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights Section -->
    {% if insights %}
    <div class="section-label">Discoveries</div>
    <div class="insights-grid mb-4">
        {% for insight in insights %}
        <div class="insight-pill">
            <div class="insight-icon {{ insight.color }}">
                <i class="{{ insight.icon }}"></i>
            </div>
            <div>
                <div class="insight-text">{{ insight.text|safe }}</div>
                {% if insight.detail %}
                <div class="insight-detail">{{ insight.detail }}</div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Active Challenges Widget -->
    {% active_challenges_widget %}

    <div class="section-label">Analytics</div>
    <div class="row g-4">
        <!-- Sentiment Trend Chart -->
        <div class="col-lg-5">
            <div class="gradient-card sentiment-card h-100">
                <div class="card-header">
                    <i class="bi bi-graph-up me-2"></i>Sentiment Trend
                </div>
                <div class="card-body">
                    <canvas id="sentimentChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Current Month Mood -->
        <div class="col-lg-3">
            <div class="gradient-card mood-card h-100">
                <div class="card-header">
                    <i class="bi bi-pie-chart me-2"></i>This Month's Mood
                </div>
                <div class="card-body">
                    {% if current_snapshot and current_snapshot.mood_distribution %}
                    <canvas id="moodChart" height="250"></canvas>
                    {% else %}
                    <div class="text-center py-5" style="opacity: 0.8;">
                        <i class="bi bi-bar-chart display-4"></i>
                        <p class="mt-2">No data yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Streak Badges -->
        <div class="col-lg-4">
            {% include 'accounts/badges/_badge_styles.html' %}
            <div class="gradient-card badges-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-award me-2"></i>Recent Badges</span>
                    <a href="{% url 'accounts:profile' %}#badges" class="btn btn-sm btn-outline-light">View All</a>
                </div>
                <div class="card-body">
                    {% if earned_badges %}
                    <div class="recent-badges-list">
                        {% for badge in earned_badges|slice:":3" %}
                        <div class="recent-badge-item">
                            <div class="badge-icon-circle badge-{{ badge.tier }}">
                                <i class="bi bi-{{ badge.icon }}"></i>
                            </div>
                            <div class="badge-info">
                                <div class="badge-name-text">{{ badge.name }}</div>
                                <div class="badge-days-text">{{ badge.days }} day streak</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if earned_badges|length > 3 %}
                    <p class="small mb-0 mt-2 text-center" style="opacity: 0.8;">+ {{ earned_badges|length|add:"-3" }} more badges earned</p>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-3" style="opacity: 0.8;">
                        <i class="bi bi-award display-4"></i>
                        <p class="mt-2 mb-0">No badges yet. Start your streak!</p>
                    </div>
                    {% endif %}
                    {% if next_badge %}
                    <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 0.75rem; margin-top: 0.75rem;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small>Next: <strong>{{ next_badge.name }}</strong></small>
                            <small class="badge" style="background: rgba(255,255,255,0.2);">{{ next_badge.days_remaining }} days</small>
                        </div>
                        <div class="progress" style="height: 8px; background: rgba(255,255,255,0.2);">
                            <div class="progress-bar" style="background: white; width: {{ next_badge.progress }}%;"></div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Capture Summary Cards -->
    <div class="section-label mt-4">Captures</div>
    <div class="row g-4">
        <!-- Books -->
        <div class="col-md-6 col-lg-3">
            <div class="capture-card books-card {% if user|user_is_free %}premium-locked{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-book me-2"></i>Books</span>
                    <a href="{% url 'analytics:books' %}" class="btn btn-sm btn-outline-light">View</a>
                </div>
                <div class="card-body">
                    <div class="stat-row">
                        <div>
                            <div class="stat-value">{{ books_reading|length }}</div>
                            <div class="stat-label">Reading</div>
                        </div>
                        <div>
                            <div class="stat-value">{{ books_finished_year }}</div>
                            <div class="stat-label">Finished</div>
                        </div>
                    </div>
                    {% if books_reading %}
                    <div class="capture-list">
                        <div class="capture-list-label">Currently reading</div>
                        {% for book in books_reading %}
                        <div class="capture-list-item"><i class="bi bi-book-half me-1"></i>{{ book.title|truncatewords:4 }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% if user|user_is_free %}
                <div class="premium-overlay">
                    <div class="premium-badge mb-2"><i class="bi bi-star-fill me-1"></i>Premium</div>
                    <a href="{% url 'accounts:upgrade' %}" class="btn btn-sm btn-warning text-dark">Upgrade</a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- People -->
        <div class="col-md-6 col-lg-3">
            <div class="capture-card people-card {% if user|user_is_free %}premium-locked{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-people me-2"></i>People</span>
                    <a href="{% url 'analytics:people' %}" class="btn btn-sm btn-outline-light">View</a>
                </div>
                <div class="card-body">
                    <div class="stat-row">
                        <div>
                            <div class="stat-value">{{ top_people|length }}</div>
                            <div class="stat-label">Tracked</div>
                        </div>
                    </div>
                    {% if top_people %}
                    <div class="capture-list">
                        <div class="capture-list-label">Most mentioned</div>
                        {% for person in top_people|slice:":3" %}
                        <div class="capture-list-item d-flex justify-content-between">
                            <span><i class="bi bi-person me-1"></i>{{ person.name }}</span>
                            <span style="opacity: 0.7;">{{ person.mention_count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% if user|user_is_free %}
                <div class="premium-overlay">
                    <div class="premium-badge mb-2"><i class="bi bi-star-fill me-1"></i>Premium</div>
                    <a href="{% url 'accounts:upgrade' %}" class="btn btn-sm btn-warning text-dark">Upgrade</a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Media Watched -->
        <div class="col-md-6 col-lg-3">
            <div class="capture-card media-card {% if user|user_is_free %}premium-locked{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-film me-2"></i>Media</span>
                    <a href="{% url 'analytics:media' %}" class="btn btn-sm btn-outline-light">View</a>
                </div>
                <div class="card-body">
                    <div class="stat-row">
                        <div>
                            <div class="stat-value">{{ watched_count_year }}</div>
                            <div class="stat-label">Watched {{ current_year }}</div>
                        </div>
                    </div>
                    {% if recent_watched %}
                    <div class="capture-list">
                        <div class="capture-list-label">Recently watched</div>
                        {% for item in recent_watched|slice:":3" %}
                        <div class="capture-list-item">
                            <i class="bi bi-{% if item.data.type == 'show' %}tv{% else %}camera-reels{% endif %} me-1"></i>
                            {{ item.data.title|default:"Untitled"|truncatewords:3 }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% if user|user_is_free %}
                <div class="premium-overlay">
                    <div class="premium-badge mb-2"><i class="bi bi-star-fill me-1"></i>Premium</div>
                    <a href="{% url 'accounts:upgrade' %}" class="btn btn-sm btn-warning text-dark">Upgrade</a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Fitness -->
        <div class="col-md-6 col-lg-3">
            <div class="capture-card fitness-card {% if user|user_is_free %}premium-locked{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-activity me-2"></i>Fitness</span>
                    <a href="{% url 'analytics:fitness' %}" class="btn btn-sm btn-outline-light">View</a>
                </div>
                <div class="card-body">
                    <div class="stat-row">
                        <div>
                            <div class="stat-value">{{ workout_count_year }}</div>
                            <div class="stat-label">Workouts {{ current_year }}</div>
                        </div>
                    </div>
                    <div class="capture-list">
                        {% if workout_count_year > 0 %}
                        <div class="text-center" style="opacity: 0.9;">
                            <i class="bi bi-trophy me-1"></i>Keep up the great work!
                        </div>
                        {% else %}
                        <div class="text-center" style="opacity: 0.8; font-size: 0.8rem;">
                            Use <code style="background: rgba(255,255,255,0.2); padding: 0.1rem 0.3rem; border-radius: 4px;">/workout</code> to track!
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% if user|user_is_free %}
                <div class="premium-overlay">
                    <div class="premium-badge mb-2"><i class="bi bi-star-fill me-1"></i>Premium</div>
                    <a href="{% url 'accounts:upgrade' %}" class="btn btn-sm btn-warning text-dark">Upgrade</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Environmental Insights (Moon, Weather, Zodiac, Devotion) -->
    {% if moon_correlation.phases or weather_correlation.conditions or zodiac_insights or daily_devotion %}
    <div class="section-label mt-4">Environmental Insights</div>
    <div class="row g-4">
        <!-- Moon Phase Patterns -->
        {% if moon_correlation.phases %}
        <div class="col-12">
            <div class="env-card moon-card position-relative {% if user|user_is_free %}premium-locked{% endif %}">
                <div class="env-card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-moon-stars me-2"></i>Lunar Mood Patterns</span>
                    <small style="opacity: 0.8;">{{ moon_correlation.total_entries }} entries</small>
                </div>
                <div class="env-card-body">
                    <!-- Moon Phase Pills Grid -->
                    <div class="moon-phases-grid">
                        {% for phase in moon_correlation.phases %}
                        <div class="moon-phase-pill" data-phase="{{ phase.phase }}" data-display-name="{{ phase.display_name }}" onclick="showMoonPhaseEntries('{{ phase.phase }}', '{{ phase.display_name }}')">
                            <div class="phase-emoji">
                                {% if phase.phase == 'full_moon' %}ðŸŒ•
                                {% elif phase.phase == 'new_moon' %}ðŸŒ‘
                                {% elif phase.phase == 'first_quarter' %}ðŸŒ“
                                {% elif phase.phase == 'last_quarter' %}ðŸŒ—
                                {% elif phase.phase == 'waxing_crescent' %}ðŸŒ’
                                {% elif phase.phase == 'waxing_gibbous' %}ðŸŒ”
                                {% elif phase.phase == 'waning_crescent' %}ðŸŒ˜
                                {% elif phase.phase == 'waning_gibbous' %}ðŸŒ–
                                {% endif %}
                            </div>
                            <div class="phase-name">{{ phase.display_name }}</div>
                            <div class="phase-sentiment" style="color: {% if phase.sentiment_label == 'positive' %}#4ade80{% elif phase.sentiment_label == 'negative' %}#f87171{% else %}#94a3b8{% endif %};">
                                {% if phase.avg_sentiment > 0 %}+{% endif %}{{ phase.avg_sentiment|floatformat:2 }}
                            </div>
                            <div class="phase-count">{{ phase.count }} entries</div>
                            {% if phase.display_mood %}
                            <div class="phase-mood">{{ phase.display_mood }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    {% if moon_correlation.insights %}
                    <div class="mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
                        {% for insight in moon_correlation.insights %}
                        <div class="small mb-1" style="opacity: 0.9;"><i class="bi bi-lightbulb me-1"></i>{{ insight }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% if user|user_is_free %}
                <div class="premium-overlay">
                    <div class="premium-badge mb-2"><i class="bi bi-star-fill me-1"></i>Premium</div>
                    <a href="{% url 'accounts:upgrade' %}" class="btn btn-sm btn-warning text-dark">Upgrade</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Weather Impact (requires at least 5 entries for meaningful data) -->
        {% if weather_correlation.total_entries >= 5 %}
        <div class="col-md-6 col-lg-4">
            <div class="env-card weather-card h-100 position-relative {% if user|user_is_free %}premium-locked{% endif %}">
                <div class="env-card-header">
                    <i class="bi bi-cloud-sun me-2"></i>Weather Impact
                </div>
                <div class="env-card-body">
                    <p class="small mb-3" style="opacity: 0.8;">How weather affects your mood</p>
                    <div class="weather-conditions">
                        {% for condition in weather_correlation.conditions|slice:":4" %}
                        <div class="weather-condition-item"
                             onclick="showWeatherEntries('{{ condition.condition }}', '{{ condition.display_name }}', '{{ condition.icon }}')"
                             style="cursor: pointer;" title="Click to see entries">
                            <div class="condition-info">
                                <i class="{{ condition.icon }} me-1"></i>
                                <span>{{ condition.display_name }}</span>
                                {% if condition.avg_temperature %}<small style="opacity: 0.7;">({{ condition.avg_temperature|temperature:user.profile.temperature_unit }})</small>{% endif %}
                            </div>
                            <div class="condition-stats">
                                <span class="sentiment-badge {% if condition.sentiment_label == 'positive' %}positive{% elif condition.sentiment_label == 'negative' %}negative{% else %}neutral{% endif %}">
                                    {% if condition.avg_sentiment > 0 %}+{% endif %}{{ condition.avg_sentiment|floatformat:2 }}
                                </span>
                                <small style="opacity: 0.6;">({{ condition.count }})</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if weather_correlation.insights %}
                    <div class="mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
                        {% for insight in weather_correlation.insights %}
                        <div class="small mb-1" style="opacity: 0.9;"><i class="bi bi-lightbulb me-1"></i>{{ insight }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% if user|user_is_free %}
                <div class="premium-overlay">
                    <div class="premium-badge mb-2"><i class="bi bi-star-fill me-1"></i>Premium</div>
                    <a href="{% url 'accounts:upgrade' %}" class="btn btn-sm btn-warning text-dark">Upgrade</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% elif not user.profile.city %}
        <!-- No city configured -->
        <div class="col-md-6 col-lg-4">
            <div class="env-card weather-card h-100" style="opacity: 0.7;">
                <div class="env-card-header">
                    <i class="bi bi-cloud-sun me-2"></i>Weather Impact
                </div>
                <div class="env-card-body text-center py-4">
                    <i class="bi bi-geo-alt" style="font-size: 2.5rem; opacity: 0.5;"></i>
                    <p class="mt-3 mb-2" style="opacity: 0.9;">Add your city to track weather</p>
                    <p class="small mb-3" style="opacity: 0.7;">See how weather conditions affect your mood patterns</p>
                    <a href="{% url 'accounts:profile' %}#city" class="btn btn-sm btn-outline-light">
                        <i class="bi bi-gear me-1"></i>Configure in Settings
                    </a>
                </div>
            </div>
        </div>
        {% elif weather_correlation.total_entries < 5 %}
        <!-- Has city but not enough data yet -->
        <div class="col-md-6 col-lg-4">
            <div class="env-card weather-card h-100" style="opacity: 0.7;">
                <div class="env-card-header">
                    <i class="bi bi-cloud-sun me-2"></i>Weather Impact
                </div>
                <div class="env-card-body text-center py-4">
                    <i class="bi bi-hourglass-split" style="font-size: 2.5rem; opacity: 0.5;"></i>
                    <p class="mt-3 mb-2" style="opacity: 0.9;">Collecting weather data...</p>
                    <p class="small mb-0" style="opacity: 0.7;">
                        {{ weather_correlation.total_entries }} of 5 entries needed
                    </p>
                    <div class="progress mt-2" style="height: 6px; background: rgba(255,255,255,0.2);">
                        <div class="progress-bar bg-info" style="width: {{ weather_correlation.total_entries|default:0 }}0%;"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Zodiac Insights -->
        {% if zodiac_insights %}
        <div class="col-md-6 col-lg-4">
            <div class="env-card zodiac-card h-100 position-relative {% if user|user_is_free %}premium-locked{% endif %}">
                <div class="env-card-header">
                    <i class="bi bi-stars me-2"></i>{{ zodiac_insights.display_name }}
                </div>
                <div class="env-card-body">
                    <div class="text-center mb-3">
                        <span style="font-size: 3rem;">{{ zodiac_insights.symbol }}</span>
                        <p class="small mb-0" style="opacity: 0.7;">{{ zodiac_insights.element|title }} Sign</p>
                    </div>
                    <div class="zodiac-stats">
                        <div class="zodiac-stat-row">
                            <span style="opacity: 0.8;">Avg Sentiment</span>
                            <span class="sentiment-badge {% if zodiac_insights.avg_sentiment > 0.05 %}positive{% elif zodiac_insights.avg_sentiment < -0.05 %}negative{% else %}neutral{% endif %}">
                                {% if zodiac_insights.avg_sentiment > 0 %}+{% endif %}{{ zodiac_insights.avg_sentiment|floatformat:2 }}
                            </span>
                        </div>
                        <div class="zodiac-stat-row">
                            <span style="opacity: 0.8;">Dominant Mood</span>
                            <span>{{ zodiac_insights.dominant_mood|title }}</span>
                        </div>
                    </div>
                    {% if zodiac_insights.insights %}
                    <div class="mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
                        {% for insight in zodiac_insights.insights %}
                        <div class="small mb-1" style="opacity: 0.9;"><i class="bi bi-lightbulb me-1"></i>{{ insight }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% if user|user_is_free %}
                <div class="premium-overlay">
                    <div class="premium-badge mb-2"><i class="bi bi-star-fill me-1"></i>Premium</div>
                    <a href="{% url 'accounts:upgrade' %}" class="btn btn-sm btn-warning text-dark">Upgrade</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Daily Devotion -->
        {% if daily_devotion %}
        <div class="col-md-6 col-lg-4">
            <div class="env-card devotion-card h-100">
                <div class="env-card-header">
                    <i class="bi bi-book me-2"></i>Daily Devotion
                </div>
                <div class="env-card-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-quote" style="font-size: 2rem; opacity: 0.7;"></i>
                        <p class="small mb-0" style="opacity: 0.8;">{{ daily_devotion.theme }}</p>
                    </div>
                    <h6 class="mb-2" style="color: #fbbf24;">{{ daily_devotion.reference }}</h6>
                    <p class="fst-italic mb-3 small" style="opacity: 0.9;">"{{ daily_devotion.verse }}"</p>
                    <div class="pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
                        <p class="small mb-0" style="opacity: 0.85;">{{ daily_devotion.reflection }}</p>
                    </div>
                </div>
                <div class="devotion-footer">
                    <i class="bi bi-calendar3 me-1"></i>Day {{ daily_devotion.day_number }} of the year
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Recent Entries & Quick Links -->
    <div class="section-label mt-4">Activity</div>
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="recent-entries-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-clock-history me-2"></i>Recent Entries</span>
                    <a href="{% url 'journal:entry_list' %}" class="btn btn-sm btn-outline-light">View All</a>
                </div>
                <ul class="list-group list-group-flush">
                    {% for entry in recent_entries %}
                    <li class="list-group-item">
                        <a href="{% url 'journal:entry_detail' entry.pk %}" class="text-decoration-none">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="me-2">{{ entry.mood_emoji }}</span>
                                    <strong class="text-dark">{{ entry.entry_date|date:"M j" }}</strong>
                                    {% if entry.title %}<span class="text-muted"> - {{ entry.title }}</span>{% endif %}
                                </div>
                                {% if entry.analysis %}
                                <span class="badge badge-mood-{{ entry.analysis.detected_mood }}">
                                    {{ entry.analysis.detected_mood }}
                                </span>
                                {% endif %}
                            </div>
                        </a>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-center text-muted py-4">
                        No entries yet. <a href="{% url 'journal:entry_create' %}">Write your first entry!</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="quick-actions-card">
                <div class="card-header">
                    <i class="bi bi-lightning me-2"></i>Quick Actions
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'journal:entry_create' %}" class="btn btn-light">
                            <i class="bi bi-plus-circle me-2"></i>New Entry
                        </a>
                        {% if user|user_is_premium %}
                        <a href="{% url 'analytics:yearly' current_year %}" class="btn btn-outline-light">
                            <i class="bi bi-calendar-check me-2"></i>{{ current_year }} Year in Review
                        </a>
                        {% else %}
                        <a href="{% url 'accounts:upgrade' %}" class="btn btn-outline-light">
                            <i class="bi bi-star me-2"></i>{{ current_year }} Year in Review
                            <span class="badge" style="background: rgba(255,255,255,0.2);">Premium</span>
                        </a>
                        {% endif %}
                        {% if current_snapshot %}
                            {% if user|user_is_premium %}
                            <a href="{% url 'analytics:monthly' current_year current_month %}" class="btn btn-outline-light">
                                <i class="bi bi-calendar-month me-2"></i>This Month Details
                            </a>
                            {% else %}
                            <a href="{% url 'accounts:upgrade' %}" class="btn btn-outline-light">
                                <i class="bi bi-star me-2"></i>This Month Details
                                <span class="badge" style="background: rgba(255,255,255,0.2);">Premium</span>
                            </a>
                            {% endif %}
                        {% endif %}
                        {% if user|user_is_premium %}
                        <a href="{% url 'analytics:captures' %}" class="btn btn-outline-light">
                            <i class="bi bi-collection me-2"></i>All Captures
                        </a>
                        {% else %}
                        <a href="{% url 'accounts:upgrade' %}" class="btn btn-outline-light">
                            <i class="bi bi-star me-2"></i>All Captures
                            <span class="badge" style="background: rgba(255,255,255,0.2);">Premium</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Travel Section (if any) -->
            {% if travel_entries %}
            <div class="travel-card">
                <div class="card-header">
                    <i class="bi bi-geo-alt me-2"></i>Places Visited ({{ current_year }})
                </div>
                <ul class="list-group list-group-flush">
                    {% for entry in travel_entries|slice:":3" %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span><i class="bi bi-pin-map me-1"></i>{{ entry.data.location|default:entry.data.name|default:"Unknown" }}</span>
                        <small style="opacity: 0.7;">{{ entry.entry.entry_date|date:"M j" }}</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Moon Phase Entries Modal -->
<div class="modal fade" id="moonPhaseModal" tabindex="-1" aria-labelledby="moonPhaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%); color: white;">
                <h5 class="modal-title" id="moonPhaseModalLabel">
                    <span id="moonPhaseEmoji" class="me-2"></span>
                    <span id="moonPhaseName">Moon Phase</span> Entries
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="moonPhaseLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading entries...</p>
                </div>
                <div id="moonPhaseEntries" class="d-none">
                    <div class="p-3 bg-light border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <span id="moonPhaseCount" class="text-muted small"></span>
                            <div id="moonPhaseMoodSummary" class="d-flex gap-2"></div>
                        </div>
                    </div>
                    <div class="list-group list-group-flush" id="moonPhaseEntriesList">
                        <!-- Entries will be populated here -->
                    </div>
                </div>
                <div id="moonPhaseEmpty" class="text-center py-5 d-none">
                    <i class="bi bi-moon text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">No entries found for this moon phase</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Weather Entries Modal -->
<div class="modal fade" id="weatherModal" tabindex="-1" aria-labelledby="weatherModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white;">
                <h5 class="modal-title" id="weatherModalLabel">
                    <i id="weatherIcon" class="bi bi-cloud-sun me-2"></i>
                    <span id="weatherName">Weather</span> Entries
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="weatherLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading entries...</p>
                </div>
                <div id="weatherEntries" class="d-none">
                    <div class="p-3 bg-light border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <span id="weatherCount" class="text-muted small"></span>
                            <div id="weatherMoodSummary" class="d-flex gap-2"></div>
                        </div>
                    </div>
                    <div class="list-group list-group-flush" id="weatherEntriesList">
                        <!-- Entries will be populated here -->
                    </div>
                </div>
                <div id="weatherEmpty" class="text-center py-5 d-none">
                    <i class="bi bi-cloud text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">No entries found for this weather condition</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock dashboard_content %}

{% block dashboard_js %}
<script>
// Dashboard Entries Chart
const dashboardChartCtx = document.getElementById('dashboardEntriesChart');
if (dashboardChartCtx) {
    const currentMonth = new Date().getMonth();

    // Data for different year selections
    const dashboardChartData = {
        '{{ current_year }}': {
            data: {{ monthly_entry_counts|default:"[0,0,0,0,0,0,0,0,0,0,0,0]"|safe }},
            count: {{ stats.entries_this_year|default:0 }}
        },
        '{{ current_year|add:"-1" }}': {
            data: {{ monthly_entry_counts_prev_year|default:"[0,0,0,0,0,0,0,0,0,0,0,0]"|safe }},
            count: {{ stats.entries_prev_year|default:0 }}
        },
        'all': {
            data: {{ monthly_entry_counts_all_time|default:"[0,0,0,0,0,0,0,0,0,0,0,0]"|safe }},
            count: {{ stats.total_entries|default:0 }}
        }
    };

    const dashboardEntriesChart = new Chart(dashboardChartCtx, {
        type: 'bar',
        data: {
            labels: ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'],
            datasets: [{
                data: dashboardChartData['{{ current_year }}'].data,
                backgroundColor: dashboardChartData['{{ current_year }}'].data.map((_, i) =>
                    i === currentMonth ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.4)'
                ),
                borderRadius: 4,
                barThickness: 12
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    display: true,
                    grid: { display: false },
                    ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } }
                },
                y: {
                    display: true,
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: 'rgba(255,255,255,0.7)', stepSize: 10 }
                }
            }
        }
    });

    // Year tab click handlers
    document.querySelectorAll('.entries-card .year-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.entries-card .year-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Get selected year
            const year = this.dataset.year;
            const yearData = dashboardChartData[year];

            if (yearData) {
                // Update chart data
                dashboardEntriesChart.data.datasets[0].data = yearData.data;
                // Highlight current month only for current year
                dashboardEntriesChart.data.datasets[0].backgroundColor = yearData.data.map((_, i) =>
                    (year === '{{ current_year }}' && i === currentMonth) ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.4)'
                );
                dashboardEntriesChart.update();

                // Update entries count
                const countEl = document.querySelector('.entries-count');
                const labelEl = document.querySelector('.entries-label');
                if (countEl) countEl.textContent = yearData.count;
                if (labelEl) labelEl.textContent = yearData.count === 1 ? 'Entry' : 'Entries';
            }
        });
    });
}

// Sentiment Trend Chart
const sentimentCtx = document.getElementById('sentimentChart');
if (sentimentCtx) {
    const snapshots = {{ snapshots_json|safe }};
    const labels = snapshots.map(s => s.month_name + ' ' + s.year);
    const data = snapshots.map(s => s.avg_sentiment);

    new Chart(sentimentCtx, {
        type: 'line',
        data: {
            labels: labels.length ? labels : ['No data'],
            datasets: [{
                label: 'Average Sentiment',
                data: data.length ? data : [0],
                borderColor: 'rgba(255,255,255,0.9)',
                backgroundColor: 'rgba(255,255,255,0.1)',
                fill: true,
                tension: 0.3,
                pointBackgroundColor: 'white',
                pointBorderColor: 'white'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: 'rgba(255,255,255,0.7)' }
                },
                y: {
                    min: -1,
                    max: 1,
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: {
                        color: 'rgba(255,255,255,0.7)',
                        callback: function(value) {
                            if (value === 0) return 'Neutral';
                            if (value === 1) return 'Positive';
                            if (value === -1) return 'Negative';
                            return value;
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// Mood Distribution Chart
const moodCtx = document.getElementById('moodChart');
if (moodCtx) {
    const moodData = {{ mood_distribution_json|safe }};
    const moodLabels = Object.keys(moodData);
    const moodValues = Object.values(moodData);

    if (moodLabels.length > 0) {
        const moodColors = {
            'ecstatic': '#a855f7',
            'happy': '#22c55e',
            'neutral': '#6b7280',
            'sad': '#3b82f6',
            'angry': '#ef4444'
        };

        new Chart(moodCtx, {
            type: 'doughnut',
            data: {
                labels: moodLabels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                datasets: [{
                    data: moodValues,
                    backgroundColor: moodLabels.map(l => moodColors[l] || '#6b7280'),
                    borderColor: 'rgba(255,255,255,0.2)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'rgba(255,255,255,0.9)',
                            padding: 10,
                            font: { size: 11 }
                        }
                    }
                }
            }
        });
    }
}

// Moon Phase Entries Modal
const moonPhaseEmojis = {
    'full_moon': 'ðŸŒ•',
    'new_moon': 'ðŸŒ‘',
    'first_quarter': 'ðŸŒ“',
    'last_quarter': 'ðŸŒ—',
    'waxing_crescent': 'ðŸŒ’',
    'waxing_gibbous': 'ðŸŒ”',
    'waning_crescent': 'ðŸŒ˜',
    'waning_gibbous': 'ðŸŒ–'
};

function showMoonPhaseEntries(phase, displayName) {
    const modal = new bootstrap.Modal(document.getElementById('moonPhaseModal'));
    const loadingEl = document.getElementById('moonPhaseLoading');
    const entriesEl = document.getElementById('moonPhaseEntries');
    const emptyEl = document.getElementById('moonPhaseEmpty');
    const listEl = document.getElementById('moonPhaseEntriesList');
    const countEl = document.getElementById('moonPhaseCount');
    const moodSummaryEl = document.getElementById('moonPhaseMoodSummary');

    // Set header
    document.getElementById('moonPhaseEmoji').textContent = moonPhaseEmojis[phase] || 'ðŸŒ™';
    document.getElementById('moonPhaseName').textContent = displayName;

    // Show loading, hide others
    loadingEl.classList.remove('d-none');
    entriesEl.classList.add('d-none');
    emptyEl.classList.add('d-none');

    modal.show();

    // Fetch entries
    fetch(`/dashboard/api/moon-phase/${phase}/entries/`)
        .then(response => response.json())
        .then(data => {
            loadingEl.classList.add('d-none');

            if (data.entries && data.entries.length > 0) {
                entriesEl.classList.remove('d-none');
                countEl.textContent = `${data.count} entries in the last 180 days`;

                // Calculate mood summary
                const moodCounts = {};
                data.entries.forEach(entry => {
                    if (entry.mood) {
                        moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
                    }
                });

                // Display mood summary
                moodSummaryEl.innerHTML = Object.entries(moodCounts)
                    .sort((a, b) => b[1] - a[1])
                    .map(([mood, count]) => {
                        const colors = {
                            'ecstatic': '#22c55e',
                            'happy': '#84cc16',
                            'neutral': '#94a3b8',
                            'sad': '#f59e0b',
                            'angry': '#ef4444'
                        };
                        return `<span class="badge" style="background: ${colors[mood] || '#94a3b8'};">${mood}: ${count}</span>`;
                    }).join('');

                // Display entries
                listEl.innerHTML = data.entries.map(entry => `
                    <a href="${entry.url}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="me-2" style="font-size: 1.25rem;">${entry.mood_emoji}</span>
                                    <h6 class="mb-0">${entry.title}</h6>
                                </div>
                                <p class="mb-1 text-muted small">${entry.preview}</p>
                            </div>
                            <div class="text-end ms-3">
                                <small class="text-muted d-block">${entry.date}</small>
                                <span class="badge ${entry.sentiment >= 0 ? 'bg-success' : 'bg-danger'}">${entry.sentiment >= 0 ? '+' : ''}${entry.sentiment}</span>
                            </div>
                        </div>
                    </a>
                `).join('');
            } else {
                emptyEl.classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('Error fetching moon phase entries:', error);
            loadingEl.classList.add('d-none');
            emptyEl.classList.remove('d-none');
        });
}

function showWeatherEntries(condition, displayName, iconClass) {
    const modal = new bootstrap.Modal(document.getElementById('weatherModal'));
    const loadingEl = document.getElementById('weatherLoading');
    const entriesEl = document.getElementById('weatherEntries');
    const emptyEl = document.getElementById('weatherEmpty');
    const listEl = document.getElementById('weatherEntriesList');
    const countEl = document.getElementById('weatherCount');
    const moodSummaryEl = document.getElementById('weatherMoodSummary');

    // Set header
    document.getElementById('weatherIcon').className = iconClass + ' me-2';
    document.getElementById('weatherName').textContent = displayName;

    // Show loading, hide others
    loadingEl.classList.remove('d-none');
    entriesEl.classList.add('d-none');
    emptyEl.classList.add('d-none');

    modal.show();

    // Fetch entries
    fetch(`/dashboard/api/weather/${condition}/entries/`)
        .then(response => response.json())
        .then(data => {
            loadingEl.classList.add('d-none');

            if (data.entries && data.entries.length > 0) {
                entriesEl.classList.remove('d-none');
                countEl.textContent = `${data.count} entries in the last 180 days`;

                // Calculate mood summary
                const moodCounts = {};
                data.entries.forEach(entry => {
                    if (entry.mood) {
                        moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
                    }
                });

                // Display mood summary
                moodSummaryEl.innerHTML = Object.entries(moodCounts)
                    .sort((a, b) => b[1] - a[1])
                    .map(([mood, count]) => {
                        const colors = {
                            'ecstatic': '#22c55e',
                            'happy': '#84cc16',
                            'neutral': '#94a3b8',
                            'sad': '#f59e0b',
                            'angry': '#ef4444'
                        };
                        return `<span class="badge" style="background: ${colors[mood] || '#94a3b8'};">${mood}: ${count}</span>`;
                    }).join('');

                // Display entries
                listEl.innerHTML = data.entries.map(entry => `
                    <a href="${entry.url}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="me-2" style="font-size: 1.25rem;">${entry.mood_emoji}</span>
                                    <h6 class="mb-0">${entry.title}</h6>
                                </div>
                                <p class="mb-1 text-muted small">${entry.preview}</p>
                            </div>
                            <div class="text-end ms-3">
                                <small class="text-muted d-block">${entry.date}</small>
                                ${entry.temperature ? `<small class="text-muted d-block">${entry.temperature}Â°${entry.temp_unit}</small>` : ''}
                                <span class="badge ${entry.sentiment >= 0 ? 'bg-success' : 'bg-danger'}">${entry.sentiment >= 0 ? '+' : ''}${entry.sentiment}</span>
                            </div>
                        </div>
                    </a>
                `).join('');
            } else {
                emptyEl.classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('Error fetching weather entries:', error);
            loadingEl.classList.add('d-none');
            emptyEl.classList.remove('d-none');
        });
}
</script>
{% endblock dashboard_js %}
