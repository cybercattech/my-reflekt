{% extends 'dashboard/base_dashboard.html' %}
{% load analytics_tags %}
{% load subscription_tags %}

{% block title %}{{ year }} Year in Review{% endblock %}

{% block dashboard_css %}
<style>
/* Modern Stats Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    border-radius: 16px;
    padding: 1.5rem;
    color: white;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.stat-card.entries {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
}

.stat-card.words {
    background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
}

.stat-card.sentiment {
    background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
}

.stat-card.mood {
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
}

.stat-card .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.stat-card .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Gradient Chart Cards */
.chart-card {
    border-radius: 16px;
    border: none;
    overflow: hidden;
}

.chart-card.mood-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.chart-card.sentiment-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.chart-card .card-header {
    background: rgba(255,255,255,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: white;
}

.chart-card .card-body {
    padding: 1.25rem;
}

/* Mood Distribution Items */
.mood-dist-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
}

.mood-dist-item .mood-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.mood-dist-item .mood-bar {
    flex: 1;
    height: 8px;
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
    margin: 0 1rem;
    overflow: hidden;
}

.mood-dist-item .mood-bar-fill {
    height: 100%;
    background: white;
    border-radius: 4px;
}

.mood-dist-item .mood-count {
    background: rgba(255,255,255,0.2);
    padding: 0.2rem 0.5rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
}

/* Highlight/Lowlight Cards */
.highlight-card {
    background: white;
    border-radius: 16px;
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    overflow: hidden;
}

.highlight-card .card-header {
    background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
    color: white;
    padding: 1rem 1.25rem;
    font-weight: 600;
    border: none;
}

.lowlight-card {
    background: white;
    border-radius: 16px;
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    overflow: hidden;
}

.lowlight-card .card-header {
    background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
    color: white;
    padding: 1rem 1.25rem;
    font-weight: 600;
    border: none;
}

/* Insights Card */
.insights-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 16px;
    border: 1px solid #7dd3fc;
    padding: 1.25rem;
}

.insights-card h6 {
    color: #0369a1;
}

/* Themes Card - Gradient Style */
.themes-card {
    background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
    border-radius: 16px;
    border: none;
    overflow: hidden;
    color: white;
}

.themes-card .card-header {
    background: rgba(255,255,255,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: white;
}

.themes-card .card-body {
    padding: 1.25rem;
}

/* Theme Badge Styling - White pills with sentiment */
.theme-badge {
    display: inline-flex;
    align-items: center;
    background: white;
    border-radius: 50px;
    padding: 0.5rem 1rem;
    color: #6366f1;
    font-size: 0.9rem;
    gap: 0.5rem;
}

.theme-name {
    font-weight: 600;
}

.theme-sentiment {
    padding: 0.15rem 0.5rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    background: #e0e7ff;
    color: #4f46e5;
}

.theme-sentiment.positive {
    background: #dcfce7;
    color: #16a34a;
}

.theme-sentiment.negative {
    background: #fee2e2;
    color: #dc2626;
}

.theme-sentiment.neutral {
    background: #f3f4f6;
    color: #6b7280;
}

.entry-item {
    transition: background 0.2s;
}

.entry-item:hover {
    background-color: #f8fafc;
}

/* Premium Locked */
.premium-content-locked {
    position: relative;
    min-height: 500px;
}
.premium-content-locked::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    z-index: 10;
}
.premium-unlock-banner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 11;
    text-align: center;
    background: white;
    padding: 3rem;
    border-radius: 1rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    max-width: 500px;
    width: 90%;
}

/* Responsive */
@media (max-width: 992px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 576px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
.entry-content {
    line-height: 1.7;
    font-size: 1rem;
}
.entry-content h1, .entry-content h2, .entry-content h3,
.entry-content h4, .entry-content h5, .entry-content h6 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}
.entry-content h1 { font-size: 1.5rem; }
.entry-content h2 { font-size: 1.35rem; }
.entry-content h3 { font-size: 1.2rem; }
.entry-content p {
    margin-bottom: 0.75rem;
}
.entry-content ul, .entry-content ol {
    margin-bottom: 0.75rem;
    padding-left: 1.5rem;
}
.entry-content blockquote {
    border-left: 3px solid #dee2e6;
    padding-left: 1rem;
    margin: 0.75rem 0;
    color: #6c757d;
}
.entry-content code {
    background-color: #f8f9fa;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}
.entry-content pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    overflow-x: auto;
}
.entry-content pre code {
    background: none;
    padding: 0;
}
.entry-content strong, .entry-content b {
    font-weight: 600;
}
.entry-content em, .entry-content i {
    font-style: italic;
}
.entry-content hr {
    margin: 1rem 0;
    border-top: 1px solid #dee2e6;
}
.entry-content a {
    color: #0d6efd;
    text-decoration: none;
}
.entry-content a:hover {
    text-decoration: underline;
}
.entry-content .admonition {
    margin: 1rem 0;
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
}
.entry-content .admonition-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <h1 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Year in Review</h1>
            {% if available_years %}
            <select class="form-select form-select-lg" id="yearSelector" style="width: auto;">
                {% for y in available_years %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
            {% endif %}
        </div>
    </div>

    {% if not is_premium %}
    <!-- Free user: Show locked overlay -->
    <div class="premium-content-locked">
        <!-- Blurred preview content -->
        <div style="filter: blur(5px); opacity: 0.3; pointer-events: none;">
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="display-5 text-primary">124</h3>
                            <p class="text-muted mb-0">Total Entries</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="display-5 text-success">45,678</h3>
                            <p class="text-muted mb-0">Words Written</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="display-5 text-success">+0.45</h3>
                            <p class="text-muted mb-0">Avg Sentiment</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="display-5">üòä</h3>
                            <p class="text-muted mb-0">Dominant Mood</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upgrade banner -->
        <div class="premium-unlock-banner">
            <div class="mb-3">
                <i class="bi bi-star-fill text-warning" style="font-size: 3rem;"></i>
            </div>
            <h3 class="mb-3">Unlock Your Year in Review</h3>
            <p class="text-muted mb-4">
                See your complete {{ year }} journey with detailed insights, trends, and highlights from all your journal entries.
            </p>
            <a href="{% url 'accounts:upgrade' %}" class="btn btn-warning btn-lg text-dark">
                <i class="bi bi-unlock me-2"></i>Upgrade to Premium
            </a>
        </div>
    </div>
    {% else %}
    <!-- Premium user: Show actual content -->

    {% if review %}
    <!-- Overview Stats -->
    <div class="stats-grid">
        <div class="stat-card entries">
            <div class="stat-value">{{ review.total_entries }}</div>
            <div class="stat-label">Total Entries</div>
        </div>
        <div class="stat-card words">
            <div class="stat-value">{{ review.total_words|floatformat:0 }}</div>
            <div class="stat-label">Words Written</div>
        </div>
        <div class="stat-card sentiment">
            <div class="stat-value">{% if review.avg_sentiment > 0 %}+{% endif %}{{ review.avg_sentiment|floatformat:2 }}</div>
            <div class="stat-label">Avg Sentiment</div>
        </div>
        <div class="stat-card mood">
            <div class="stat-value">
                {% if review.dominant_mood == 'ecstatic' %}ü§©
                {% elif review.dominant_mood == 'happy' %}üòä
                {% elif review.dominant_mood == 'neutral' %}üòê
                {% elif review.dominant_mood == 'sad' %}üò¢
                {% elif review.dominant_mood == 'angry' %}üò†
                {% endif %}
            </div>
            <div class="stat-label">{{ review.dominant_mood|title }} Year</div>
        </div>
    </div>

    <!-- Mood Distribution & Sentiment Trend -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="chart-card mood-card h-100">
                <div class="card-header">
                    <i class="bi bi-pie-chart me-2"></i>Mood Distribution
                </div>
                <div class="card-body">
                    {% for mood, count in review.mood_distribution.items %}
                    <div class="mood-dist-item">
                        <div class="mood-info">
                            <span>
                                {% if mood == 'ecstatic' %}ü§©
                                {% elif mood == 'happy' %}üòä
                                {% elif mood == 'neutral' %}üòê
                                {% elif mood == 'sad' %}üò¢
                                {% elif mood == 'angry' %}üò†
                                {% endif %}
                            </span>
                            <span>{{ mood|title }}</span>
                        </div>
                        <div class="mood-bar">
                            <div class="mood-bar-fill" style="width: {% widthratio count review.total_entries 100 %}%;"></div>
                        </div>
                        <span class="mood-count">{{ count }}</span>
                    </div>
                    {% empty %}
                    <p class="text-center mb-0" style="opacity: 0.8;">No mood data available</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="chart-card sentiment-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-graph-up me-2"></i>Monthly Sentiment Trend</span>
                    <small style="opacity: 0.8;">Avg. positivity by month</small>
                </div>
                <div class="card-body">
                    <canvas id="monthlyTrendChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Themes -->
    {% if review.top_themes %}
    <div class="themes-card mb-4">
        <div class="card-header">
            <i class="bi bi-tags me-2"></i>Top Themes This Year
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-3">
                {% for theme in review.top_themes %}
                <div class="theme-badge">
                    <span class="theme-name">{{ theme|clean_theme }}</span>
                    {% if theme in review.theme_sentiments %}
                    <span class="theme-sentiment {% if review.theme_sentiments|get_item:theme > 0 %}positive{% elif review.theme_sentiments|get_item:theme < 0 %}negative{% else %}neutral{% endif %}">
                        {% if review.theme_sentiments|get_item:theme > 0 %}+{% endif %}{{ review.theme_sentiments|get_item:theme|floatformat:2 }}
                    </span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Highlights & Lowlights -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="highlight-card h-100">
                <div class="card-header">
                    <i class="bi bi-star me-2"></i>Top Highlights
                </div>
                <ul class="list-group list-group-flush">
                    {% for day in review.highlights|slice:":5" %}
                    <li class="list-group-item entry-item" data-entry-id="{{ day.id }}" style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ day.date|format_iso_date }}</strong>
                                <span class="ms-2">
                                    {% if day.mood == 'ecstatic' %}ü§©
                                    {% elif day.mood == 'happy' %}üòä
                                    {% elif day.mood == 'neutral' %}üòê
                                    {% elif day.mood == 'sad' %}üò¢
                                    {% elif day.mood == 'angry' %}üò†
                                    {% endif %}
                                </span>
                                <p class="mb-0 text-muted small mt-1">{{ day.preview|truncatewords:20 }}</p>
                            </div>
                            <span class="badge bg-success">+{{ day.sentiment|floatformat:2 }}</span>
                        </div>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted text-center py-4">No highlights yet</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="lowlight-card h-100">
                <div class="card-header">
                    <i class="bi bi-cloud-rain me-2"></i>Challenging Days
                </div>
                <ul class="list-group list-group-flush">
                    {% for day in review.lowlights|slice:":5" %}
                    <li class="list-group-item entry-item" data-entry-id="{{ day.id }}" style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ day.date|format_iso_date }}</strong>
                                <span class="ms-2">
                                    {% if day.mood == 'ecstatic' %}ü§©
                                    {% elif day.mood == 'happy' %}üòä
                                    {% elif day.mood == 'neutral' %}üòê
                                    {% elif day.mood == 'sad' %}üò¢
                                    {% elif day.mood == 'angry' %}üò†
                                    {% endif %}
                                </span>
                                <p class="mb-0 text-muted small mt-1">{{ day.preview|truncatewords:20 }}</p>
                            </div>
                            <span class="badge bg-secondary">{{ day.sentiment|floatformat:2 }}</span>
                        </div>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted text-center py-4">No data</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Insights -->
    {% if review.insights %}
    <div class="insights-card mb-4">
        <h6><i class="bi bi-lightbulb me-2"></i>Key Insights</h6>
        <ul class="mb-0" style="color: #0369a1;">
            {% for insight in review.insights %}
            <li class="mb-2">{{ insight }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Regenerate -->
    <div class="text-center mt-4">
        <form method="post" action="{% url 'analytics:regenerate_yearly' year %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-clockwise me-1"></i>Regenerate Review
            </button>
        </form>
        <p class="text-muted small mt-2">Last generated: {{ review.generated_at|date:"F j, Y g:i a" }}</p>
    </div>

    {% else %}
    <!-- No Review Yet -->
    <div class="text-center py-5">
        <div class="display-1 text-muted mb-3">
            <i class="bi bi-calendar-x"></i>
        </div>
        <h3>No Review Available</h3>
        <p class="text-muted mb-4">
            You need analyzed journal entries from {{ year }} to generate a year-in-review.
        </p>
        <a href="{% url 'journal:entry_create' %}" class="btn btn-primary">
            Start Writing
        </a>
    </div>
    {% endif %}

<!-- Entry View/Edit Modal -->
<div class="modal fade" id="entryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title mb-0" id="entryModalDate"></h5>
                    <small class="text-muted" id="entryModalMeta"></small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- View Mode -->
                <div id="entryViewMode">
                    <div id="entryContent" class="entry-content"></div>

                    <!-- Analysis Info -->
                    <div id="entryAnalysis" class="mt-4 pt-3 border-top" style="display: none;">
                        <div class="row g-3">
                            <div class="col-auto">
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-emoji-smile me-1"></i>
                                    <span id="analysisMood"></span>
                                </span>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-graph-up me-1"></i>
                                    Sentiment: <span id="analysisSentiment"></span>
                                </span>
                            </div>
                            <div class="col-12" id="analysisThemesContainer" style="display: none;">
                                <small class="text-muted">Themes: </small>
                                <span id="analysisThemes"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Mode -->
                <div id="entryEditMode" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">Title (optional)</label>
                        <input type="text" class="form-control" id="editEntryTitle" placeholder="Entry title...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Content</label>
                        <textarea class="form-control" id="editEntryContent" rows="15" style="font-family: inherit;"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mood</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="editMood" id="moodEcstatic" value="ecstatic">
                            <label class="btn btn-outline-secondary" for="moodEcstatic">ü§©</label>
                            <input type="radio" class="btn-check" name="editMood" id="moodHappy" value="happy">
                            <label class="btn btn-outline-secondary" for="moodHappy">üòä</label>
                            <input type="radio" class="btn-check" name="editMood" id="moodNeutral" value="neutral">
                            <label class="btn btn-outline-secondary" for="moodNeutral">üòê</label>
                            <input type="radio" class="btn-check" name="editMood" id="moodSad" value="sad">
                            <label class="btn btn-outline-secondary" for="moodSad">üò¢</label>
                            <input type="radio" class="btn-check" name="editMood" id="moodAngry" value="angry">
                            <label class="btn btn-outline-secondary" for="moodAngry">üò†</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <input type="hidden" id="currentEntryId">

                <!-- View Mode Buttons -->
                <div id="viewModeButtons">
                    <a href="#" id="openEntryLink" class="btn btn-outline-secondary me-auto">
                        <i class="bi bi-box-arrow-up-right me-1"></i>Open Full
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="editEntryBtn">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                </div>

                <!-- Edit Mode Buttons -->
                <div id="editModeButtons" style="display: none;">
                    <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEntryBtn">
                        <i class="bi bi-check-lg me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %} <!-- End premium check -->
</div> <!-- End container-fluid -->
{% endblock dashboard_content %}

{% block dashboard_js %}
{% if review and monthly_trend_json %}
<script>
// Monthly Trend Chart - White on gradient background
const ctx = document.getElementById('monthlyTrendChart');
if (ctx) {
    const trend = {{ monthly_trend_json|safe }};
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: trend.map(t => t.month_name),
            datasets: [{
                label: 'Sentiment',
                data: trend.map(t => t.sentiment),
                borderColor: 'rgba(255,255,255,0.9)',
                backgroundColor: 'rgba(255,255,255,0.1)',
                fill: true,
                tension: 0.3,
                pointBackgroundColor: 'white',
                pointBorderColor: 'white'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: 'rgba(255,255,255,0.8)' }
                },
                y: {
                    min: -1,
                    max: 1,
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: {
                        color: 'rgba(255,255,255,0.8)',
                        callback: function(value) {
                            if (value === 0) return 'Neutral';
                            if (value === 1) return 'Positive';
                            if (value === -1) return 'Negative';
                            return '';
                        }
                    }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

// Entry Modal Handling
document.addEventListener('DOMContentLoaded', function() {
    const entryModal = new bootstrap.Modal(document.getElementById('entryModal'));
    let currentEntryData = null;

    // Click handlers for entry items
    document.querySelectorAll('.entry-item').forEach(item => {
        item.addEventListener('click', function() {
            const entryId = this.dataset.entryId;
            loadEntry(entryId);
        });
    });

    // Load entry details
    async function loadEntry(entryId) {
        try {
            const resp = await fetch(`/journal/api/entry/${entryId}/detail/`);
            if (!resp.ok) throw new Error('Failed to load entry');

            const data = await resp.json();
            currentEntryData = data;
            document.getElementById('currentEntryId').value = data.id;

            // Populate view mode
            document.getElementById('entryModalDate').textContent = data.entry_date_display;
            document.getElementById('entryModalMeta').textContent =
                `${data.mood_emoji} ${data.word_count} words`;

            // Use rendered HTML if available, fallback to raw content
            const contentEl = document.getElementById('entryContent');
            if (data.content_html) {
                contentEl.innerHTML = data.content_html;
            } else {
                // Fallback: escape HTML and preserve line breaks
                contentEl.innerHTML = data.content
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>');
            }

            document.getElementById('openEntryLink').href = data.detail_url;

            // Show analysis if available
            const analysisEl = document.getElementById('entryAnalysis');
            if (data.analysis) {
                analysisEl.style.display = 'block';
                document.getElementById('analysisMood').textContent =
                    data.analysis.detected_mood.charAt(0).toUpperCase() + data.analysis.detected_mood.slice(1);

                const sentiment = data.analysis.sentiment_score;
                document.getElementById('analysisSentiment').textContent =
                    (sentiment >= 0 ? '+' : '') + sentiment.toFixed(2);

                // Themes
                const themesContainer = document.getElementById('analysisThemesContainer');
                if (data.analysis.themes && data.analysis.themes.length > 0) {
                    themesContainer.style.display = 'block';
                    document.getElementById('analysisThemes').innerHTML =
                        data.analysis.themes.map(t =>
                            `<span class="badge bg-primary me-1">${t}</span>`
                        ).join('');
                } else {
                    themesContainer.style.display = 'none';
                }
            } else {
                analysisEl.style.display = 'none';
            }

            // Reset to view mode
            showViewMode();
            entryModal.show();

        } catch (e) {
            console.error('Error loading entry:', e);
            alert('Failed to load entry');
        }
    }

    // Switch to edit mode
    document.getElementById('editEntryBtn').addEventListener('click', function() {
        if (!currentEntryData) return;

        // Populate edit fields
        document.getElementById('editEntryTitle').value = currentEntryData.title || '';
        document.getElementById('editEntryContent').value = currentEntryData.content;

        // Set mood radio
        if (currentEntryData.mood) {
            const moodRadio = document.querySelector(`input[name="editMood"][value="${currentEntryData.mood}"]`);
            if (moodRadio) moodRadio.checked = true;
        }

        showEditMode();
    });

    // Cancel edit
    document.getElementById('cancelEditBtn').addEventListener('click', function() {
        showViewMode();
    });

    // Save changes
    document.getElementById('saveEntryBtn').addEventListener('click', async function() {
        const entryId = document.getElementById('currentEntryId').value;
        const mood = document.querySelector('input[name="editMood"]:checked')?.value || '';

        const data = {
            title: document.getElementById('editEntryTitle').value,
            content: document.getElementById('editEntryContent').value,
            mood: mood
        };

        try {
            const resp = await fetch(`/journal/api/entry/${entryId}/update/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (resp.ok) {
                // Update the view with new content
                currentEntryData.content = data.content;
                currentEntryData.title = data.title;
                currentEntryData.mood = data.mood;

                document.getElementById('entryContent').textContent = data.content;
                showViewMode();

                // Show success feedback
                const btn = document.getElementById('saveEntryBtn');
                btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Saved!';
                setTimeout(() => {
                    btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Save Changes';
                }, 1500);
            } else {
                alert('Failed to save changes');
            }
        } catch (e) {
            console.error('Error saving:', e);
            alert('Failed to save changes');
        }
    });

    function showViewMode() {
        document.getElementById('entryViewMode').style.display = 'block';
        document.getElementById('entryEditMode').style.display = 'none';
        document.getElementById('viewModeButtons').style.display = 'flex';
        document.getElementById('editModeButtons').style.display = 'none';
    }

    function showEditMode() {
        document.getElementById('entryViewMode').style.display = 'none';
        document.getElementById('entryEditMode').style.display = 'block';
        document.getElementById('viewModeButtons').style.display = 'none';
        document.getElementById('editModeButtons').style.display = 'flex';
    }
});
</script>
{% endif %}

<script>
// Year selector navigation
document.addEventListener('DOMContentLoaded', function() {
    const yearSelector = document.getElementById('yearSelector');
    if (yearSelector) {
        yearSelector.addEventListener('change', function() {
            const selectedYear = this.value;
            window.location.href = '/dashboard/year/' + selectedYear + '/';
        });
    }
});
</script>
{% endblock dashboard_js %}
