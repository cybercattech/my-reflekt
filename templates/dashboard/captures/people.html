{% extends 'dashboard/base_dashboard.html' %}

{% block title %}People Dashboard{% endblock %}

{% block dashboard_css %}
<style>
    /* Modern Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        border-radius: 16px;
        padding: 1.5rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .stat-card.people {
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
    }

    .stat-card.mentions {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }

    .stat-card.average {
        background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
    }

    .stat-card .stat-label {
        font-size: 0.85rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }

    .stat-card .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
    }

    .stat-card .stat-sub {
        font-size: 0.8rem;
        opacity: 0.75;
        margin-top: 0.25rem;
    }

    .stat-card .stat-icon {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 2rem;
        opacity: 0.3;
    }

    /* Modern Chart Card */
    .chart-card {
        background: white;
        border-radius: 16px;
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .chart-card .card-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid #e2e8f0;
        padding: 1rem 1.25rem;
        font-weight: 600;
        color: #374151;
    }

    .chart-card .card-body {
        padding: 1.25rem;
    }

    /* Modern List Card */
    .list-card {
        background: white;
        border-radius: 16px;
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .list-card .card-header {
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        color: white;
        padding: 1rem 1.25rem;
        font-weight: 600;
        border: none;
    }

    .list-card .table {
        margin-bottom: 0;
    }

    .list-card .table thead {
        background: #f8fafc;
    }

    .list-card .table th {
        font-weight: 600;
        color: #6b7280;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom-width: 1px;
    }

    .list-card .table td {
        vertical-align: middle;
    }

    .person-row:hover {
        background-color: #f8fafc;
        cursor: pointer;
    }

    .person-row:hover td:first-child strong {
        color: #4f46e5;
        text-decoration: underline;
    }

    /* Tips Card */
    .tips-card {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-radius: 16px;
        border: 1px solid #bbf7d0;
        padding: 1.25rem;
    }

    .tips-card h6 {
        color: #166534;
    }

    .tips-card p {
        color: #15803d;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock dashboard_css %}

{% block dashboard_content %}
<div class="container-fluid py-4 px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="{% url 'analytics:captures' %}">Captures</a></li>
                    <li class="breadcrumb-item active">People</li>
                </ol>
            </nav>
            <h1><i class="bi bi-people me-2"></i>People & Social</h1>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-grid">
        <div class="stat-card people">
            <div class="stat-label">Total People</div>
            <div class="stat-value">{{ total_people }}</div>
            <div class="stat-sub">tracked connections</div>
            <i class="bi bi-people stat-icon"></i>
        </div>
        <div class="stat-card mentions">
            <div class="stat-label">Total Mentions</div>
            <div class="stat-value">{{ total_mentions }}</div>
            <div class="stat-sub">across all entries</div>
            <i class="bi bi-chat-dots stat-icon"></i>
        </div>
        <div class="stat-card average">
            <div class="stat-label">Avg Mentions/Person</div>
            <div class="stat-value">
                {% if total_people > 0 %}{{ total_mentions|divisibleby:total_people|floatformat:1 }}{% else %}0{% endif %}
            </div>
            <i class="bi bi-graph-up stat-icon"></i>
        </div>
    </div>

    <div class="row g-4">
        <!-- People by Relationship Chart -->
        <div class="col-lg-4">
            <div class="chart-card h-100">
                <div class="card-header">
                    <i class="bi bi-pie-chart me-2"></i>By Relationship
                </div>
                <div class="card-body">
                    {% if has_relationship_data %}
                    <canvas id="relationshipChart" height="250"></canvas>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-people display-4"></i>
                        <p class="mt-2">No relationship data yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Monthly Mentions Trend -->
        <div class="col-lg-8">
            <div class="chart-card h-100">
                <div class="card-header">
                    <i class="bi bi-graph-up me-2"></i>Mentions Over Time
                </div>
                <div class="card-body">
                    {% if has_monthly_mentions %}
                    <canvas id="trendChart" height="250"></canvas>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-graph-up display-4"></i>
                        <p class="mt-2">No trend data yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- All People List -->
    <div class="list-card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list me-2"></i>All People</span>
            <span class="badge bg-white text-success">{{ total_people }} total</span>
        </div>
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-hover mb-0">
                <thead class="sticky-top bg-white">
                    <tr>
                        <th>Name</th>
                        <th>Relationship</th>
                        <th>Mentions</th>
                        <th>First Seen</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for person in people %}
                    <tr class="person-row" style="cursor: pointer;" data-person-id="{{ person.pk }}">
                        <td>
                            <strong>{{ person.name }}</strong>
                            {% if person.sentiment == 'love' %}
                            <i class="bi bi-heart-fill text-danger ms-1" title="Love"></i>
                            {% elif person.sentiment == 'like' %}
                            <i class="bi bi-hand-thumbs-up-fill text-success ms-1" title="Like"></i>
                            {% elif person.sentiment == 'dislike' %}
                            <i class="bi bi-hand-thumbs-down-fill text-warning ms-1" title="Dislike"></i>
                            {% elif person.sentiment == 'hate' %}
                            <i class="bi bi-heartbreak-fill text-dark ms-1" title="Hate"></i>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{% if person.relationship == 'partner' %}info{% elif person.relationship == 'family' %}danger{% elif person.relationship == 'friend' %}success{% elif person.relationship == 'colleague' %}primary{% else %}secondary{% endif %}">
                                {{ person.get_relationship_display }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark">{{ person.mention_count }}</span>
                        </td>
                        <td>
                            {% if person.first_mention_date %}
                            {{ person.first_mention_date|date:"M j, Y" }}
                            {% else %}
                            --
                            {% endif %}
                        </td>
                        <td>
                            {% if person.last_mention_date %}
                            {{ person.last_mention_date|date:"M j, Y" }}
                            {% else %}
                            --
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            No people tracked yet. Use <code>/person</code> in your entries to track people!
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tips Card -->
    <div class="tips-card mt-4">
        <h6><i class="bi bi-lightbulb me-2"></i>Tips for Tracking People</h6>
        <p class="mb-0">
            Use <code>/person "Name" context</code> in your journal entries to track who you spent time with.
            The system will automatically match similar names (e.g., "John" and "John Smith").
        </p>
    </div>
</div>

<!-- Person Edit Modal -->
<div class="modal fade" id="personEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-gear me-2"></i>Edit Person</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPersonId">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control" id="editPersonName">
                </div>
                <div class="mb-3">
                    <label class="form-label">Relationship</label>
                    <select class="form-select" id="editPersonRelationship">
                        <option value="partner">Partner</option>
                        <option value="family">Family</option>
                        <option value="friend">Friend</option>
                        <option value="colleague">Colleague</option>
                        <option value="acquaintance">Acquaintance</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">How do you feel about this person?</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="sentiment" id="sentLove" value="love">
                        <label class="btn btn-outline-danger" for="sentLove" title="Love">
                            <i class="bi bi-heart-fill"></i>
                        </label>
                        <input type="radio" class="btn-check" name="sentiment" id="sentLike" value="like">
                        <label class="btn btn-outline-success" for="sentLike" title="Like">
                            <i class="bi bi-hand-thumbs-up-fill"></i>
                        </label>
                        <input type="radio" class="btn-check" name="sentiment" id="sentNeutral" value="neutral">
                        <label class="btn btn-outline-secondary" for="sentNeutral" title="Neutral">
                            <i class="bi bi-dash-circle"></i>
                        </label>
                        <input type="radio" class="btn-check" name="sentiment" id="sentDislike" value="dislike">
                        <label class="btn btn-outline-warning" for="sentDislike" title="Dislike">
                            <i class="bi bi-hand-thumbs-down-fill"></i>
                        </label>
                        <input type="radio" class="btn-check" name="sentiment" id="sentHate" value="hate">
                        <label class="btn btn-outline-dark" for="sentHate" title="Hate">
                            <i class="bi bi-heartbreak-fill"></i>
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="editPersonNotes" rows="3" placeholder="Any notes about this person..."></textarea>
                </div>
                <div class="text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    <span id="personStats"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger me-auto" id="deletePersonBtn">
                    <i class="bi bi-trash me-1"></i>Delete
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePersonBtn">
                    <i class="bi bi-check-lg me-1"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock dashboard_content %}

{% block dashboard_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Person Edit Modal
    const personModal = new bootstrap.Modal(document.getElementById('personEditModal'));
    let currentPersonId = null;

    document.querySelectorAll('.person-row').forEach(row => {
        row.addEventListener('click', function() {
            currentPersonId = this.dataset.personId;
            loadPersonDetails(currentPersonId);
        });
    });

    window.loadPersonDetails = loadPersonDetails;
    window.currentPersonId = null;

    async function loadPersonDetails(personId) {
        window.currentPersonId = personId;
        try {
            const resp = await fetch(`/dashboard/api/person/${personId}/`);
            const data = await resp.json();

            document.getElementById('editPersonId').value = data.id;
            document.getElementById('editPersonName').value = data.name;
            document.getElementById('editPersonRelationship').value = data.relationship;
            document.getElementById('editPersonNotes').value = data.notes || '';

            // Set sentiment
            const sentValue = data.sentiment || 'neutral';
            const sentRadio = document.querySelector(`input[name="sentiment"][value="${sentValue}"]`);
            if (sentRadio) sentRadio.checked = true;

            // Stats
            const stats = [];
            if (data.mention_count) stats.push(`${data.mention_count} mentions`);
            if (data.first_mention_date) stats.push(`First: ${data.first_mention_date}`);
            if (data.last_mention_date) stats.push(`Last: ${data.last_mention_date}`);
            document.getElementById('personStats').textContent = stats.join(' | ') || 'No mentions yet';

            personModal.show();
        } catch (e) {
            console.error('Failed to load person:', e);
            alert('Failed to load person details');
        }
    }

    document.getElementById('savePersonBtn').addEventListener('click', async function() {
        const sentiment = document.querySelector('input[name="sentiment"]:checked')?.value || 'neutral';

        const data = {
            name: document.getElementById('editPersonName').value,
            relationship: document.getElementById('editPersonRelationship').value,
            sentiment: sentiment,
            notes: document.getElementById('editPersonNotes').value
        };

        try {
            const resp = await fetch(`/dashboard/api/person/${window.currentPersonId}/update/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (resp.ok) {
                personModal.hide();
                location.reload();
            } else {
                alert('Failed to save changes');
            }
        } catch (e) {
            console.error('Save failed:', e);
            alert('Failed to save changes');
        }
    });

    document.getElementById('deletePersonBtn').addEventListener('click', async function() {
        if (!confirm('Delete this person? This cannot be undone.')) return;

        try {
            const resp = await fetch(`/dashboard/api/person/${window.currentPersonId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (resp.ok) {
                personModal.hide();
                location.reload();
            } else {
                alert('Failed to delete');
            }
        } catch (e) {
            console.error('Delete failed:', e);
            alert('Failed to delete');
        }
    });
}); // End DOMContentLoaded

// Relationship Chart
const relationshipCtx = document.getElementById('relationshipChart');
if (relationshipCtx) {
    {% if has_relationship_data %}
    const relData = {{ by_relationship|safe }};
    const relLabels = Object.keys(relData);
    const relValues = Object.values(relData);
    const relColors = {
        'Partner': '#ec4899',
        'Family': '#ef4444',
        'Friend': '#22c55e',
        'Colleague': '#3b82f6',
        'Acquaintance': '#f59e0b',
        'Other': '#6b7280'
    };

    new Chart(relationshipCtx, {
        type: 'doughnut',
        data: {
            labels: relLabels,
            datasets: [{
                data: relValues,
                backgroundColor: relLabels.map(l => relColors[l] || '#6b7280')
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    {% endif %}
}

// Monthly Trend Chart
const trendCtx = document.getElementById('trendChart');
if (trendCtx) {
    {% if has_monthly_mentions %}
    const trendData = {{ monthly_mentions|safe }};
    const trendLabels = trendData.map(d => {
        const date = new Date(d.month);
        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    });
    const trendValues = trendData.map(d => d.count);

    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: trendLabels,
            datasets: [{
                label: 'Mentions',
                data: trendValues,
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    {% endif %}
}

</script>
{% endblock dashboard_js %}
