{% extends 'dashboard/base_dashboard.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ goal.title }}{% endblock %}

{% block dashboard_css %}
<link href="{% static 'css/pages/fitness.css' %}" rel="stylesheet">
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4 px-4">
    <div class="mb-4">
        <a href="{% url 'wellness:fitness_goals' %}" class="text-muted text-decoration-none small">
            <i class="bi bi-arrow-left me-1"></i> Back to Goals
        </a>
    </div>

    <!-- Goal Header -->
    <div class="goal-detail-header">
        <div class="goal-title-row">
            <div>
                <h1 class="goal-title">{{ goal.title }}</h1>
                <p class="goal-subtitle">
                    <i class="{{ goal.icon }} me-1"></i>{{ goal.get_goal_type_display }}
                    {% if goal.is_cardio_combo %}
                        <span class="text-muted">- {{ goal.target_distance }} mi in {{ goal.target_time_display }}</span>
                    {% endif %}
                    {% if goal.is_completed %}
                        <span class="badge bg-success ms-2">Completed</span>
                    {% elif not goal.is_active %}
                        <span class="badge bg-secondary ms-2">Paused</span>
                    {% endif %}
                </p>
            </div>
            <div class="d-flex gap-2">
                {% if not goal.is_completed %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#progressModal">
                    <i class="bi bi-plus-lg me-1"></i> Log Progress
                </button>
                {% endif %}
                <a href="{% url 'wellness:edit_fitness_goal' goal.pk %}" class="btn btn-outline-secondary">
                    <i class="bi bi-pencil me-1"></i> Edit
                </a>
                <a href="{% url 'wellness:delete_fitness_goal' goal.pk %}" class="btn btn-outline-danger">
                    <i class="bi bi-trash me-1"></i> Delete
                </a>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-section mb-4">
            <div class="progress-info">
                <span class="progress-current" style="font-size: 2rem;">
                    {% if goal.current_value %}{{ goal.current_value|floatformat:1 }}{% else %}--{% endif %}
                </span>
                <span class="progress-target" style="font-size: 1.1rem;">
                    / {{ goal.target_value|floatformat:1 }} {{ goal.unit }}
                </span>
            </div>
            <div class="progress-bar-container" style="height: 12px;">
                <div class="progress-bar {{ goal.on_track_status }}"
                     style="width: {{ goal.progress_percentage }}%"></div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="goal-detail-stats">
            <div class="detail-stat">
                <div class="stat-value">{{ goal.progress_percentage|floatformat:0 }}%</div>
                <div class="stat-label">Progress</div>
            </div>
            <div class="detail-stat">
                <div class="stat-value">{% if goal.days_remaining %}{{ goal.days_remaining }}{% else %}--{% endif %}</div>
                <div class="stat-label">Days Left</div>
            </div>
            <div class="detail-stat">
                <div class="stat-value">{{ goal.days_elapsed }}</div>
                <div class="stat-label">Days Elapsed</div>
            </div>
            <div class="detail-stat">
                <div class="stat-value {% if goal.is_on_track %}text-success{% elif goal.is_on_track == False %}text-danger{% endif %}">
                    {% if goal.on_track_status == 'ahead' %}
                        <i class="bi bi-arrow-up-circle-fill"></i>
                    {% elif goal.on_track_status == 'behind' %}
                        <i class="bi bi-arrow-down-circle-fill"></i>
                    {% elif goal.on_track_status == 'on_track' %}
                        <i class="bi bi-check-circle-fill"></i>
                    {% else %}
                        <i class="bi bi-dash-circle"></i>
                    {% endif %}
                </div>
                <div class="stat-label">
                    {% if goal.on_track_status == 'ahead' %}Ahead
                    {% elif goal.on_track_status == 'behind' %}Behind
                    {% elif goal.on_track_status == 'on_track' %}On Track
                    {% else %}Unknown{% endif %}
                </div>
            </div>
        </div>

        <!-- Schedule Status -->
        {% if goal.variance_from_schedule is not None %}
        <div class="schedule-status {{ goal.on_track_status }} mt-3" style="display: inline-flex;">
            {% if goal.on_track_status == 'ahead' %}
                <i class="bi bi-check-circle-fill"></i>
                <span>{{ goal.variance_display }} ahead of schedule</span>
            {% elif goal.on_track_status == 'behind' %}
                <i class="bi bi-exclamation-circle-fill"></i>
                <span>{{ goal.variance_display }} behind schedule</span>
            {% else %}
                <i class="bi bi-check-circle"></i>
                <span>On track for {{ goal.target_date|date:"M j, Y" }}</span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="row">
        <!-- Progress Chart -->
        <div class="col-lg-8 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h5 class="chart-title"><i class="bi bi-graph-up me-2"></i>Progress Over Time</h5>
                </div>
                <div class="chart-canvas-wrapper" style="height: 300px;">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Goal Details -->
        <div class="col-lg-4 mb-4">
            <div class="fitness-form-card">
                <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i>Goal Details</h5>

                <div class="mb-3">
                    <small class="text-muted">Start Value</small>
                    <div class="fw-bold">{{ goal.start_value|floatformat:1 }} {{ goal.unit }}</div>
                </div>

                <div class="mb-3">
                    <small class="text-muted">Target Value</small>
                    <div class="fw-bold">{{ goal.target_value|floatformat:1 }} {{ goal.unit }}</div>
                </div>

                {% if goal.is_cardio_combo %}
                <div class="mb-3">
                    <small class="text-muted">Target Distance</small>
                    <div class="fw-bold">{{ goal.target_distance }} miles</div>
                </div>

                <div class="mb-3">
                    <small class="text-muted">Target Time</small>
                    <div class="fw-bold">{{ goal.target_time_display }}</div>
                </div>
                {% endif %}

                <div class="mb-3">
                    <small class="text-muted">Expected Today</small>
                    <div class="fw-bold">
                        {% if goal.expected_value_today %}{{ goal.expected_value_today|floatformat:1 }} {{ goal.unit }}{% else %}--{% endif %}
                    </div>
                </div>

                <hr>

                <div class="mb-3">
                    <small class="text-muted">Start Date</small>
                    <div class="fw-bold">{{ goal.start_date|date:"M j, Y" }}</div>
                </div>

                <div class="mb-3">
                    <small class="text-muted">Target Date</small>
                    <div class="fw-bold">{{ goal.target_date|date:"M j, Y" }}</div>
                </div>

                {% if goal.notes %}
                <hr>
                <div>
                    <small class="text-muted">Notes</small>
                    <div>{{ goal.notes }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Progress History -->
    <div class="progress-history-table">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Progress History</h5>
        </div>

        {% if progress_entries %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Value</th>
                        <th>Change</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in progress_entries %}
                    <tr>
                        <td>{{ entry.logged_at|date:"M j, Y g:i A" }}</td>
                        <td><strong>{{ entry.value|floatformat:1 }} {{ goal.unit }}</strong></td>
                        <td>
                            {% if forloop.last %}
                                <span class="text-muted">Starting</span>
                            {% else %}
                                {% with prev=progress_entries|slice:forloop.counter|last %}
                                    {% if prev %}
                                        {% widthratio entry.value 1 1 as current %}
                                        {% widthratio prev.value 1 1 as previous %}
                                    {% endif %}
                                {% endwith %}
                                <span class="text-muted">--</span>
                            {% endif %}
                        </td>
                        <td class="text-muted">{{ entry.notes|default:"--" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <i class="bi bi-clipboard-data" style="font-size: 2rem; opacity: 0.3;"></i>
            <p class="mt-2 mb-0">No progress logged yet</p>
            <button class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#progressModal">
                <i class="bi bi-plus-lg me-1"></i> Log First Progress
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Log Progress Modal -->
<div class="modal fade fitness-modal" id="progressModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-graph-up-arrow me-2"></i>Log Progress
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Current Value ({{ goal.unit }})</label>
                    <input type="number" class="form-control form-control-lg" id="progressValue"
                           step="0.01" placeholder="Enter current value" autofocus>
                    <small class="text-muted">
                        Previous: {% if goal.current_value %}{{ goal.current_value|floatformat:1 }}{% else %}--{% endif %} |
                        Target: {{ goal.target_value|floatformat:1 }} {{ goal.unit }}
                    </small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-control" id="progressNotes" rows="2"
                              placeholder="Any notes about this progress..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProgress()">
                    <i class="bi bi-check-lg me-1"></i> Save Progress
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock dashboard_content %}

{% block dashboard_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart data from server
const progressData = {{ progress_chart|safe }};
const expectedLine = {{ expected_line|safe }};

function initProgressChart() {
    const ctx = document.getElementById('progressChart').getContext('2d');

    if (progressData.length === 0 && expectedLine.length === 0) {
        ctx.font = '14px system-ui';
        ctx.fillStyle = '#6b7280';
        ctx.textAlign = 'center';
        ctx.fillText('Log progress to see your chart', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
    }

    const datasets = [];

    // Actual progress line
    if (progressData.length > 0) {
        datasets.push({
            label: 'Actual Progress',
            data: progressData.map(d => ({ x: d.date, y: d.value })),
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 6,
            pointHoverRadius: 8
        });
    }

    // Expected line (dashed)
    if (expectedLine.length > 0) {
        datasets.push({
            label: 'Expected Progress',
            data: expectedLine.map(d => ({ x: d.date, y: d.value })),
            borderColor: '#9ca3af',
            borderDash: [5, 5],
            fill: false,
            tension: 0,
            pointRadius: 0
        });
    }

    new Chart(ctx, {
        type: 'line',
        data: { datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                x: {
                    type: 'category',
                    grid: { display: false }
                },
                y: {
                    beginAtZero: false,
                    grid: { color: '#f3f4f6' }
                }
            }
        }
    });
}

function saveProgress() {
    const value = document.getElementById('progressValue').value;
    const notes = document.getElementById('progressNotes').value;

    if (!value) {
        alert('Please enter a value');
        return;
    }

    fetch('{% url "wellness:api_update_fitness_goal_progress" pk=goal.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            value: parseFloat(value),
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('progressModal')).hide();
            if (data.is_completed) {
                alert('Congratulations! You achieved your goal!');
            }
            location.reload();
        } else {
            alert(data.error || 'Error saving progress');
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initProgressChart();
});
</script>
{% endblock %}
