{% extends 'dashboard/base_dashboard.html' %}
{% load static %}
{% load humanize %}

{% block title %}Cardio Log{% endblock %}

{% block dashboard_css %}
<link href="{% static 'css/pages/fitness.css' %}" rel="stylesheet">
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{% url 'wellness:fitness_dashboard' %}" class="text-muted text-decoration-none small">
                <i class="bi bi-arrow-left me-1"></i> Back to Fitness
            </a>
            <h1 class="mb-0 mt-2"><i class="bi bi-stopwatch me-2"></i>Cardio Log</h1>
        </div>
        <button class="btn btn-success rounded-pill" data-bs-toggle="modal" data-bs-target="#cardioModal">
            <i class="bi bi-plus-lg me-1"></i> Log Cardio
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="fitness-stats-row">
        <div class="fitness-stat-card cardio">
            <div class="stat-icon">
                <i class="bi bi-signpost-2"></i>
            </div>
            <div class="stat-value">{{ total_distance }}</div>
            <div class="stat-label">total miles</div>
        </div>

        <div class="fitness-stat-card weight">
            <div class="stat-icon">
                <i class="bi bi-clock"></i>
            </div>
            <div class="stat-value">{{ total_time }}</div>
            <div class="stat-label">total minutes</div>
        </div>

        <div class="fitness-stat-card measurement">
            <div class="stat-icon">
                <i class="bi bi-speedometer2"></i>
            </div>
            <div class="stat-value">
                {% if avg_pace %}
                    {{ avg_pace|floatformat:1 }}
                {% else %}
                    --
                {% endif %}
            </div>
            <div class="stat-label">avg pace (min/mi)</div>
        </div>

        <div class="fitness-stat-card goal">
            <div class="stat-icon">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div class="stat-value">{{ logs|length }}</div>
            <div class="stat-label">workouts</div>
        </div>
    </div>

    <div class="row">
        <!-- Chart -->
        <div class="col-lg-8 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h5 class="chart-title"><i class="bi bi-graph-up me-2"></i>Distance & Pace</h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="activityFilter" style="width: auto;"
                                onchange="filterActivity(this.value)">
                            <option value="">All Activities</option>
                            {% for value, label in activity_choices %}
                            <option value="{{ value }}" {% if activity_filter == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        <div class="chart-period-selector">
                            <button class="chart-period-btn" data-days="30">30D</button>
                            <button class="chart-period-btn active" data-days="90">90D</button>
                            <button class="chart-period-btn" data-days="180">6M</button>
                        </div>
                    </div>
                </div>
                <div class="chart-canvas-wrapper">
                    <canvas id="cardioChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Activity Summary -->
        <div class="col-lg-4 mb-4">
            <div class="fitness-form-card">
                <h5 class="mb-3"><i class="bi bi-bar-chart me-2"></i>Activity Breakdown</h5>
                <div id="activityBreakdown">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Activity History -->
    <div class="cardio-history">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Activity History</h5>
            <select class="form-select form-select-sm" style="width: auto;" onchange="filterDays(this.value)">
                <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 days</option>
                <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 days</option>
                <option value="180" {% if days == 180 %}selected{% endif %}>Last 6 months</option>
                <option value="365" {% if days == 365 %}selected{% endif %}>Last year</option>
            </select>
        </div>

        {% if logs %}
            {% for log in logs %}
            <div class="cardio-entry">
                <div class="activity-icon">
                    <i class="{{ log.icon }}"></i>
                </div>
                <div class="activity-details">
                    <div class="activity-type">{{ log.activity_display }}</div>
                    <div class="activity-date">{{ log.logged_at|date:"M j, Y g:i A" }}</div>
                </div>
                <div class="activity-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ log.distance }}</div>
                        <div class="stat-label">miles</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ log.duration_display }}</div>
                        <div class="stat-label">time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ log.pace_display }}</div>
                        <div class="stat-label">pace</div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-danger ms-3" onclick="deleteCardio({{ log.pk }})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            {% endfor %}
        {% else %}
        <div class="fitness-empty-state m-4">
            <div class="empty-icon">
                <i class="bi bi-bicycle"></i>
            </div>
            <div class="empty-title">No cardio logged</div>
            <div class="empty-text">Start tracking your runs, walks, and more</div>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#cardioModal">
                <i class="bi bi-plus-lg me-1"></i> Log Cardio
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Log Cardio Modal -->
<div class="modal fade fitness-modal" id="cardioModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-stopwatch me-2"></i>Log Cardio Activity
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Activity Type</label>
                    <select class="form-select" id="cardioActivity">
                        {% for value, label in activity_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Distance (miles)</label>
                    <input type="number" class="form-control" id="cardioDistance"
                           step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="mb-3">
                    <label class="form-label">Duration</label>
                    <div class="duration-input">
                        <input type="number" class="form-control" id="cardioMinutes"
                               placeholder="min" min="0">
                        <span class="duration-separator">:</span>
                        <input type="number" class="form-control" id="cardioSeconds"
                               placeholder="sec" min="0" max="59">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-control" id="cardioNotes" rows="2"
                              placeholder="How did it feel? Weather conditions?"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveCardio()">
                    <i class="bi bi-check-lg me-1"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock dashboard_content %}

{% block dashboard_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart data from server
const chartData = {{ distance_chart|safe }};
let cardioChart = null;

function initCardioChart() {
    const ctx = document.getElementById('cardioChart').getContext('2d');

    if (chartData.length === 0) {
        ctx.font = '14px system-ui';
        ctx.fillStyle = '#6b7280';
        ctx.textAlign = 'center';
        ctx.fillText('No cardio data yet', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
    }

    cardioChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.map(d => d.date),
            datasets: [{
                label: 'Distance (mi)',
                data: chartData.map(d => d.distance),
                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                borderColor: '#059669',
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'Pace (min/mi)',
                data: chartData.map(d => d.pace),
                type: 'line',
                borderColor: '#4f46e5',
                backgroundColor: 'transparent',
                tension: 0.3,
                pointRadius: 4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                x: { grid: { display: false } },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: { color: '#f3f4f6' },
                    title: { display: true, text: 'Distance (mi)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Pace (min/mi)' }
                }
            }
        }
    });

    // Activity breakdown
    updateActivityBreakdown();
}

function updateActivityBreakdown() {
    const activities = {};
    chartData.forEach(d => {
        // We'd need activity type in the data for proper breakdown
        // For now, show total
    });

    const breakdown = document.getElementById('activityBreakdown');
    const totalDistance = chartData.reduce((sum, d) => sum + d.distance, 0).toFixed(2);
    const workoutCount = chartData.length;

    breakdown.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Total Distance</span>
            <strong>${totalDistance} mi</strong>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Workouts</span>
            <strong>${workoutCount}</strong>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">Avg per workout</span>
            <strong>${workoutCount > 0 ? (totalDistance / workoutCount).toFixed(2) : 0} mi</strong>
        </div>
    `;
}

// Period selector
document.querySelectorAll('.chart-period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.chart-period-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        loadCardioData(this.dataset.days);
    });
});

function loadCardioData(days) {
    const activity = document.getElementById('activityFilter').value;
    fetch(`{% url 'wellness:api_cardio_chart' %}?days=${days}&activity=${activity}`)
        .then(response => response.json())
        .then(data => {
            if (cardioChart) {
                cardioChart.data.labels = data.data.map(d => d.date);
                cardioChart.data.datasets[0].data = data.data.map(d => d.distance);
                cardioChart.data.datasets[1].data = data.data.map(d => d.pace);
                cardioChart.update();
            }
        });
}

function filterActivity(activity) {
    const url = new URL(window.location.href);
    if (activity) {
        url.searchParams.set('activity', activity);
    } else {
        url.searchParams.delete('activity');
    }
    window.location.href = url.toString();
}

function filterDays(days) {
    const url = new URL(window.location.href);
    url.searchParams.set('days', days);
    window.location.href = url.toString();
}

function saveCardio() {
    const activity = document.getElementById('cardioActivity').value;
    const distance = document.getElementById('cardioDistance').value;
    const minutes = document.getElementById('cardioMinutes').value;
    const seconds = document.getElementById('cardioSeconds').value || 0;
    const notes = document.getElementById('cardioNotes').value;

    if (!distance || !minutes) {
        alert('Please enter distance and duration');
        return;
    }

    fetch('{% url "wellness:api_log_cardio" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            activity_type: activity,
            distance: parseFloat(distance),
            duration_minutes: parseInt(minutes),
            duration_seconds: parseInt(seconds),
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('cardioModal')).hide();
            location.reload();
        } else {
            alert(data.error || 'Error saving cardio');
        }
    });
}

function deleteCardio(id) {
    if (!confirm('Delete this cardio entry?')) return;

    fetch(`{% url 'wellness:api_delete_cardio_log' pk=0 %}`.replace('0', id), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initCardioChart();
});
</script>
{% endblock %}
