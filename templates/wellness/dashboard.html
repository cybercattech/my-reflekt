{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Wellness{% endblock %}

{% block dashboard_css %}
<link href="{% static 'css/pages/wellness.css' %}" rel="stylesheet">
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="bi bi-heart-pulse me-2"></i>Wellness</h1>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'wellness:pain_log' %}" class="quick-action-btn pain">
            <i class="bi bi-bandaid"></i> Log Pain
        </a>
        <a href="{% url 'wellness:fitness_dashboard' %}" class="quick-action-btn fitness">
            <i class="bi bi-heart-pulse"></i> Body Fitness
        </a>
        {% if enable_intimacy %}
        <button class="quick-action-btn intimacy" onclick="logIntimacy()">
            <span style="font-size: 1.1rem;">&#x1F340;</span> Log Moment
        </button>
        {% endif %}
        {% if enable_cycle %}
        <a href="{% url 'wellness:cycle' %}" class="quick-action-btn cycle">
            <i class="bi bi-calendar-heart"></i> Log Cycle
        </a>
        {% endif %}
    </div>

    <!-- Stats Cards -->
    <div class="wellness-stats">
        <!-- Pain Card -->
        <a href="{% url 'wellness:pain' %}" class="wellness-card pain">
            <i class="bi bi-bandaid card-icon"></i>
            <div class="card-title">Pain Tracking</div>
            <div class="card-stat">{{ pain_this_month }}</div>
            <div class="card-sub">
                episodes this month
                {% if avg_pain_intensity %}&#183; avg {{ avg_pain_intensity }}/10{% endif %}
            </div>
        </a>

        <!-- Fitness Card -->
        <a href="{% url 'wellness:fitness_dashboard' %}" class="wellness-card fitness">
            <i class="bi bi-heart-pulse card-icon"></i>
            <div class="card-title">Body Fitness</div>
            <div class="card-stat">
                {% if latest_metric and latest_metric.weight %}
                    {{ latest_metric.weight }}
                {% else %}
                    --
                {% endif %}
            </div>
            <div class="card-sub">
                {% if latest_metric %}{{ latest_metric.weight_unit }}{% else %}lbs{% endif %}
                {% if weight_change %}
                    &#183; {% if weight_change > 0 %}+{% endif %}{{ weight_change|floatformat:1 }} since last
                {% endif %}
            </div>
        </a>

        {% if enable_intimacy %}
        <!-- Intimacy Card -->
        <a href="{% url 'wellness:intimacy' %}" class="wellness-card intimacy">
            <span class="card-icon">&#x1F340;</span>
            <div class="card-title">Special Moments</div>
            <div class="card-stat">{{ intimacy_this_month }}</div>
            <div class="card-sub">
                this month
                {% if last_intimacy %}&#183; last {{ last_intimacy.logged_at|timesince }} ago{% endif %}
            </div>
        </a>
        {% endif %}

        {% if enable_cycle %}
        <!-- Cycle Card -->
        <a href="{% url 'wellness:cycle' %}" class="wellness-card cycle">
            <i class="bi bi-calendar-heart card-icon"></i>
            <div class="card-title">Cycle Tracking</div>
            <div class="card-stat">
                {% if cycle_prediction %}{{ cycle_prediction.avg_cycle_length }}{% else %}--{% endif %}
            </div>
            <div class="card-sub">
                {% if cycle_prediction %}
                    day avg cycle &#183; next {{ cycle_prediction.predicted_start|date:"M j" }}
                {% else %}
                    Start tracking to see predictions
                {% endif %}
            </div>
        </a>
        {% endif %}
    </div>

    <div class="row">
        <!-- Recent Activity -->
        <div class="col-lg-8">
            <div class="activity-list">
                <div class="list-header">
                    <i class="bi bi-clock-history me-2"></i>Recent Activity
                </div>
                {% if recent_pain %}
                    {% for pain in recent_pain %}
                    <div class="activity-item">
                        <div class="activity-icon pain">
                            <i class="{{ pain.icon }}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">
                                {{ pain.location_display }} pain ({{ pain.intensity }}/10)
                            </div>
                            <div class="activity-time">{{ pain.logged_at|timesince }} ago</div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="wellness-empty-state">
                        <div class="empty-icon">
                            <i class="bi bi-heart-pulse"></i>
                        </div>
                        <p>No recent wellness logs</p>
                        <p class="small text-muted">Start tracking to see your activity here</p>
                    </div>
                {% endif %}
            </div>

            <!-- Fitness Goals Preview -->
            {% if active_fitness_goals %}
            <div class="fitness-goals-preview">
                <div class="preview-header">
                    <span><i class="bi bi-flag me-2"></i>Active Fitness Goals</span>
                    <a href="{% url 'wellness:fitness_goals' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                {% for goal in active_fitness_goals %}
                <div class="fitness-goal-mini">
                    <div class="goal-name">
                        {{ goal.title }}
                        {% if goal.is_cardio_combo %}
                            <span class="text-muted small">- {{ goal.target_distance }} mi in {{ goal.target_time_display }}</span>
                        {% endif %}
                    </div>
                    <div class="goal-progress">
                        <div class="progress-bar-mini">
                            <div class="progress-fill {{ goal.on_track_status|default:'unknown' }}"
                                 style="width: {{ goal.progress_percentage }}%"></div>
                        </div>
                        <span class="progress-text">{{ goal.progress_percentage|floatformat:0 }}%</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Cardio Summary -->
            <div class="insights-card mb-3">
                <h6><i class="bi bi-activity me-2"></i>Cardio This Month</h6>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="h3 mb-0">{{ total_distance }}</div>
                        <small class="text-muted">miles total</small>
                    </div>
                    <div class="text-end">
                        <div class="h3 mb-0">{{ cardio_count }}</div>
                        <small class="text-muted">workouts</small>
                    </div>
                </div>
            </div>

            <!-- Insights -->
            <div class="insights-card">
                <h6><i class="bi bi-lightbulb me-2"></i>Insights</h6>
                <p class="text-muted small">
                    Track your wellness data regularly to discover patterns and correlations
                    between pain, mood, fitness, and other factors.
                </p>
                <hr>
                <p class="small mb-0">
                    <i class="bi bi-shield-lock me-2 text-success"></i>
                    Your wellness data is private and encrypted.
                </p>
            </div>
        </div>
    </div>
</div>

{% if enable_intimacy %}
<!-- Intimacy Quick Log Modal -->
<div class="modal fade" id="intimacyModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px;">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white;">
                <h5 class="modal-title"><span style="font-size: 1.25rem;">&#x1F340;</span> Log Moment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Rating (optional)</label>
                    <div class="d-flex gap-2" id="intimacyRating">
                        {% for i in "12345" %}
                        <button type="button" class="btn btn-outline-success rating-btn" data-rating="{{ i }}">
                            {{ i }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-control" id="intimacyNotes" rows="2" placeholder="Private notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-success w-100" onclick="saveIntimacy()">
                    <i class="bi bi-check-lg me-1"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock dashboard_content %}

{% block dashboard_js %}
{% if enable_intimacy %}
<script>
let selectedIntimacyRating = null;

function logIntimacy() {
    selectedIntimacyRating = null;
    document.querySelectorAll('#intimacyRating .rating-btn').forEach(btn => {
        btn.classList.remove('active', 'btn-success');
        btn.classList.add('btn-outline-success');
    });
    document.getElementById('intimacyNotes').value = '';
    new bootstrap.Modal(document.getElementById('intimacyModal')).show();
}

document.querySelectorAll('#intimacyRating .rating-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('#intimacyRating .rating-btn').forEach(b => {
            b.classList.remove('active', 'btn-success');
            b.classList.add('btn-outline-success');
        });
        this.classList.remove('btn-outline-success');
        this.classList.add('active', 'btn-success');
        selectedIntimacyRating = parseInt(this.dataset.rating);
    });
});

function saveIntimacy() {
    const notes = document.getElementById('intimacyNotes').value;

    fetch('{% url "wellness:api_intimacy_log" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            rating: selectedIntimacyRating,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('intimacyModal')).hide();
            location.reload();
        } else {
            alert(data.error || 'Error saving');
        }
    });
}
</script>
{% endif %}
{% endblock %}
